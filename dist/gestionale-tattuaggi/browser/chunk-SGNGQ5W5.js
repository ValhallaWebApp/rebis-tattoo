import{a as re}from"./chunk-JM6OLBMJ.js";import{a as ie}from"./chunk-FXPXM24L.js";import"./chunk-RWUD3VOV.js";import{Da as ee,Ea as te,Fa as ne,Q as k,U as w,b as $,f as Y,h as Z,ib as D}from"./chunk-6RZNEBAJ.js";import{B as U,Bb as d,Bc as L,C as N,Ca as E,Da as I,Ec as K,Gb as m,La as j,Pb as s,Qb as o,Rb as g,Sb as W,Tb as G,Vb as O,Yb as y,_b as l,e as u,id as C,ja as q,jb as a,jc as z,kb as f,lc as p,mc as H,nc as _,oa as J,qd as Q,rd as X,ta as b,td as x,uc as P,zc as A}from"./chunk-JF75SBGN.js";var se="clover",ge=function(e){return e===3?"v3":e},pe="https://js.stripe.com",ye="".concat(pe,"/").concat(se,"/stripe.js"),_e=/^https:\/\/js\.stripe\.com\/v3\/?(\?.*)?$/,Se=/^https:\/\/js\.stripe\.com\/(v3|[a-z]+)\/stripe\.js(\?.*)?$/,oe="loadStripe.setLoadParameters was called but an existing Stripe.js script already exists in the document; existing script parameters will be used",ve=function(e){return _e.test(e)||Se.test(e)},he=function(){for(var e=document.querySelectorAll('script[src^="'.concat(pe,'"]')),t=0;t<e.length;t++){var i=e[t];if(ve(i.src))return i}return null},ae=function(e){var t=e&&!e.advancedFraudSignals?"?advancedFraudSignals=false":"",i=document.createElement("script");i.src="".concat(ye).concat(t);var r=document.head||document.body;if(!r)throw new Error("Expected document.body not to be null. Stripe.js requires a <body> element.");return r.appendChild(i),i},be=function(e,t){!e||!e._registerWrapper||e._registerWrapper({name:"stripe-js",version:"8.4.0",startTime:t})},S=null,T=null,M=null,Ee=function(e){return function(t){e(new Error("Failed to load Stripe.js",{cause:t}))}},Ie=function(e,t){return function(){window.Stripe?e(window.Stripe):t(new Error("Stripe.js not available"))}},Pe=function(e){return S!==null?S:(S=new Promise(function(t,i){if(typeof window>"u"||typeof document>"u"){t(null);return}if(window.Stripe&&e&&console.warn(oe),window.Stripe){t(window.Stripe);return}try{var r=he();if(r&&e)console.warn(oe);else if(!r)r=ae(e);else if(r&&M!==null&&T!==null){var c;r.removeEventListener("load",M),r.removeEventListener("error",T),(c=r.parentNode)===null||c===void 0||c.removeChild(r),r=ae(e)}M=Ie(t,i),T=Ee(i),r.addEventListener("load",M),r.addEventListener("error",T)}catch(h){i(h);return}}),S.catch(function(t){return S=null,Promise.reject(t)}))},Ce=function(e,t,i){if(e===null)return null;var r=t[0],c=r.match(/^pk_test/),h=ge(e.version),V=se;c&&h!==V&&console.warn("Stripe.js@".concat(h," was loaded on the page, but @stripe/stripe-js@").concat("8.4.0"," expected Stripe.js@").concat(V,". This may result in unexpected behavior. For more information, see https://docs.stripe.com/sdks/stripejs-versioning"));var F=e.apply(void 0,t);return be(F,i),F},v,me=!1,ce=function(){return v||(v=Pe(null).catch(function(e){return v=null,Promise.reject(e)}),v)};Promise.resolve().then(function(){return ce()}).catch(function(n){me||console.warn(n)});var le=function(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];me=!0;var r=Date.now();return ce().then(function(c){return Ce(c,t,r)})};function Te(n,e){n&1&&g(0,"mat-progress-spinner",4)}function Me(n,e){n&1&&(s(0,"span"),p(1,"Paga ora"),o())}var B=class n{publishableKey;clientSecret;paymentSuccess=new j;paymentError=new j;stripePromise;elements;paymentElement;paying=!1;elementReady=!1;ngOnInit(){if(!this.publishableKey||!this.clientSecret){console.error("StripePaymentComponent: publishableKey o clientSecret mancanti"),this.paymentError.emit("Configurazione Stripe non valida.");return}this.stripePromise=le(this.publishableKey),this.initStripe()}initStripe(){return u(this,null,function*(){try{let e=yield this.stripePromise;if(!e){console.error("Stripe non inizializzato"),this.paymentError.emit("Stripe non disponibile.");return}console.log("Inizializzo Elements con clientSecret:",this.clientSecret),this.elements=e.elements({clientSecret:this.clientSecret}),this.paymentElement=this.elements.create("payment"),this.paymentElement.on("ready",()=>{console.log("Payment Element ready"),this.elementReady=!0}),this.paymentElement.on("loaderror",t=>{console.error("Payment Element loaderror",t),this.paymentError.emit("Errore nel caricamento del modulo di pagamento Stripe.")}),this.paymentElement.mount("#payment-element")}catch(e){console.error("Errore initStripe:",e),this.paymentError.emit(e?.message||"Errore Stripe.")}})}ngOnDestroy(){this.paymentElement?.unmount()}pay(){return u(this,null,function*(){if(!this.elements||!this.stripePromise){this.paymentError.emit("Stripe non inizializzato correttamente.");return}if(!this.elementReady){this.paymentError.emit("Il modulo di pagamento non \xE8 pronto. Riprova tra qualche secondo.");return}this.paying=!0;let e=yield this.stripePromise;if(!e){this.paymentError.emit("Stripe non disponibile."),this.paying=!1;return}let{error:t}=yield this.elements.submit();if(t){console.error("Errore elements.submit():",t),this.paymentError.emit(t.message||"Errore nella validazione del pagamento."),this.paying=!1;return}let{error:i}=yield e.confirmPayment({elements:this.elements,clientSecret:this.clientSecret,redirect:"if_required"});this.paying=!1,i?(console.error("Errore confirmPayment:",i),this.paymentError.emit(i.message||"Pagamento fallito.")):this.paymentSuccess.emit()})}static \u0275fac=function(t){return new(t||n)};static \u0275cmp=b({type:n,selectors:[["app-stripe-payment"]],inputs:{publishableKey:"publishableKey",clientSecret:"clientSecret"},outputs:{paymentSuccess:"paymentSuccess",paymentError:"paymentError"},standalone:!0,features:[P],decls:4,vars:3,consts:[["id","payment-element",1,"payment-element"],["mat-raised-button","","color","primary",3,"click","disabled"],["diameter","18","mode","indeterminate",4,"ngIf"],[4,"ngIf"],["diameter","18","mode","indeterminate"]],template:function(t,i){t&1&&(g(0,"div",0),s(1,"button",1),y("click",function(){return i.pay()}),d(2,Te,1,0,"mat-progress-spinner",2)(3,Me,2,0,"span",3),o()),t&2&&(a(),m("disabled",i.paying),a(),m("ngIf",i.paying),a(),m("ngIf",!i.paying))},dependencies:[x,C,D,w,k],styles:[".payment-element[_ngcontent-%COMP%]{margin:1.5rem 0}button[_ngcontent-%COMP%]{width:100%}"]})};var ue={production:!1,firebaseConfig:{apiKey:"AIzaSyDFOFTJ9p60YeoVdLGo8ZfuaOOaUpgAP5E",authDomain:"rebis-tattoo-55816.firebaseapp.com",databaseURL:"https://rebis-tattoo-55816-default-rtdb.europe-west1.firebasedatabase.app/",projectId:"rebis-tattoo-55816",storageBucket:"rebis-tattoo-55816.firebasestorage.app",messagingSenderId:"70352364616",appId:"1:70352364616:web:24a6df01d24f6b4947647d",measurementId:"G-1HW9SPJ1CN"},stripePublishableKey:"pk_test_51QNHjmHTS8uBqIoqBo51zWatjkDbUcP3SECoQb1Y859MfKtk6WbIfNRvpDJfdBUJP58OOPDPaQibnTjRbd6vgdWx00Mh7pSPeZ"};var R=class n{constructor(e){this.http=e}baseUrl="http://localhost:3000/api/payments";createPaymentIntent(e){return this.http.post(`${this.baseUrl}/create`,e).pipe(N(t=>({clientSecret:t.clientSecret,paymentIntentId:t.paymentIntentId})))}static \u0275fac=function(t){return new(t||n)(J($))};static \u0275prov=q({token:n,factory:n.\u0275fac,providedIn:"root"})};function Re(n,e){n&1&&g(0,"mat-progress-spinner",12)}function je(n,e){n&1&&(s(0,"span"),p(1,"Procedi al pagamento"),o())}function Oe(n,e){if(n&1){let t=O();s(0,"button",9),y("click",function(){E(t);let r=l(3);return I(r.startPayment())}),d(1,Re,1,0,"mat-progress-spinner",10)(2,je,2,0,"span",11),o()}if(n&2){let t=l(3);m("disabled",t.creatingPayment),a(),m("ngIf",t.creatingPayment),a(),m("ngIf",!t.creatingPayment)}}function ze(n,e){if(n&1){let t=O();s(0,"app-stripe-payment",13),y("paymentSuccess",function(){E(t);let r=l(3);return I(r.onPaymentSuccess())})("paymentError",function(r){E(t);let c=l(3);return I(c.onPaymentError(r))}),o()}if(n&2){let t=l(3);m("publishableKey",t.publishableKey)("clientSecret",t.clientSecret)}}function Ae(n,e){if(n&1&&(s(0,"p",14),p(1),o()),n&2){let t=l(3);a(),H(t.error)}}function Le(n,e){if(n&1&&(s(0,"mat-card",4)(1,"mat-card-title"),p(2," Dettaglio prenotazione "),o(),s(3,"mat-card-content")(4,"p")(5,"strong"),p(6,"Descrizione:"),o(),p(7),o(),s(8,"p")(9,"strong"),p(10,"Data:"),o(),p(11),A(12,"date"),o(),s(13,"p")(14,"strong"),p(15,"Prezzo:"),o(),p(16),A(17,"currency"),o(),s(18,"p")(19,"strong"),p(20,"Stato:"),o(),p(21),o(),s(22,"div",5),d(23,Oe,3,3,"button",6)(24,ze,1,2,"app-stripe-payment",7),o(),d(25,Ae,2,1,"p",8),o()()),n&2){let t=l(2);a(7),_(" ",t.booking.description,""),a(4),_(" ",L(12,7,t.booking.start,"short"),""),a(5),_(" ",L(17,10,t.booking.price,"EUR"),""),a(5),_(" ",t.booking.status,""),a(2),m("ngIf",!t.clientSecret),a(),m("ngIf",t.clientSecret),a(),m("ngIf",t.error)}}function Ke(n,e){if(n&1&&(W(0),d(1,Le,26,13,"mat-card",3),G()),n&2){let t=l(),i=z(4);a(),m("ngIf",t.booking)("ngIfElse",i)}}function Ve(n,e){n&1&&(s(0,"div",15),g(1,"mat-progress-spinner",16),o())}function Fe(n,e){n&1&&(s(0,"p"),p(1,"Prenotazione non trovata."),o())}var fe=class n{constructor(e,t,i,r,c){this.route=e;this.router=t;this.bookingService=i;this.invoicesService=r;this.paymentsApi=c}booking;loading=!0;error;publishableKey=ue.stripePublishableKey;clientSecret;creatingPayment=!1;paymentStarted=!1;ngOnInit(){return u(this,null,function*(){try{let e=this.route.snapshot.paramMap.get("id");if(!e){this.error="ID prenotazione mancante";return}let t=yield this.bookingService.getBookingById(e);if(!t){this.error="Prenotazione non trovata";return}this.booking=t,this.loading=!1}catch(e){this.error=e.message||"Errore nel caricamento della prenotazione"}})}startPayment(){return u(this,null,function*(){if(!(!this.booking||this.creatingPayment||this.clientSecret)){this.creatingPayment=!0,this.error=void 0;try{let e=(this.booking.price||0)*100,t=yield U(this.paymentsApi.createPaymentIntent({amount:e,currency:"eur",description:`Acconto consulenza #${this.booking.id}`}));this.clientSecret=t.clientSecret,this.paymentStarted=!0}catch(e){console.error(e),this.error=e.message||"Errore nella creazione del pagamento"}finally{this.creatingPayment=!1}}})}onPaymentSuccess(){return u(this,null,function*(){if(!this.booking)return;let e=this.booking;yield this.bookingService.safeSetStatus(e.id,"paid",{paidAmount:e.price});let t=new Date().toISOString(),i={bookingId:e.id,clientId:e.idClient,clientName:"Cliente",date:t,amount:e.price,status:"paid",items:[{description:e.description,quantity:1,price:e.price}],notes:e.description,createdAt:t,updatedAt:t};yield this.invoicesService.addInvoice(i),this.router.navigate(["/features/clients"])})}onPaymentError(e){this.error=e}static \u0275fac=function(t){return new(t||n)(f(Y),f(Z),f(ie),f(re),f(R))};static \u0275cmp=b({type:n,selectors:[["app-booking-detail"]],standalone:!0,features:[P],decls:5,vars:2,consts:[["loadingTpl",""],["notFoundTpl",""],[4,"ngIf","ngIfElse"],["class","booking-detail-card",4,"ngIf","ngIfElse"],[1,"booking-detail-card"],[1,"payment-section"],["mat-raised-button","","color","primary",3,"disabled","click",4,"ngIf"],[3,"publishableKey","clientSecret","paymentSuccess","paymentError",4,"ngIf"],["class","error",4,"ngIf"],["mat-raised-button","","color","primary",3,"click","disabled"],["diameter","18","mode","indeterminate",4,"ngIf"],[4,"ngIf"],["diameter","18","mode","indeterminate"],[3,"paymentSuccess","paymentError","publishableKey","clientSecret"],[1,"error"],[1,"loading"],["mode","indeterminate"]],template:function(t,i){if(t&1&&d(0,Ke,2,2,"ng-container",2)(1,Ve,2,0,"ng-template",null,0,K)(3,Fe,2,0,"ng-template",null,1,K),t&2){let r=z(2);m("ngIf",!i.loading)("ngIfElse",r)}},dependencies:[x,C,X,Q,D,w,ee,ne,te,k,B],styles:[".booking-detail-card[_ngcontent-%COMP%]{max-width:600px;margin:2rem auto}.payment-section[_ngcontent-%COMP%]{margin-top:2rem}.error[_ngcontent-%COMP%]{margin-top:1rem;color:#f44336}.loading[_ngcontent-%COMP%]{display:flex;justify-content:center;margin-top:4rem}"]})};export{fe as BookingDetailComponent};
