import{A as b,B as v,D as y,E as I,F as A,G as T,H as a,I as w,J as O,L as x,cc as $,x as m}from"./chunk-7AONPZHV.js";import{F as f,c as j,i as u}from"./chunk-I2SBXG73.js";import{X as P,k as h}from"./chunk-Y3XNR5LB.js";import{a as c,b as p,e as o}from"./chunk-ACKELEN3.js";var k=class l{path="projects";db=u(m);zone=u(f);ui=u($);getProjects(t={}){let e=a(this.db,this.path);return new h(s=>{let i=y(e,r=>{this.zone.run(()=>{let n=r.exists()?Object.entries(r.val()).map(([d,g])=>c({id:d},g)):[];s.next(n)})},r=>this.zone.run(()=>s.error(r)),{onlyOnce:!!t.onlyOnce});return()=>i()})}getProjectsLiteOnce(){return this.getProjects({onlyOnce:!0}).pipe(P(t=>(t??[]).filter(e=>!!e.id).map(e=>({id:String(e.id),title:e.title,clientId:e.clientId,artistId:e.artistId,sessionIds:Array.isArray(e.sessionIds)?e.sessionIds:[]}))))}getProjectById(t){return o(this,null,function*(){let e=yield v(a(this.db,`${this.path}/${t}`));return e.exists()?c({id:t},e.val()):null})}getProjectsByClient(t){let e=T(a(this.db,this.path),I("clientId"),b(t));return new h(s=>{let i=y(e,r=>{this.zone.run(()=>{let n=r.exists()?Object.entries(r.val()).map(([d,g])=>c({id:d},g)):[];s.next(n)})},r=>this.zone.run(()=>s.error(r)));return()=>i()})}createProject(t){return o(this,null,function*(){let e=A(a(this.db,this.path)),s=this.formatLocal(new Date),i=p(c({},t),{id:e.key,createdAt:t.createdAt??s,updatedAt:t.updatedAt??s,status:t.status??"draft",sessionIds:Array.isArray(t.sessionIds)?t.sessionIds:[]});return yield O(e,this.stripUndef(i)),this.toast("Progetto creato"),e.key})}updateProject(t,e){return o(this,null,function*(){let s=this.stripUndef(p(c({},e),{updatedAt:this.formatLocal(new Date)}));yield x(a(this.db,`${this.path}/${t}`),s),this.toast("Progetto aggiornato")})}deleteProject(t){return o(this,null,function*(){yield w(a(this.db,`${this.path}/${t}`)),this.toast("Progetto eliminato")})}attachBooking(t,e){return o(this,null,function*(){yield this.updateProject(t,{bookingId:e,status:"scheduled"})})}addSession(t,e){return o(this,null,function*(){let s=yield this.getProjectById(t);if(!s)return;let i=Array.isArray(s.sessionIds)?s.sessionIds:[];if(i.includes(e))return;let r=[...i,e],n=s.status==="draft"||s.status==="healing"?"active":s.status;yield this.updateProject(t,{sessionIds:r,status:n})})}toast(t,e=!1){if(e){this.ui.error(t);return}this.ui.success(t)}stripUndef(t){let e={};for(let s of Object.keys(t))t[s]!==void 0&&(e[s]=t[s]);return e}pad(t){return String(t).padStart(2,"0")}formatLocal(t){let e=t.getFullYear(),s=this.pad(t.getMonth()+1),i=this.pad(t.getDate()),r=this.pad(t.getHours()),n=this.pad(t.getMinutes()),d=this.pad(t.getSeconds());return`${e}-${s}-${i}T${r}:${n}:${d}`}static \u0275fac=function(e){return new(e||l)};static \u0275prov=j({token:l,factory:l.\u0275fac,providedIn:"root"})};export{k as a};
