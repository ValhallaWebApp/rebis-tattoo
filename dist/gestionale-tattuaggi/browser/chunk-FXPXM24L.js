import{G as C,I as O,J as p,K as y,M as B,N as k,O as $,P as v,Q as r,R as T,S as x,T as A,U as P}from"./chunk-RWUD3VOV.js";import{Tc as w,a as c,b as m,e as l,h,ja as b,oa as S,ub as D}from"./chunk-JF75SBGN.js";var I=class g{_draft=D(null);draftSig=this._draft.asReadonly();hasDraftSig=w(()=>this._draft()!==null);stripUndef(t){let o={};for(let e of Object.keys(t))t[e]!==void 0&&(o[e]=t[e]);return o}setDraft(t,o={}){let e=this.stripUndef(t),n=this._draft(),i=o.merge&&n?c(c({},n),e):e;console.log("[BookingDraftService] setDraft \u2192",{prev:n,incoming:e,merge:!!o.merge,next:i}),this._draft.set(i)}patchDraft(t){let o=this._draft(),e=c(c({},o||{}),this.stripUndef(t));console.log("[BookingDraftService] patchDraft \u2192",{prev:o,patch:t,next:e}),this._draft.set(e)}consume(){let t=this._draft();return this._draft.set(null),console.log("[BookingDraftService] consume \u2192",t),t}reset(){console.log("[BookingDraftService] reset"),this._draft.set(null)}static \u0275fac=function(o){return new(o||g)};static \u0275prov=b({token:g,factory:g.\u0275fac,providedIn:"root"})},R=class g{constructor(t){this.db=t}path="bookings";getFreeSlotsInDay(t,o,e=60){return l(this,null,function*(){let s=[],a=yield this.getBookingsByArtistAndDate(t,o),d=new Set(a.map(u=>u.time));for(let u=9;u<=18-e/60;u++){let f=`${u.toString().padStart(2,"0")}:00`;d.has(f)||s.push({time:f})}return s})}getBookingsByArtistAndDate(t,o){return l(this,null,function*(){let e=v(r(this.db,"bookings"),k("idArtist"),p(t)),n=yield y(e);return(n.exists()?Object.values(n.val()):[]).filter(s=>s.date===o&&s.idArtist===t)})}getAllBookings(){return console.log("[BookingService] getAllBookings \u2192 subscribe"),new h(t=>B(r(this.db,this.path),o=>{let e=o.val()?Object.values(o.val()):[];console.log("[BookingService] getAllBookings \u2190 next",{count:e.length}),t.next(e)}))}getBookingsByClient(t){return console.log("[BookingService] getBookingsByClient \u2192 subscribe",{uid:t}),new h(o=>{let e=v(r(this.db,this.path),k("idClient"),p(t));return B(e,n=>{let i=n.val()?Object.values(n.val()):[];console.log("[BookingService] getBookingsByClient \u2190 next",{uid:t,count:i.length}),o.next(i)})})}getBookingsByDate(t){let o=typeof t=="string"?t.slice(0,10):t.toISOString().slice(0,10),e=`${o}T00:00:00`,n=`${o}T23:59:59\uF8FF`;console.log("[BookingService] getBookingsByDate \u2192 subscribe",{dateStr:o,startKey:e,endKey:n});let i=v(r(this.db,this.path),k("start"),A(e),O(n));return new h(s=>B(i,a=>{let d=a.val()?Object.values(a.val()).sort((u,f)=>u.start.localeCompare(f.start)):[];console.log("[BookingService] getBookingsByDate \u2190 next",{dateStr:o,count:d.length}),s.next(d)}))}addDraft(t){return l(this,null,function*(){let o=$(r(this.db,this.path)),e=m(c({},t),{id:o.key,status:"draft"});return console.log("[BookingService] addDraft \u2192",e),yield x(o,e),console.log("[BookingService] addDraft \u2190 id",o.key),o.key})}updateBooking(t,o){return console.log("[BookingService] updateBooking \u2192",{id:t,changes:o}),P(r(this.db,`${this.path}/${t}`),o)}setStatus(t,o,e={}){return console.log("[BookingService] setStatus \u2192",{id:t,status:o,extra:e}),this.updateBooking(t,c({status:o},e))}deleteBooking(t){return console.log("[BookingService] deleteBooking \u2192",{id:t}),T(r(this.db,`${this.path}/${t}`))}getBookingById(t){return l(this,null,function*(){console.log("[BookingService] getBookingById \u2192",{id:t});let o=yield y(r(this.db,`${this.path}/${t}`)),e=o.exists()?o.val():null;return console.log("[BookingService] getBookingById \u2190",e),e})}watchBooking(t){return console.log("[BookingService] watchBooking \u2192 subscribe",{id:t}),new h(o=>{let e=r(this.db,`${this.path}/${t}`);return B(e,n=>{let i=n.exists()?n.val():null;console.log("[BookingService] watchBooking \u2190 next",i),o.next(i)})})}getBookingsByDay(t){return console.log("[BookingService] getBookingsByDay \u2192 subscribe",{dateIso:t}),new h(o=>{let e=v(r(this.db,this.path),k("start"),p(t));return B(e,n=>{let i=n.val()?Object.values(n.val()):[];console.log("[BookingService] getBookingsByDay \u2190 next",{dateIso:t,count:i.length}),o.next(i)})})}getTotalRevenueThisMonth(){let[t,o]=new Date().toISOString().split("-");return console.log("[BookingService] getTotalRevenueThisMonth \u2192 subscribe",{year:t,month:o}),new h(e=>{B(r(this.db,this.path),n=>{let i=n.val()?Object.values(n.val()).filter(s=>s.status==="paid"&&s.start.startsWith(`${t}-${o}`)).reduce((s,a)=>s+(a.price||0),0):0;console.log("[BookingService] getTotalRevenueThisMonth \u2190 next",{year:t,month:o,total:i}),e.next(i)})})}notify(t,o){console.log(`[NOTIFY] Evento: ${t} - Booking ID: ${o.id}`)}rescheduleBooking(t,o,e,n){return l(this,null,function*(){try{console.log("[BookingService] rescheduleBooking \u2192",{id:t,newStart:o,newEnd:e,updater:n});let i=yield this.getBookingById(t);if(!i)throw new Error("Prenotazione non trovata");if(["completed","cancelled"].includes(i.status))throw new Error("Non puoi modificare una prenotazione completata o annullata.");yield this.updateBooking(t,{start:o,end:e,updateAt:new Date().toISOString(),lastRescheduledAt:new Date().toISOString(),rescheduleCount:(i.rescheduleCount||0)+1}),this.notify("rescheduled",m(c({},i),{start:o,end:e})),console.log("[BookingService] rescheduleBooking \u2190 OK")}catch(i){throw console.error("[BookingService] rescheduleBooking ERROR \u2192",i),i}})}isValidTransition(t,o){return{draft:["paid","cancelled"],paid:["on-going","cancelled"],"on-going":["completed","cancelled"],completed:[],cancelled:[]}[t]?.includes(o)??!1}safeSetStatus(n,i){return l(this,arguments,function*(t,o,e={}){try{console.log("[BookingService] safeSetStatus \u2192",{id:t,newStatus:o,extra:e});let s=yield this.getBookingById(t);if(!s)throw new Error("Prenotazione non trovata");if(!this.isValidTransition(s.status,o))throw new Error(`Transizione non valida da ${s.status} a ${o}`);yield this.setStatus(t,o,e),this.notify(o,c(c({},s),e)),console.log("[BookingService] safeSetStatus \u2190 OK")}catch(s){throw console.error("[BookingService] safeSetStatus ERROR \u2192",s),s}})}stripUndef(t){let o={};return Object.keys(t).forEach(e=>t[e]!==void 0&&(o[e]=t[e])),o}pad(t){return String(t).padStart(2,"0")}formatLocal(t){let o=t.getFullYear(),e=this.pad(t.getMonth()+1),n=this.pad(t.getDate()),i=this.pad(t.getHours()),s=this.pad(t.getMinutes()),a=this.pad(t.getSeconds());return`${o}-${e}-${n}T${i}:${s}:${a}`}addMinutesLocal(t,o){let e=new Date(t);return e.setMinutes(e.getMinutes()+o),this.formatLocal(e)}buildDraftPayloadFromChat(t,o){console.log("[BookingService] buildDraftPayloadFromChat \u2192 in",{draft:t,params:o});let{idClient:e,clientName:n}=o;if(!t.date||!t.time)throw console.warn("[BookingService] buildDraftPayloadFromChat \u2192 missing date/time"),new Error('Draft incompleto: servono "date" e "time" per creare la bozza.');let i=`${t.date}T${t.time}:00`,s=t.duration&&t.duration>0?t.duration:30,a=this.addMinutesLocal(i,s),d=this.stripUndef({title:`${n||"Cliente"} - Tattoo`,start:i,end:a,idClient:e,description:t.note||"",idArtist:t.artistId||"",createAt:this.formatLocal(new Date),updateAt:this.formatLocal(new Date),price:0,paidAmount:0});return console.log("[BookingService] buildDraftPayloadFromChat \u2192 out",d),d}addDraftFromChat(t,o){return l(this,null,function*(){let e=this.buildDraftPayloadFromChat(t,o);console.log("[BookingService] addDraftFromChat \u2192 calling addDraft",e);let n=yield this.addDraft(e);return console.log("[BookingService] addDraftFromChat \u2190 new draft id",n),n})}static \u0275fac=function(o){return new(o||g)(S(C))};static \u0275prov=b({token:g,factory:g.\u0275fac,providedIn:"root"})};export{R as a};
