import{b as q,c as T}from"./chunk-ALIQDRXJ.js";import{B as k,D as O,F as B,H as u,I as K,J as L,L as Q,dc as N,j as E,l as D,m as M,n as w,o as S,p as A,q as F,s as C,t as p,u as P,v as x,w as V,x as I}from"./chunk-VVGPL6SB.js";import{c as R,h as j,i as b}from"./chunk-I2SBXG73.js";import{$ as y,N as f,X as c,k as U,ta as v}from"./chunk-Y3XNR5LB.js";import{a as d,b as l,c as $,e as g}from"./chunk-ACKELEN3.js";var G=class m{constructor(t){this.db=t}path="services";addService(t){let e=Date.now(),r=B(u(this.db,this.path)),i=l(d({id:r.key,createdAt:e,updatedAt:e,creatoreId:"admin"},t),{visibile:t.visibile??!1});return L(r,i)}deleteService(t){return K(u(this.db,`${this.path}/${t}`))}updateService(t,e){return Q(u(this.db,`${this.path}/${t}`),l(d({},e),{updatedAt:Date.now()}))}getServices(){return new U(t=>{let e=u(this.db,this.path),r=O(e,i=>{let n=i.val(),s=n?Object.keys(n).map(a=>l(d({id:a},n[a]),{visibile:n[a].visibile===!0||n[a].visibile==="true"})):[];s.sort((a,o)=>o.createdAt-a.createdAt),t.next(s)},i=>t.error(i));return()=>r()})}getServiceById(t){return g(this,null,function*(){let e=yield k(u(this.db,`${this.path}/${t}`));if(!e.exists())return null;let r=e.val();return l(d({id:t},r),{visibile:r.visibile===!0||r.visibile==="true"})})}static \u0275fac=function(e){return new(e||m)(j(I))};static \u0275prov=R({token:m,factory:m.\u0275fac,providedIn:"root"})};var H=class m{db=b(I);firestore=b(E);auth=b(T);ui=b(N);audit=b(q);constructor(){}normalizeUser(t){let e=t??{},r=String(e.id??e.uid??"").trim(),s=e,{uid:i}=s,n=$(s,["uid"]);return l(d({},n),{id:r,name:String(e.name??""),email:String(e.email??""),role:String(e.role??"guest"),permissions:{canManageRoles:e.permissions?.canManageRoles===!0},phone:e.phone?String(e.phone):void 0,isActive:e.isActive!==void 0?!!e.isActive:void 0,isVisible:e.isVisible!==void 0?!!e.isVisible:void 0,deletedAt:e.deletedAt??void 0,createdAt:e.createdAt??null,updatedAt:e.updatedAt??null,urlAvatar:e.urlAvatar??e.avatar??null})}normalizeUsers(t){return(t??[]).map(e=>this.normalizeUser(e))}streamRtdbUsers(){return new U(t=>{let e=u(this.db,"users"),r=O(e,i=>{if(!i.exists()){t.next([]);return}let n=i.val(),s=Object.entries(n).map(([a,o])=>this.normalizeUser(d({id:a},o)));t.next(s)},i=>t.error(i));return()=>r()}).pipe(v(()=>f([])))}mergeUsers(t,e){let r=new Map;for(let i of e??[])i?.id&&r.set(i.id,i);for(let i of t??[]){if(!i?.id)continue;let n=r.get(i.id);r.set(i.id,l(d(d({},n??{}),i),{id:i.id}))}return Array.from(r.values())}toFirestorePatch(t){let e=d({},t);return delete e.id,delete e.uid,delete e.createdAt,e}getCurrentUserId(){return this.auth.userSig()?.uid||null}getCurrentUserRole(){return this.auth.userSig()?.role||"guest"}isCurrentUserAdmin(){return this.getCurrentUserRole()==="admin"}canCurrentUserManageRoles(){let t=this.auth.userSig();return t?t.role==="admin"?!0:t.permissions?.canManageRoles===!0:!1}assertAdminAction(){if(!this.isCurrentUserAdmin())throw new Error("Azione consentita solo ad admin")}assertCanManageRolesAction(){if(!this.canCurrentUserManageRoles())throw new Error("Azione consentita solo ad admin o staff abilitato")}getClients(){let t=this.getCurrentUserId();if(this.getCurrentUserRole()==="admin"){let r=w(this.firestore,"users"),i=C(r,V("role","==","client")),n=D(i,{idField:"id"}).pipe(c(a=>this.normalizeUsers(a)),v(()=>f([]))),s=this.streamRtdbUsers().pipe(c(a=>a.filter(o=>o.role==="client")));return y([n,s]).pipe(c(([a,o])=>this.mergeUsers(a,o)),c(a=>a.filter(o=>o.isVisible!==!1&&!o.deletedAt)))}else if(t){let r=S(this.firestore,"users",t),i=M(r,{idField:"id"}).pipe(c(s=>s?[this.normalizeUser(s)]:[]),v(()=>f([]))),n=this.streamRtdbUsers().pipe(c(s=>s.filter(a=>a.id===t)));return y([i,n]).pipe(c(([s,a])=>this.mergeUsers(s,a)))}else return f([])}getManageableUsers(){if(!this.canCurrentUserManageRoles())return f([]);let t=w(this.firestore,"users"),e=C(t,V("role","in",["user","client","staff","admin"])),r=D(e,{idField:"id"}).pipe(c(n=>this.normalizeUsers(n)),v(()=>f([]))),i=this.streamRtdbUsers().pipe(c(n=>n.filter(s=>["user","client","staff","admin"].includes(s.role))));return y([r,i]).pipe(c(([n,s])=>this.mergeUsers(n,s)),c(n=>n.filter(s=>s.isVisible!==!1&&!s.deletedAt)))}isVisibleUser(t){return t?t.isVisible!==!1&&!t.deletedAt:!1}getVisibleAdminCount(t){return g(this,null,function*(){let e=w(this.firestore,"users"),r=C(e,V("role","==","admin")),i=yield F(r),n=0;return i.forEach(s=>{if(t&&s.id===t)return;let a=s.data();this.isVisibleUser(a)&&n++}),n})}updateUser(t,e){return g(this,null,function*(){let r=this.auth.userSig();try{let i=Object.keys(e??{}),n=i.length===1&&i[0]==="role";n?this.assertCanManageRolesAction():this.assertAdminAction();let s=S(this.firestore,"users",t);(yield A(s)).exists()||(yield P(s,{id:t,role:e.role??"client",isActive:!0,isVisible:!0,createdAt:p(),updatedAt:p()},{merge:!0}));let J=(yield A(s)).data()??{},z=String(J.role??""),h=e.role?String(e.role):null,W=String(r?.role??"");if(r?.uid===t&&h&&h!==z)throw new Error("Non puoi cambiare il tuo ruolo");if(n&&W==="staff"&&(z==="admin"||h==="admin"))throw new Error("Lo staff abilitato non puo modificare ruoli admin");if(z==="admin"&&h&&h!=="admin"&&(yield this.getVisibleAdminCount())<=1)throw new Error("Impossibile rimuovere il ruolo all ultimo admin");yield x(s,this.toFirestorePatch(e)),this.audit.log({action:"user.update",resource:"user",resourceId:t,status:"success",actorId:r?.uid,actorRole:r?.role,targetUserId:t,meta:{changedKeys:Object.keys(e??{})}}),this.ui.success("Utente aggiornato")}catch(i){throw this.audit.log({action:"user.update",resource:"user",resourceId:t,status:"error",actorId:r?.uid,actorRole:r?.role,targetUserId:t,meta:{changedKeys:Object.keys(e??{})}}),this.ui.error(i?.message||"Errore aggiornamento utente"),i}})}deleteUser(t){return g(this,null,function*(){let e=this.auth.userSig();try{if(this.assertAdminAction(),e?.uid===t)throw new Error("Non puoi nascondere il tuo account");let r=S(this.firestore,"users",t);(yield A(r)).exists()||(yield P(r,{id:t,role:"client",isActive:!0,isVisible:!0,createdAt:p(),updatedAt:p()},{merge:!0}));let s=(yield A(r)).data()??{};if(String(s.role??"")==="admin"&&(yield this.getVisibleAdminCount())<=1)throw new Error("Impossibile nascondere l ultimo admin");yield x(r,{isVisible:!1,isActive:!1,deletedAt:p(),updatedAt:p()}),this.audit.log({action:"user.hide",resource:"user",resourceId:t,status:"success",actorId:e?.uid,actorRole:e?.role,targetUserId:t}),this.ui.warn("Utente nascosto")}catch(r){throw this.audit.log({action:"user.hide",resource:"user",resourceId:t,status:"error",actorId:e?.uid,actorRole:e?.role,targetUserId:t}),this.ui.error(r?.message||"Errore eliminazione utente"),r}})}static \u0275fac=function(e){return new(e||m)};static \u0275prov=R({token:m,factory:m.\u0275fac,providedIn:"root"})};export{G as a,H as b};
