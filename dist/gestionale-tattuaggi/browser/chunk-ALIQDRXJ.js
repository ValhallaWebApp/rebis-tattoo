import{A as W,B as b,D as m,E as $,F as I,G as O,H as l,I as R,J as D,K as Q,L as x,c as at,dc as P,e as V,f as ct,h as dt,i as ut,j as z,n as lt,o as B,p as N,q as gt,s as ht,u as K,v as pt,w as ft,x as S,z as H}from"./chunk-VVGPL6SB.js";import{h as nt}from"./chunk-3PBLYRJ4.js";import{C as L,Lb as w,a as E,c as v,h,i as M,na as A,t as q}from"./chunk-I2SBXG73.js";import{l as et}from"./chunk-VPSPPOSA.js";import{N as C,Ob as ot,Sb as st,X as it,k as f,ta as rt}from"./chunk-Y3XNR5LB.js";import{a as g,b as k,e as d}from"./chunk-ACKELEN3.js";function It(u){u||(q(It),u=M(L));let e=new f(t=>u.onDestroy(t.next.bind(t)));return t=>t.pipe(st(e))}function Y(u,e){let t=!e?.manualCleanup;t&&!e?.injector&&q(Y);let i=t?e?.injector?.get(L)??M(L):null,r=Dt(e?.equal),o;e?.requireSync?o=A({kind:0},{equal:r}):o=A({kind:1,value:e?.initialValue},{equal:r});let s=u.subscribe({next:n=>o.set({kind:1,value:n}),error:n=>{if(e?.rejectErrors)throw n;o.set({kind:2,error:n})}});if(e?.requireSync&&o().kind===0)throw new E(601,!1);return i?.onDestroy(s.unsubscribe.bind(s)),w(()=>{let n=o();switch(n.kind){case 1:return n.value;case 2:throw n.error;case 0:throw new E(601,!1)}},{equal:e?.equal})}function Dt(u=Object.is){return(e,t)=>e.kind===1&&t.kind===1&&u(e.value,t.value)}var U=class u{constructor(e){this.db=e}path="auditLogs";log(e){return d(this,null,function*(){let t=new Date().toISOString(),i=I(l(this.db,this.path)),r=i.key??`${Date.now()}`,o=this.stripUndef({id:r,at:t,action:e.action,resource:e.resource,resourceId:e.resourceId,status:e.status??"success",actorId:e.actorId??"system",actorRole:e.actorRole??"system",targetUserId:e.targetUserId,message:e.message,meta:e.meta});try{yield D(i,o)}catch(s){console.error("[AuditLogService] log error",s)}})}stream(e=500){return new f(t=>{let i=l(this.db,this.path),r=m(i,o=>{if(!o.exists()){t.next([]);return}let s=o.val(),n=Object.entries(s).map(([a,c])=>({id:a,at:String(c.at??new Date(0).toISOString()),action:String(c.action??""),resource:String(c.resource??""),resourceId:c.resourceId?String(c.resourceId):void 0,status:c.status??"success",actorId:c.actorId?String(c.actorId):void 0,actorRole:c.actorRole?String(c.actorRole):void 0,targetUserId:c.targetUserId?String(c.targetUserId):void 0,message:c.message?String(c.message):void 0,meta:c.meta??{}})).sort((a,c)=>c.at.localeCompare(a.at)).slice(0,e);t.next(n)},o=>t.error(o));return()=>r()})}pruneOlderThan(e=90){return d(this,null,function*(){let t=new Date(Date.now()-e*24*60*60*1e3).toISOString(),i=yield b(l(this.db,this.path));if(!i.exists())return 0;let r=i.val(),o=Object.entries(r).filter(([,s])=>String(s.at??"")<t).map(([s])=>s);return yield Promise.all(o.map(s=>R(l(this.db,`${this.path}/${s}`)))),o.length})}stripUndef(e){let t={};for(let[i,r]of Object.entries(e))r!==void 0&&(t[i]=r);return t}static \u0275fac=function(t){return new(t||u)(h(S))};static \u0275prov=v({token:u,factory:u.\u0275fac,providedIn:"root"})};var _=class u{constructor(e,t,i,r,o,s){this.auth=e;this.firestore=t;this.db=i;this.router=r;this.ui=o;this.audit=s;let n=V(this.auth).pipe(ot(a=>a?this.ensureUserProfile(a).then(c=>c?(this._userSig.set(c),c):(this._userSig.set(null),null)).catch(()=>(this._userSig.set(null),null)):(this._userSig.set(null),C(null))),rt(()=>C(null)));Y(n,{initialValue:null})}_userSig=A(null);userSig=this._userSig;isLoggedInSig=w(()=>!!this._userSig());roleSig=w(()=>this._userSig()?.role||"public");normalizeUser(e){let t=String(e.uid??e.id??""),i=String(e.role??"public");return k(g({},e),{uid:t,role:i||"public",permissions:{canManageRoles:e?.permissions?.canManageRoles===!0}})}inferRoleFromRtdb(e){return d(this,null,function*(){try{let t=yield b(l(this.db,`adminUids/${e}`));if(t.exists()&&t.val()===!0)return"admin";let i=yield b(l(this.db,`staffProfiles/${e}`));if(i.exists()&&i.child("isActive").val()!==!1)return"staff"}catch{}return"client"})}ensureUserProfile(e){return d(this,null,function*(){let t=B(this.firestore,"users",e.uid),i=yield N(t);if(i.exists())return this.normalizeUser(g({id:e.uid,uid:e.uid},i.data()));let r=yield this.inferRoleFromRtdb(e.uid),o={uid:e.uid,email:e.email??"",name:e.displayName??"",role:r,isActive:!0};return yield K(t,g({id:e.uid},o),{merge:!0}),o})}login(e,t){return d(this,null,function*(){try{let i=yield dt(this.auth,e,t),r=B(this.firestore,"users",i.user.uid),o=yield N(r);if(o.exists()){let s=this.normalizeUser(g({id:i.user.uid,uid:i.user.uid},o.data()));this._userSig.set(s),this.audit.log({action:"auth.login",resource:"auth",status:"success",actorId:s.uid,actorRole:s.role,meta:{email:e}})}else{let s=yield this.ensureUserProfile(i.user);this._userSig.set(s),this.audit.log({action:"auth.login.bootstrap_profile",resource:"user",status:"success",actorId:i.user.uid,actorRole:s?.role,targetUserId:i.user.uid,meta:{email:e,reason:"profile_not_found"}})}}catch(i){throw this.audit.log({action:"auth.login",resource:"auth",status:"error",message:String(i?.code??i?.message??"unknown_error"),meta:{email:e}}),i}})}register(e,t){return d(this,null,function*(){try{let i=yield ct(this.auth,e,t),r={uid:i.user.uid,email:e,name:"",role:"client",isActive:!0};yield K(B(this.firestore,"users",i.user.uid),g({id:i.user.uid},r)),this._userSig.set(r),this.audit.log({action:"auth.register",resource:"user",resourceId:r.uid,status:"success",actorId:r.uid,actorRole:r.role,targetUserId:r.uid,meta:{email:e}})}catch(i){throw this.audit.log({action:"auth.register",resource:"user",status:"error",message:String(i?.code??i?.message??"unknown_error"),meta:{email:e}}),i}})}logout(){return d(this,null,function*(){let e=this._userSig();yield ut(this.auth),this._userSig.set(null),this.audit.log({action:"auth.logout",resource:"auth",status:"success",actorId:e?.uid,actorRole:e?.role}),this.router.navigate(["/login"])})}getUser(){return this._userSig()}resolveCurrentUser(){return d(this,null,function*(){let e=this._userSig();if(e)return e;let t=this.auth.currentUser??(yield et(V(this.auth)));if(!t)return this._userSig.set(null),null;let i=B(this.firestore,"users",t.uid),r=yield N(i);if(!r.exists()){let s=yield this.ensureUserProfile(t);return this._userSig.set(s),s}let o=this.normalizeUser(g({id:t.uid,uid:t.uid},r.data()));return this._userSig.set(o),o})}updateCurrentUserProfile(e){return d(this,null,function*(){let t=this._userSig();if(!t)throw new Error("Nessun utente loggato");try{let i=B(this.firestore,"users",t.uid);yield pt(i,e),this._userSig.set(g(g({},t),e)),this.audit.log({action:"user.profile.update",resource:"user",resourceId:t.uid,status:"success",actorId:t.uid,actorRole:t.role,targetUserId:t.uid,meta:{changedKeys:Object.keys(e??{})}}),this.ui.success("Profilo aggiornato")}catch(i){throw this.audit.log({action:"user.profile.update",resource:"user",resourceId:t.uid,status:"error",actorId:t.uid,actorRole:t.role,targetUserId:t.uid,meta:{changedKeys:Object.keys(e??{})}}),this.ui.error("Errore aggiornamento profilo"),i}})}static \u0275fac=function(t){return new(t||u)(h(at),h(z),h(S),h(nt),h(P),h(U))};static \u0275prov=v({token:u,factory:u.\u0275fac,providedIn:"root"})};var F=class u{constructor(e,t){this.db=e;this.ui=t}path="notifications";getUserNotifications(e){return e?new f(t=>{let i=l(this.db,`${this.path}/${e}`),r=m(i,o=>{if(!o.exists()){t.next([]);return}let s=o.val(),n=Object.entries(s).map(([a,c])=>this.toNotification(a,e,c)).sort((a,c)=>c.createdAt.localeCompare(a.createdAt));t.next(n)},o=>t.error(o));return()=>r()}):C([])}getUnreadCount(e){return this.getUserNotifications(e).pipe(it(t=>t.filter(i=>!i.readAt).length))}createForUser(e,t){return d(this,null,function*(){let i=I(l(this.db,`${this.path}/${e}`)),r=i.key??`${Date.now()}`,o=new Date().toISOString(),s={id:r,userId:e,type:t.type,title:t.title,message:t.message,link:t.link,priority:t.priority??"normal",createdAt:o,readAt:null,meta:t.meta};return yield D(i,this.stripUndef(s)),r})}markAsRead(e,t){return d(this,null,function*(){try{let i=l(this.db,`${this.path}/${e}/${t}`);yield x(i,{readAt:new Date().toISOString()})}catch(i){throw this.ui.error("Errore aggiornamento notifica"),i}})}markAllAsRead(e){return d(this,null,function*(){try{let t=l(this.db,`${this.path}/${e}`),i=yield b(t);if(!i.exists())return;let r=i.val(),o=new Date().toISOString(),s={};for(let[n,a]of Object.entries(r))a.readAt||(s[`${n}/readAt`]=o);if(Object.keys(s).length===0)return;yield x(t,s),this.ui.info("Notifiche segnate come lette")}catch(t){throw this.ui.error("Errore aggiornamento notifiche"),t}})}delete(e,t){return d(this,null,function*(){try{yield R(l(this.db,`${this.path}/${e}/${t}`)),this.ui.info("Notifica eliminata")}catch(i){throw this.ui.error("Errore eliminazione notifica"),i}})}resolveNotificationLink(e,t){let i=String(e.link??"").trim();return i||this.getDefaultLinkByTypeAndRole(e.type,t)}getDefaultLinkByTypeAndRole(e,t){let i=t==="admin"||t==="staff";return e==="booking"?i?"/admin/calendar":"/dashboard/booking-history":e==="chat"?i?"/admin/messaging":"/dashboard/chat":e==="payment"?i?"/admin/billing":"/dashboard/invoices":e==="bonus"?i?"/admin/bonus":"/dashboard/buoni":i?"/admin":"/dashboard"}toNotification(e,t,i){return{id:e,userId:t,type:i.type??"system",title:i.title??"",message:i.message??"",link:i.link,priority:i.priority??"normal",createdAt:i.createdAt??new Date(0).toISOString(),readAt:i.readAt??null,meta:i.meta}}stripUndef(e){let t={};for(let[i,r]of Object.entries(e))r!==void 0&&(t[i]=r);return t}static \u0275fac=function(t){return new(t||u)(h(S),h(P))};static \u0275prov=v({token:u,factory:u.\u0275fac,providedIn:"root"})};var bt=class u{_draft=A(null);draftSig=this._draft.asReadonly();hasDraftSig=w(()=>this._draft()!==null);stripUndef(e){let t={};for(let i of Object.keys(e))e[i]!==void 0&&(t[i]=e[i]);return t}setDraft(e,t={}){let i=this.stripUndef(e),r=this._draft(),o=t.merge&&r?g(g({},r),i):i;console.log("[BookingDraftService] setDraft \u2192",{prev:r,incoming:i,merge:!!t.merge,next:o}),this._draft.set(o)}patchDraft(e){let t=this._draft(),i=g(g({},t||{}),this.stripUndef(e));console.log("[BookingDraftService] patchDraft \u2192",{prev:t,patch:e,next:i}),this._draft.set(i)}consume(){let e=this._draft();return this._draft.set(null),console.log("[BookingDraftService] consume \u2192",e),e}reset(){console.log("[BookingDraftService] reset"),this._draft.set(null)}static \u0275fac=function(t){return new(t||u)};static \u0275prov=v({token:u,factory:u.\u0275fac,providedIn:"root"})},vt=class u{constructor(e,t,i,r,o,s){this.db=e;this.firestore=t;this.notificationService=i;this.ui=r;this.auth=o;this.audit=s}path="bookings";toCanonical(e){let t=e.createdAt??e.createAt??new Date().toISOString(),i=e.updatedAt??e.updateAt??t,r=e.clientId??e.idClient??"",o=e.artistId??e.idArtist??"",s=e.notes??e.description??"",n=k(g({},e),{clientId:r,artistId:o,notes:s,createdAt:t,updatedAt:i,idClient:e.idClient??r,idArtist:e.idArtist??o,description:e.description??s,createAt:e.createAt??t,updateAt:e.updateAt??i});return n.start=this.normalizeLocalDateTime(n.start),n.end=this.normalizeLocalDateTime(n.end),n.status=n.status??"draft",n.price=n.price??0,n.paidAmount=n.paidAmount??0,n}toDbPatch(e){let t=g({},e);return t.idClient&&!t.clientId&&(t.clientId=t.idClient),t.idArtist&&!t.artistId&&(t.artistId=t.idArtist),t.description&&!t.notes&&(t.notes=t.description),t.createAt&&!t.createdAt&&(t.createdAt=t.createAt),t.updateAt&&!t.updatedAt&&(t.updatedAt=t.updateAt),t.clientId&&!t.idClient&&(t.idClient=t.clientId),t.artistId&&!t.idArtist&&(t.idArtist=t.artistId),t.notes&&!t.description&&(t.description=t.notes),t.createdAt&&!t.createAt&&(t.createAt=t.createdAt),t.updatedAt&&!t.updateAt&&(t.updateAt=t.updatedAt),t.start&&(t.start=this.normalizeLocalDateTime(t.start)),t.end&&(t.end=this.normalizeLocalDateTime(t.end)),t}snapshotToList(e){let t=e.val();return t?Object.entries(t).map(([i,r])=>this.toCanonical(g({id:i},r))):[]}getFreeSlotsInDay(e,t,i=60,r=60){return d(this,null,function*(){let n=this.normalizeDateOnly(t);if(!n)return[];let a=`${n}T00:00:00`,c=`${n}T23:59:59`,p=yield this.getBookingsByArtistAndDayRange(e,a,c),y=[],T=9*60,kt=18*60;for(let j=T;j<=kt-i;j+=r){let St=Math.floor(j/60),At=j%60,J=`${String(St).padStart(2,"0")}:${String(At).padStart(2,"0")}`,X=`${n}T${J}:00`,wt=this.addMinutesLocal(X,i);p.some(tt=>this.overlapsLocal(X,wt,tt.start,tt.end))||y.push({time:J})}return y})}getBookingsByArtistAndDayRange(e,t,i){return d(this,null,function*(){let r=O(l(this.db,this.path),$("start"),Q(t),H(`${i}\uF8FF`)),o=yield b(r),s=o.exists()?Object.values(o.val()).map(a=>this.toCanonical(a)):[],n=new Set(["cancelled","annulled","no_show"]);return s.filter(a=>(a.artistId||a.idArtist)===e).filter(a=>!!a.start&&!!a.end).filter(a=>!n.has(String(a.status))).sort((a,c)=>a.start.localeCompare(c.start))})}getAllBookings(){return console.log("[BookingService] getAllBookings \u2192 subscribe"),new f(e=>{let t=m(l(this.db,this.path),i=>{let r=i.exists()?this.snapshotToList(i):[];console.log("[BookingService] getAllBookings \u2190 next",{count:r.length}),e.next(r)},i=>e.error(i));return()=>t()})}getBookingsByClient(e){return console.log("[BookingService] getBookingsByClient \u2192 subscribe",{clientId:e}),new f(t=>{let i=O(l(this.db,this.path),$("clientId"),W(e)),r=m(i,o=>{let s=o.exists()?this.snapshotToList(o):[];t.next(s)},o=>t.error(o));return()=>r()})}getBookingsByArtist(e){return new f(t=>{let i=O(l(this.db,this.path),$("artistId"),W(e)),r=m(i,o=>{let s=o.exists()?this.snapshotToList(o):[];t.next(s)},o=>t.error(o));return()=>r()})}getBookingsByDate(e){let t=typeof e=="string"?e.slice(0,10):e.toISOString().slice(0,10),i=`${t}T00:00:00`,r=`${t}T23:59:59\uF8FF`,o=O(l(this.db,this.path),$("start"),Q(i),H(r));return new f(s=>{let n=m(o,a=>{let c=a.exists()?this.snapshotToList(a).sort((p,y)=>p.start.localeCompare(y.start)):[];s.next(c)},a=>s.error(a));return()=>n()})}getBookingById(e){return d(this,null,function*(){let t=yield b(l(this.db,`${this.path}/${e}`));if(!t.exists())return null;let i=t.val();return this.toCanonical(g({id:e},i))})}watchBooking(e){return new f(t=>{let i=l(this.db,`${this.path}/${e}`),r=m(i,o=>t.next(o.exists()?this.toCanonical(g({id:e},o.val())):null),o=>t.error(o));return()=>r()})}addDraft(e){return d(this,null,function*(){let t=I(l(this.db,this.path)),i=t.key,r=new Date().toISOString(),o=this.toDbPatch(k(g({},e),{id:i,status:"draft",createdAt:e.createdAt??e.createAt??r,updatedAt:r}));return console.log("[BookingService] addDraft \u2192",o),yield D(t,o),i})}createBooking(e){return d(this,null,function*(){let t=this.auth.userSig();try{let i=I(l(this.db,this.path)),r=i.key,o=new Date().toISOString(),s=this.toCanonical(k(g({},e),{id:r,status:e.status??e.status??"draft",createdAt:o,updatedAt:o}));return yield D(i,this.toDbPatch(s)),this.audit.log({action:"booking.create",resource:"booking",resourceId:r,status:"success",actorId:t?.uid,actorRole:t?.role,targetUserId:s.clientId,meta:{status:s.status,artistId:s.artistId}}),this.notifyBookingCreated(s),this.ui.success("Prenotazione creata"),s}catch(i){throw this.audit.log({action:"booking.create",resource:"booking",status:"error",actorId:t?.uid,actorRole:t?.role}),this.ui.error("Errore creazione prenotazione"),i}})}updateBooking(e,t){return d(this,null,function*(){let i=this.auth.userSig();try{let r=yield this.getBookingById(e),o=this.toDbPatch(k(g({},t),{updatedAt:new Date().toISOString()}));if(delete o.createdAt,delete o.createAt,console.log("[BookingService] updateBooking ->",{id:e,patch:o}),yield x(l(this.db,`${this.path}/${e}`),o),this.audit.log({action:"booking.update",resource:"booking",resourceId:e,status:"success",actorId:i?.uid,actorRole:i?.role,targetUserId:r?.clientId,meta:{changedKeys:Object.keys(t??{})}}),r){let s=this.toCanonical(k(g(g({},r),t),{id:e}));this.notifyBookingUpdated(r,s)}this.ui.info("Prenotazione aggiornata")}catch(r){throw this.audit.log({action:"booking.update",resource:"booking",resourceId:e,status:"error",actorId:i?.uid,actorRole:i?.role,meta:{changedKeys:Object.keys(t??{})}}),this.ui.error("Errore aggiornamento prenotazione"),r}})}deleteBooking(e){return d(this,null,function*(){let t=this.auth.userSig();try{let i=yield this.getBookingById(e);console.log("[BookingService] deleteBooking ->",{id:e}),yield R(l(this.db,`${this.path}/${e}`)),this.audit.log({action:"booking.delete",resource:"booking",resourceId:e,status:"success",actorId:t?.uid,actorRole:t?.role,targetUserId:i?.clientId}),i&&this.notifyBookingDeleted(i),this.ui.warn("Prenotazione eliminata")}catch(i){throw this.audit.log({action:"booking.delete",resource:"booking",resourceId:e,status:"error",actorId:t?.uid,actorRole:t?.role}),this.ui.error("Errore eliminazione prenotazione"),i}})}isValidTransition(e,t){return{draft:["pending","confirmed","cancelled"],pending:["confirmed","cancelled"],confirmed:["paid","cancelled","no_show","in_progress"],paid:["in_progress","cancelled","no_show"],in_progress:["completed","cancelled"],completed:[],cancelled:[],no_show:[]}[e]?.includes(t)??!1}safeSetStatus(r,o){return d(this,arguments,function*(e,t,i={}){let s=yield this.getBookingById(e);if(!s)throw new Error("Prenotazione non trovata");let n=s.status??"draft";if(!this.isValidTransition(n,t))throw new Error(`Transizione non valida da ${n} a ${t}`);yield this.updateBooking(e,g({status:t},i))})}safeSetStatusSafe(r,o){return d(this,arguments,function*(e,t,i={}){try{return yield this.safeSetStatus(e,t,i),{ok:!0,data:void 0}}catch(s){return{ok:!1,error:String(s?.message??`Errore aggiornamento stato a ${t}`)}}})}rescheduleBooking(e,t,i,r){return d(this,null,function*(){let o=yield this.getBookingById(e);if(!o)throw new Error("Prenotazione non trovata");if(["completed","cancelled","no_show"].includes(o.status))throw new Error("Non puoi modificare una prenotazione chiusa.");yield this.updateBooking(e,{start:t,end:i,lastRescheduledAt:new Date().toISOString(),rescheduleCount:(o.rescheduleCount||0)+1}),console.log("[BookingService] rescheduleBooking OK",{id:e,updater:r})})}getTotalRevenueThisMonth(){let[e,t]=new Date().toISOString().split("-");return new f(i=>{let r=m(l(this.db,this.path),o=>{let s=o.val()?Object.values(o.val()).map(n=>this.toCanonical(n)).filter(n=>n.status==="paid"&&n.start.startsWith(`${e}-${t}`)).reduce((n,a)=>n+(a.price??0),0):0;i.next(s)});return()=>r()})}buildDraftPayloadFromChat(e,t){let{clientId:i,clientName:r,type:o,source:s}=t,n=e.start?this.normalizeLocalDateTime(e.start):"",a=e.end?this.normalizeLocalDateTime(e.end):"";if(!n||!a){if(!e.date||!e.time)throw new Error('Draft incompleto: servono "date" e "time".');n=this.normalizeLocalDateTime(`${e.date}T${e.time}:00`);let c=e.duration&&e.duration>0?e.duration:30;a=this.addMinutesLocal(n,c)}return{clientId:i,artistId:e.artistId||"",type:o??"consultation",source:s??"chat-bot",title:`${r||"Cliente"} - Prenotazione`,start:n,end:a,notes:e.note||"",status:"draft",price:0,depositRequired:0,paidAmount:0,idClient:i,idArtist:e.artistId||"",description:e.note||""}}addDraftFromChat(e,t){return d(this,null,function*(){let i=t.clientId??t.idClient??"";if(!i)throw new Error("clientId mancante");let r=this.buildDraftPayloadFromChat(e,{clientId:i,clientName:t.clientName,type:"consultation",source:t.source??"chat-bot"});return this.addDraft(r)})}addDraftFromChatSafe(e,t){return d(this,null,function*(){try{return{ok:!0,data:yield this.addDraftFromChat(e,t)}}catch(i){return{ok:!1,error:String(i?.message??"Errore creazione bozza prenotazione")}}})}pad(e){return String(e).padStart(2,"0")}formatLocal(e){let t=e.getFullYear(),i=this.pad(e.getMonth()+1),r=this.pad(e.getDate()),o=this.pad(e.getHours()),s=this.pad(e.getMinutes()),n=this.pad(e.getSeconds());return`${t}-${i}-${r}T${o}:${s}:${n}`}addMinutesLocal(e,t){let i=new Date(this.normalizeLocalDateTime(e));return i.setMinutes(i.getMinutes()+t),this.formatLocal(i)}normalizeDateOnly(e){return e?e.slice(0,10):""}normalizeLocalDateTime(e){if(!e)return e;let t=String(e).replace("Z","");t=t.split(".")[0];let i=/^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}$/.test(t);if(/^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}$/.test(t))return`${t}:00`;if(i)return t;let o=new Date(e);return isNaN(o.getTime())?t:this.formatLocal(o)}overlapsLocal(e,t,i,r){let o=new Date(this.normalizeLocalDateTime(e)).getTime(),s=new Date(this.normalizeLocalDateTime(t)).getTime(),n=new Date(this.normalizeLocalDateTime(i)).getTime(),a=new Date(this.normalizeLocalDateTime(r)).getTime();return o<a&&n<s}notifyBookingCreated(e){return d(this,null,function*(){let t=this.formatNotificationDate(e.start),i=yield this.getAdminUserIds();yield this.notifyUsers([e.clientId],{title:"Prenotazione creata",message:`La tua prenotazione e stata creata per ${t}.`,link:"/dashboard/booking-history"}),yield this.notifyUsers([e.artistId],{title:"Nuova prenotazione",message:`Nuovo booking assegnato per ${t}.`,link:"/admin/calendar"}),yield this.notifyUsers(i,{title:"Nuova prenotazione",message:`Creato nuovo booking per ${t}.`,link:"/admin/calendar"})})}notifyBookingUpdated(e,t){return d(this,null,function*(){let i=e.status!==t.status,r=e.start!==t.start||e.end!==t.end;if(!i&&!r)return;let o=yield this.getAdminUserIds(),s=this.formatNotificationDate(t.start),n=i?`Stato prenotazione aggiornato a "${t.status}".`:`Prenotazione ripianificata per ${s}.`;yield this.notifyUsers([t.clientId],{title:"Prenotazione aggiornata",message:n,link:"/dashboard/booking-history"}),yield this.notifyUsers([t.artistId,...o],{title:"Prenotazione aggiornata",message:n,link:"/admin/calendar"})})}notifyBookingDeleted(e){return d(this,null,function*(){let t=this.formatNotificationDate(e.start),i=yield this.getAdminUserIds();this.notifyUsers([e.clientId],{title:"Prenotazione cancellata",message:`La prenotazione del ${t} e stata cancellata.`,link:"/dashboard/booking-history",priority:"high"}),this.notifyUsers([e.artistId,...i],{title:"Prenotazione cancellata",message:`La prenotazione del ${t} e stata cancellata.`,link:"/admin/calendar",priority:"high"})})}notifyUsers(e,t){return d(this,null,function*(){let i=this.auth.userSig(),r=i?.uid??null,o=i?.role??"guest",s=o==="admin",n=[...new Set(e.filter(Boolean))];if(s||(n=r?n.filter(p=>p===r):[]),n.length===0)return;let c=(yield Promise.allSettled(n.map(p=>this.notificationService.createForUser(p,{type:"booking",title:t.title,message:t.message,link:t.link,priority:t.priority??"normal"})))).map((p,y)=>({result:p,userId:n[y]})).filter(p=>p.result.status==="rejected").map(({result:p,userId:y})=>{let T=p.reason;return{userId:y,code:T?.code??"unknown",message:T?.message??String(T)}});if(c.length>0){let p=c.some(y=>String(y.code).includes("PERMISSION_DENIED"));p&&!s?console.warn("[BookingService] notifyUsers skipped by RTDB rules for non-admin actor",{actorId:r,actorRole:o,failedCount:c.length}):(p&&console.warn("[BookingService] RTDB rules stanno bloccando la scrittura notifiche su utenti terzi. Verifica rules su notifications/{userId}."),console.error("[BookingService] notifyUsers failed",c))}})}formatNotificationDate(e){let t=new Date(this.normalizeLocalDateTime(e));return isNaN(t.getTime())?e:t.toLocaleString("it-IT",{dateStyle:"short",timeStyle:"short"})}getAdminUserIds(){return d(this,null,function*(){try{let e=lt(this.firestore,"users"),t=ht(e,ft("role","==","admin"));return(yield gt(t)).docs.map(r=>r.id)}catch(e){return console.error("[BookingService] getAdminUserIds error",e),[]}})}static \u0275fac=function(t){return new(t||u)(h(S),h(z),h(F),h(P),h(_),h(U))};static \u0275prov=v({token:u,factory:u.\u0275fac,providedIn:"root"})};export{It as a,U as b,_ as c,F as d,vt as e};
