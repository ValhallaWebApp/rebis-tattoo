import{b as H}from"./chunk-B652JRNK.js";import{p as O,r as F}from"./chunk-WRV7VZGV.js";import{mc as D,nc as M}from"./chunk-3TZOJYN7.js";import{a as w}from"./chunk-SKC5KPUI.js";import{Mb as p,Ob as f,c as S,h as P,i as g,na as a}from"./chunk-WX7FJ26P.js";import{l as y}from"./chunk-VPSPPOSA.js";import{O as v,W as k,X as E,ta as N}from"./chunk-Y3XNR5LB.js";import{a as u,b as m,e as h}from"./chunk-ACKELEN3.js";var A={production:!0,paymentApiBaseUrl:"https://payment-service.valhallawebapp.workers.dev/api/payments",firebaseConfig:{apiKey:"AIzaSyDFOFTJ9p60YeoVdLGo8ZfuaOOaUpgAP5E",authDomain:"rebis-tattoo-55816.firebaseapp.com",databaseURL:"https://rebis-tattoo-55816-default-rtdb.europe-west1.firebasedatabase.app/",projectId:"rebis-tattoo-55816",storageBucket:"rebis-tattoo-55816.firebasestorage.app",messagingSenderId:"70352364616",appId:"1:70352364616:web:24a6df01d24f6b4947647d",measurementId:"G-1HW9SPJ1CN"},stripePublishableKey:"pk_test_51QNHjmHTS8uBqIoqBo51zWatjkDbUcP3SECoQb1Y859MfKtk6WbIfNRvpDJfdBUJP58OOPDPaQibnTjRbd6vgdWx00Mh7pSPeZ"};var I=class d{constructor(t){this.http=t}baseUrl=A.paymentApiBaseUrl;requestTimeoutMs=15e3;createPaymentIntent(t){return this.http.post(`${this.baseUrl}/create`,t).pipe(k(this.requestTimeoutMs),E(e=>({clientSecret:e.clientSecret,paymentIntentId:e.paymentIntentId})),N(e=>{let r=this.normalizeErrorMessage(e);return v(()=>({message:r,status:e?.status,original:e}))}))}createPaymentIntentSafe(t){return h(this,null,function*(){try{return{ok:!0,data:yield y(this.createPaymentIntent(t))}}catch(e){return{ok:!1,error:String(e?.message??"Errore creazione pagamento"),status:e?.status}}})}normalizeErrorMessage(t){if(!t)return"Errore di rete durante la richiesta pagamento.";if(t?.name==="TimeoutError")return"Timeout chiamata pagamento. Riprova.";let e=Number(t?.status??0);return e===0?"Backend pagamenti non raggiungibile.":e===400?t?.error?.error||"Dati pagamento non validi.":e===401||e===403?"Non autorizzato alla creazione pagamento.":e>=500?"Errore interno del backend pagamenti.":t?.error?.error||t?.message||"Errore pagamento non previsto."}static \u0275fac=function(e){return new(e||d)(P(w))};static \u0275prov=S({token:d,factory:d.\u0275fac,providedIn:"root"})};var C=class d{staffService=g(M);bookingService=g(F);userService=g(H);paymentApi=g(I);auth=g(O);ui=g(D);HOME_SEED_KEY="FAST_BOOKING_HOME_SEED";steps=["intro","artist","when","details","summary","payment","success"];step=a("intro");depositEuro=a(50);durationMin=a(60);artists=a([]);loadingArtists=a(!1);selectedDate=a(null);slots=a([]);loadingSlots=a(!1);bookingId=a(null);paymentClientSecret=a(null);paymentIntentId=a(null);paying=a(!1);error=a(null);draft=a({artistId:null,artistName:null,date:null,time:null,name:null,contact:null,description:null});constructor(){f(()=>{let t=this.auth.userSig();if(!t)return;let e=t.name??t.displayName??null,r=t.email??null,n=t.phone??t.phoneNumber??null,s=r??n??null;this.draft.update(c=>{let i=u({},c);return(!i.name||String(i.name).trim()==="")&&(i.name=e),(!i.contact||String(i.contact).trim()==="")&&(i.contact=s),i})},{allowSignalWrites:!0}),f(()=>{let t=this.artists(),e=this.draft(),r=e.artistId;if(!r||!t?.length)return;let n=t.find(i=>i.id===r);if(!n)return;let s=n.name??null;(e.artistName??null)!==s&&this.draft.update(i=>m(u({},i),{artistName:s}))},{allowSignalWrites:!0}),f(()=>{this.step()==="artist"&&this.artists().length===0&&queueMicrotask(()=>this.fetchArtists())}),f(()=>{let t=this.step(),e=this.draft(),r=this.selectedDate();t==="when"&&e.artistId&&r&&queueMicrotask(()=>this.fetchSlots(e.artistId,r))}),queueMicrotask(()=>this.hydrateFromHomeSeed())}stepIndex=p(()=>this.steps.indexOf(this.step()));progress=p(()=>(this.stepIndex()+1)/this.steps.length*100);canBack=p(()=>this.stepIndex()>0&&this.step()!=="success");canNext=p(()=>{let t=this.step(),e=this.draft();return t==="artist"?!!e.artistId:t==="when"?!!e.date&&!!e.time:t==="details"?!!e.name&&!!e.contact&&!!e.description:t!=="payment"});isUserLogged=p(()=>!!this.auth.userSig());isNameLocked=p(()=>{let t=this.auth.userSig(),e=this.draft().name;return!!t&&!!e&&String(e).trim().length>0});isContactLocked=p(()=>{let t=this.auth.userSig(),e=this.draft().contact;return!!t&&!!e&&String(e).trim().length>0});back(){this.error.set(null),!(this.stepIndex()<=0)&&this.step.set(this.steps[this.stepIndex()-1])}next(){this.error.set(null),!(this.stepIndex()>=this.steps.length-1)&&this.step.set(this.steps[this.stepIndex()+1])}go(t){this.error.set(null),this.step.set(t)}setArtist(t){this.draft.update(e=>m(u({},e),{artistId:t.id??null,artistName:t.name??null})),this.selectedDate.set(null),this.slots.set([]),this.setWhen(null,null)}setDate(t){this.selectedDate.set(t),this.draft.update(e=>m(u({},e),{date:t,time:null}))}setWhen(t,e){this.draft.update(r=>m(u({},r),{date:t,time:e}))}setDetails(t){this.draft.update(e=>m(u({},e),{name:t.name,contact:t.contact,description:t.description}))}fetchArtists(){return h(this,null,function*(){try{this.loadingArtists.set(!0);let e=((yield y(this.staffService.getAllStaff()))??[]).filter(r=>(r.isActive??!0)===!0).filter(r=>r.role==="tatuatore").sort((r,n)=>(r.name||"").localeCompare(n.name||""));this.artists.set(e)}catch(t){console.error(t),this.error.set("Impossibile caricare gli artisti. Riprova.")}finally{this.loadingArtists.set(!1)}})}fetchSlots(t,e){return h(this,null,function*(){try{this.loadingSlots.set(!0),this.error.set(null);let r=this.durationMin(),n=yield this.bookingService.getFreeSlotsInDay(t,e,r);this.slots.set(n??[])}catch(r){console.error("[FAST_BOOKING][SLOTS] ERROR",r),this.slots.set([]),this.error.set("Impossibile caricare gli orari disponibili per questo giorno.")}finally{this.loadingSlots.set(!1)}})}startPayment(){return h(this,null,function*(){try{this.error.set(null),this.paying.set(!0);let t=this.draft(),e=this.userService.getCurrentUserId();if(!e){this.error.set("Per procedere serve il login (utente non autenticato).");return}if(!t.artistId||!t.date||!t.time){this.error.set("Seleziona artista, data e ora prima di pagare.");return}if(!t.name||!t.contact||!t.description){this.error.set("Completa i dati (nome, contatto, descrizione) prima di pagare.");return}let r={artistId:t.artistId,date:t.date,time:t.time,duration:this.durationMin(),note:t.description},n=yield this.bookingService.addDraftFromChatSafe(r,{idClient:e,clientName:t.name});if(!n.ok){this.error.set(n.error),this.ui.error(n.error);return}let s=n.data;this.bookingId.set(s);let c=Math.round(this.depositEuro()*100),i=yield this.paymentApi.createPaymentIntentSafe({amount:c,currency:"eur",description:`Caparra consulenza Rebis Tattoo - booking ${s}`,bookingId:s});if(!i.ok){yield this.bookingService.safeSetStatusSafe(s,"pending",{updatedAt:new Date().toISOString(),notes:`${t.description??""}
[payment-init-failed] ${i.error}`.trim()}),this.error.set(i.error),this.ui.error(i.error);return}this.paymentClientSecret.set(i.data.clientSecret),this.paymentIntentId.set(i.data.paymentIntentId),this.ui.success("Pagamento inizializzato correttamente.")}catch(t){console.error(t);let e=String(t?.message??"Errore durante la creazione del pagamento. Riprova.");this.error.set(e),this.ui.error(e)}finally{this.paying.set(!1)}})}confirmPaymentSuccess(){return h(this,null,function*(){try{let t=this.bookingId();if(!t){this.error.set("Booking non trovato.");return}let e=this.depositEuro(),r=yield this.bookingService.getBookingById(t);if(!r){this.error.set("Booking non trovato."),this.ui.error("Booking non trovato.");return}if(r.status==="draft"||r.status==="pending"){let s=yield this.bookingService.safeSetStatusSafe(t,"confirmed");if(!s.ok){this.error.set(s.error),this.ui.error(s.error);return}}let n=yield this.bookingService.safeSetStatusSafe(t,"paid",{paidAmount:e,price:e,updatedAt:new Date().toISOString()});if(!n.ok){this.error.set(n.error),this.ui.error(n.error);return}this.go("success"),this.ui.success("Pagamento registrato con successo.")}catch(t){console.error(t);let e="Pagamento registrato? Non riesco ad aggiornare lo stato booking.";this.error.set(e),this.ui.error(e)}})}resetAll(){this.error.set(null),this.bookingId.set(null),this.paymentClientSecret.set(null),this.paymentIntentId.set(null),this.selectedDate.set(null),this.slots.set([]);let t=this.auth.userSig(),e=t?t.name??t.displayName??null:null,r=t?t.email??null:null,n=t?t.phone??t.phoneNumber??null:null,s=t?r??n??null:null;this.draft.set({artistId:null,artistName:null,date:null,time:null,name:e,contact:s,description:null});try{sessionStorage.removeItem(this.HOME_SEED_KEY)}catch{}try{localStorage.removeItem(this.HOME_SEED_KEY)}catch{}this.step.set("intro")}seedFromHome(t){let e=t.artist??null,r=t.email&&t.email.trim()?t.email.trim():t.phone&&t.phone.trim()?t.phone.trim():null,n=t.fullName&&t.fullName.trim()?t.fullName.trim():null,s=t.procedure?.trim(),c=t.comments?.trim(),i=[s?`Procedura: ${s}`:null,c||null].filter(Boolean).join(`

`)||null;this.draft.update(o=>m(u({},o),{artistId:e,artistName:o.artistName,date:null,time:null,name:o.name&&String(o.name).trim()?o.name:n,contact:o.contact&&String(o.contact).trim()?o.contact:r,description:o.description&&String(o.description).trim()?o.description:i})),this.selectedDate.set(null),this.slots.set([]),this.step.set(e?"when":"artist");try{sessionStorage.setItem(this.HOME_SEED_KEY,JSON.stringify(t))}catch{}}hydrateFromHomeSeed(){try{let t=sessionStorage.getItem(this.HOME_SEED_KEY)||localStorage.getItem(this.HOME_SEED_KEY);if(!t)return;let e=JSON.parse(t);this.seedFromHome(e),localStorage.removeItem(this.HOME_SEED_KEY)}catch{}}applyHomeSeed(t,e){let r=e?.overwrite===!0,n=t.artist??null,s=t.fullName&&t.fullName.trim()?t.fullName.trim():null,c=t.email&&t.email.trim()?t.email.trim():t.phone&&t.phone.trim()?t.phone.trim():null,i=t.procedure?.trim()||null,o=t.comments?.trim()||null,b=[i?`Procedura: ${i}`:null,o].filter(Boolean).join(`

`)||null;this.draft.update(l=>m(u({},l),{artistId:r?n:l.artistId??n,artistName:l.artistName??null,name:r?s:l.name&&String(l.name).trim()?l.name:s,contact:r?c:l.contact&&String(l.contact).trim()?l.contact:c,description:r?b:l.description&&String(l.description).trim()?l.description:b}))}static \u0275fac=function(e){return new(e||d)};static \u0275prov=S({token:d,factory:d.\u0275fac,providedIn:"root"})};export{C as a};
