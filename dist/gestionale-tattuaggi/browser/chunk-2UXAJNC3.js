import{k as m,m as f,n as k,o as y,q as l,r as u,s as w,t as h,u as s,v as O,w as S,x as $,y as I}from"./chunk-GHRCGBKI.js";import{a as c,b as B,e as d,h as a,ja as v,oa as b}from"./chunk-GNSFZVKV.js";var P=class p{constructor(e){this.db=e}path="bookings";getAllBookings(){return new a(e=>l(s(this.db,this.path),t=>{let o=t.val()?Object.values(t.val()):[];e.next(o)}))}getBookingsByClient(e){return new a(t=>{let o=h(s(this.db,this.path),u("idClient"),k(e));return l(o,i=>{let n=i.val()?Object.values(i.val()):[];t.next(n)})})}getBookingsByDate(e){let t=typeof e=="string"?e.slice(0,10):e.toISOString().slice(0,10),o=`${t}T00:00:00`,i=`${t}T23:59:59\uF8FF`,n=h(s(this.db,this.path),u("start"),$(o),f(i));return new a(r=>l(n,g=>{let D=g.val()?Object.values(g.val()).sort((R,T)=>R.start.localeCompare(T.start)):[];r.next(D)}))}addDraft(e){return d(this,null,function*(){let t=w(s(this.db,this.path));return yield S(t,B(c({},e),{id:t.key,status:"draft"})),t.key})}updateBooking(e,t){return I(s(this.db,`${this.path}/${e}`),t)}setStatus(e,t,o={}){return this.updateBooking(e,c({status:t},o))}deleteBooking(e){return O(s(this.db,`${this.path}/${e}`))}getBookingById(e){return d(this,null,function*(){let t=yield y(s(this.db,`${this.path}/${e}`));return t.exists()?t.val():null})}watchBooking(e){return new a(t=>{let o=s(this.db,`${this.path}/${e}`);return l(o,i=>t.next(i.exists()?i.val():null))})}getBookingsByDay(e){return new a(t=>{let o=h(s(this.db,this.path),u("start"),k(e));return l(o,i=>{let n=i.val()?Object.values(i.val()):[];t.next(n)})})}getTotalRevenueThisMonth(){let[e,t]=new Date().toISOString().split("-");return new a(o=>{l(s(this.db,this.path),i=>{let n=i.val()?Object.values(i.val()).filter(r=>r.status==="paid"&&r.start.startsWith(`${e}-${t}`)).reduce((r,g)=>r+(g.price||0),0):0;o.next(n)})})}notify(e,t){console.log(`[NOTIFY] Evento: ${e} - Booking ID: ${t.id}`)}rescheduleBooking(e,t,o,i){return d(this,null,function*(){try{let n=yield this.getBookingById(e);if(!n)throw new Error("Prenotazione non trovata");if(["completed","cancelled"].includes(n.status))throw new Error("Non puoi modificare una prenotazione completata o annullata.");yield this.updateBooking(e,{start:t,end:o,updateAt:new Date().toISOString(),lastRescheduledAt:new Date().toISOString(),rescheduleCount:(n.rescheduleCount||0)+1}),this.notify("rescheduled",B(c({},n),{start:t,end:o}))}catch(n){throw console.error(`[ERROR] rescheduleBooking: ${n}`),n}})}isValidTransition(e,t){return{draft:["paid","cancelled"],paid:["on-going","cancelled"],"on-going":["completed","cancelled"],completed:[],cancelled:[]}[e]?.includes(t)??!1}safeSetStatus(i,n){return d(this,arguments,function*(e,t,o={}){try{let r=yield this.getBookingById(e);if(!r)throw new Error("Prenotazione non trovata");if(!this.isValidTransition(r.status,t))throw new Error(`Transizione non valida da ${r.status} a ${t}`);yield this.setStatus(e,t,o),this.notify(t,c(c({},r),o))}catch(r){throw console.error(`[ERROR] safeSetStatus: ${r}`),r}})}static \u0275fac=function(t){return new(t||p)(b(m))};static \u0275prov=v({token:p,factory:p.\u0275fac,providedIn:"root"})};export{P as a};
