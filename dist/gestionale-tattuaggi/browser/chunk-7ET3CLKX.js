import{a as D,c as A,d as O,e as b,f as g,g as U,h as V,j as h,k as R,l as S,m as w,o as Q,p as K}from"./chunk-RUQCNMPL.js";import{S as E,W as j,Y as x,_ as P,aa as u,ba as F,ca as z,ea as $,yc as k}from"./chunk-E5ZACFZL.js";import{c as v,h as I,i as m}from"./chunk-ZWDWJLXC.js";import{N as y,X as p,k as C}from"./chunk-Y3XNR5LB.js";import{a as d,b as l,e as c}from"./chunk-ACKELEN3.js";var N=class a{constructor(e){this.db=e}path="services";addService(e){let t=Date.now(),r=P(u(this.db,this.path)),i=l(d({id:r.key,createdAt:t,updatedAt:t,creatoreId:"admin"},e),{visibile:e.visibile??!1});return z(r,i)}deleteService(e){return F(u(this.db,`${this.path}/${e}`))}updateService(e,t){return $(u(this.db,`${this.path}/${e}`),l(d({},t),{updatedAt:Date.now()}))}getServices(){return new C(e=>{let t=u(this.db,this.path);x(t,r=>{let i=r.val(),s=i?Object.keys(i).map(o=>l(d({id:o},i[o]),{visibile:i[o].visibile===!0||i[o].visibile==="true"})):[];s.sort((o,n)=>n.createdAt-o.createdAt),e.next(s)})})}getServiceById(e){return c(this,null,function*(){let t=yield j(u(this.db,`${this.path}/${e}`));if(!t.exists())return null;let r=t.val();return l(d({id:e},r),{visibile:r.visibile===!0||r.visibile==="true"})})}static \u0275fac=function(t){return new(t||a)(I(E))};static \u0275prov=v({token:a,factory:a.\u0275fac,providedIn:"root"})};var q=class a{firestore=m(D);auth=m(K);ui=m(k);audit=m(Q);constructor(){}getCurrentUserId(){return this.auth.userSig()?.uid||null}getCurrentUserRole(){return this.auth.userSig()?.role||"guest"}assertAdminAction(){if(this.getCurrentUserRole()!=="admin")throw new Error("Azione consentita solo ad admin")}getClients(){let e=this.getCurrentUserId();if(this.getCurrentUserRole()==="admin"){let r=b(this.firestore,"users"),i=h(r,w("role","==","client"));return A(i,{idField:"id"}).pipe(p(s=>s.filter(o=>o.isVisible!==!1&&!o.deletedAt)))}else if(e){let r=g(this.firestore,"users",e);return O(r,{idField:"id"}).pipe(p(i=>[i]))}else return y([])}getManageableUsers(){if(this.getCurrentUserRole()!=="admin")return y([]);let t=b(this.firestore,"users"),r=h(t,w("role","in",["user","client","staff","admin"]));return A(r,{idField:"id"}).pipe(p(i=>i.filter(s=>s.isVisible!==!1&&!s.deletedAt)))}isVisibleUser(e){return e?e.isVisible!==!1&&!e.deletedAt:!1}getVisibleAdminCount(e){return c(this,null,function*(){let t=b(this.firestore,"users"),r=h(t,w("role","==","admin")),i=yield V(r),s=0;return i.forEach(o=>{if(e&&o.id===e)return;let n=o.data();this.isVisibleUser(n)&&s++}),s})}updateUser(e,t){return c(this,null,function*(){let r=this.auth.userSig();try{this.assertAdminAction();let i=g(this.firestore,"users",e),s=yield U(i);if(!s.exists())throw new Error("Utente non trovato");let o=s.data(),n=String(o.role??""),f=t.role?String(t.role):null;if(r?.uid===e&&f&&f!==n)throw new Error("Non puoi cambiare il tuo ruolo");if(n==="admin"&&f&&f!=="admin"&&(yield this.getVisibleAdminCount())<=1)throw new Error("Impossibile rimuovere il ruolo all ultimo admin");yield S(i,t),this.audit.log({action:"user.update",resource:"user",resourceId:e,status:"success",actorId:r?.uid,actorRole:r?.role,targetUserId:e,meta:{changedKeys:Object.keys(t??{})}}),this.ui.success("Utente aggiornato")}catch(i){throw this.audit.log({action:"user.update",resource:"user",resourceId:e,status:"error",actorId:r?.uid,actorRole:r?.role,targetUserId:e,meta:{changedKeys:Object.keys(t??{})}}),this.ui.error(i?.message||"Errore aggiornamento utente"),i}})}deleteUser(e){return c(this,null,function*(){let t=this.auth.userSig();try{if(this.assertAdminAction(),t?.uid===e)throw new Error("Non puoi nascondere il tuo account");let r=g(this.firestore,"users",e),i=yield U(r);if(!i.exists())throw new Error("Utente non trovato");let s=i.data();if(String(s.role??"")==="admin"&&(yield this.getVisibleAdminCount())<=1)throw new Error("Impossibile nascondere l ultimo admin");yield S(r,{isVisible:!1,isActive:!1,deletedAt:R(),updatedAt:R()}),this.audit.log({action:"user.hide",resource:"user",resourceId:e,status:"success",actorId:t?.uid,actorRole:t?.role,targetUserId:e}),this.ui.warn("Utente nascosto")}catch(r){throw this.audit.log({action:"user.hide",resource:"user",resourceId:e,status:"error",actorId:t?.uid,actorRole:t?.role,targetUserId:e}),this.ui.error(r?.message||"Errore eliminazione utente"),r}})}static \u0275fac=function(t){return new(t||a)};static \u0275prov=v({token:a,factory:a.\u0275fac,providedIn:"root"})};export{N as a,q as b};
