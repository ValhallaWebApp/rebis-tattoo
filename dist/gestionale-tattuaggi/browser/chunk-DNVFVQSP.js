import{b as F}from"./chunk-4JQXIQDS.js";import{c as D,e as B}from"./chunk-EOWTFOEZ.js";import{cc as w,dc as O}from"./chunk-7AONPZHV.js";import{a as R}from"./chunk-3PBLYRJ4.js";import{Lb as d,Nb as f,c as S,h as A,i as h,na as o}from"./chunk-I2SBXG73.js";import{l as y}from"./chunk-VPSPPOSA.js";import{O as b,Ub as N,W as E,X as P,ta as C}from"./chunk-Y3XNR5LB.js";import{a as c,b as p,e as g}from"./chunk-ACKELEN3.js";function U(a){return typeof a=="object"&&a!==null}function H(){let a=globalThis.__APP_CONFIG__;return U(a)?a:{}}function M(a){let t=H();return p(c({},a),{paymentApiBaseUrl:t.paymentApiBaseUrl??a.paymentApiBaseUrl,stripePublishableKey:t.stripePublishableKey??a.stripePublishableKey,firebaseConfig:c(c({},a.firebaseConfig),t.firebaseConfig??{})})}var _={production:!0,environmentName:"production",paymentApiBaseUrl:"",firebaseConfig:{apiKey:"",authDomain:"",databaseURL:"",projectId:"",storageBucket:"",messagingSenderId:"",appId:"",measurementId:""},stripePublishableKey:""},v=M(_);var I=class a{constructor(t){this.http=t}baseUrl=v.paymentApiBaseUrl;requestTimeoutMs=15e3;createPaymentIntent(t){let e=this.validateCreatePayload(t);if(e)return b(()=>({message:e,status:400}));let n={amount:t.amount,bookingId:t.bookingId.trim(),currency:t.currency??"eur",description:t.description};return this.http.post(`${this.baseUrl}/create`,n).pipe(E(this.requestTimeoutMs),P(r=>this.mapCreatePaymentResponse(r)),N(({paymentIntentId:r})=>this.logDevPaymentIntent(r,n.bookingId)),C(r=>{let i=this.normalizeErrorMessage(r);return b(()=>({message:i,status:r?.status,original:r}))}))}createPaymentIntentSafe(t){return g(this,null,function*(){try{return{ok:!0,data:yield y(this.createPaymentIntent(t))}}catch(e){return{ok:!1,error:String(e?.message??"Errore creazione pagamento"),status:e?.status}}})}normalizeErrorMessage(t){if(!t)return"Errore di rete durante la richiesta pagamento.";if(t?.name==="TimeoutError")return"Timeout chiamata pagamento. Riprova.";let e=Number(t?.status??0);return e===0?"Backend pagamenti non raggiungibile.":e===400?t?.error?.error||"Dati pagamento non validi.":e===401||e===403?"Non autorizzato alla creazione pagamento.":e>=500?"Errore interno del backend pagamenti.":t?.error?.error||t?.message||"Errore pagamento non previsto."}validateCreatePayload(t){if(!t)return"Payload pagamento mancante.";let e=Number(t.amount);if(!Number.isInteger(e)||e<=0)return"Importo pagamento non valido.";if(!t.bookingId||!t.bookingId.trim())return"bookingId obbligatorio.";let n=String(t.currency??"eur").trim().toLowerCase();return["eur","usd","gbp"].includes(n)?null:"Valuta non supportata."}mapCreatePaymentResponse(t){if(!t?.success||!t?.clientSecret||!t?.paymentIntentId)throw{message:"Risposta backend pagamenti non valida.",status:502};return{clientSecret:t.clientSecret,paymentIntentId:t.paymentIntentId}}logDevPaymentIntent(t,e){v.production||console.debug("[payments] paymentIntent created",{paymentIntentId:t,bookingId:e})}static \u0275fac=function(e){return new(e||a)(A(R))};static \u0275prov=S({token:a,factory:a.\u0275fac,providedIn:"root"})};var x=class a{staffService=h(O);bookingService=h(B);userService=h(F);paymentApi=h(I);auth=h(D);ui=h(w);HOME_SEED_KEY="FAST_BOOKING_HOME_SEED";steps=["intro","artist","when","details","summary","payment","success"];step=o("intro");depositEuro=o(50);durationMin=o(60);artists=o([]);loadingArtists=o(!1);selectedDate=o(null);slots=o([]);loadingSlots=o(!1);bookingId=o(null);paymentClientSecret=o(null);paymentIntentId=o(null);paying=o(!1);confirmingPayment=o(!1);error=o(null);draft=o({artistId:null,artistName:null,date:null,time:null,name:null,contact:null,description:null});constructor(){f(()=>{let t=this.auth.userSig();if(!t)return;let e=t.name??t.displayName??null,n=t.email??null,r=t.phone??t.phoneNumber??null,i=n??r??null;this.draft.update(m=>{let s=c({},m);return(!s.name||String(s.name).trim()==="")&&(s.name=e),(!s.contact||String(s.contact).trim()==="")&&(s.contact=i),s})},{allowSignalWrites:!0}),f(()=>{let t=this.artists(),e=this.draft(),n=e.artistId;if(!n||!t?.length)return;let r=t.find(s=>s.id===n);if(!r)return;let i=r.name??null;(e.artistName??null)!==i&&this.draft.update(s=>p(c({},s),{artistName:i}))},{allowSignalWrites:!0}),f(()=>{this.step()==="artist"&&this.artists().length===0&&queueMicrotask(()=>this.fetchArtists())}),f(()=>{let t=this.step(),e=this.draft(),n=this.selectedDate();t==="when"&&e.artistId&&n&&queueMicrotask(()=>this.fetchSlots(e.artistId,n))}),queueMicrotask(()=>this.hydrateFromHomeSeed())}stepIndex=d(()=>this.steps.indexOf(this.step()));progress=d(()=>(this.stepIndex()+1)/this.steps.length*100);canBack=d(()=>this.stepIndex()>0&&this.step()!=="success");canNext=d(()=>{let t=this.step(),e=this.draft();return t==="artist"?!!e.artistId:t==="when"?!!e.date&&!!e.time:t==="details"?!!e.name&&!!e.contact&&!!e.description:t!=="payment"});isUserLogged=d(()=>!!this.auth.userSig());isNameLocked=d(()=>{let t=this.auth.userSig(),e=this.draft().name;return!!t&&!!e&&String(e).trim().length>0});isContactLocked=d(()=>{let t=this.auth.userSig(),e=this.draft().contact;return!!t&&!!e&&String(e).trim().length>0});back(){this.error.set(null),!(this.stepIndex()<=0)&&this.step.set(this.steps[this.stepIndex()-1])}next(){this.error.set(null),!(this.stepIndex()>=this.steps.length-1)&&this.step.set(this.steps[this.stepIndex()+1])}go(t){this.error.set(null),this.step.set(t)}setArtist(t){this.draft.update(e=>p(c({},e),{artistId:t.id??null,artistName:t.name??null})),this.selectedDate.set(null),this.slots.set([]),this.setWhen(null,null)}setDate(t){this.selectedDate.set(t),this.draft.update(e=>p(c({},e),{date:t,time:null}))}setWhen(t,e){this.draft.update(n=>p(c({},n),{date:t,time:e}))}setDetails(t){this.draft.update(e=>p(c({},e),{name:t.name,contact:t.contact,description:t.description}))}fetchArtists(){return g(this,null,function*(){try{this.loadingArtists.set(!0);let e=((yield y(this.staffService.getAllStaff()))??[]).filter(n=>(n.isActive??!0)===!0).filter(n=>n.role==="tatuatore").sort((n,r)=>(n.name||"").localeCompare(r.name||""));this.artists.set(e)}catch(t){console.error(t),this.error.set("Impossibile caricare gli artisti. Riprova.")}finally{this.loadingArtists.set(!1)}})}fetchSlots(t,e){return g(this,null,function*(){try{this.loadingSlots.set(!0),this.error.set(null);let n=this.durationMin(),r=yield this.bookingService.getFreeSlotsInDay(t,e,n);this.slots.set(r??[])}catch(n){console.error("[FAST_BOOKING][SLOTS] ERROR",n),this.slots.set([]),this.error.set("Impossibile caricare gli orari disponibili per questo giorno.")}finally{this.loadingSlots.set(!1)}})}startPayment(){return g(this,null,function*(){try{if(this.paying()||this.paymentClientSecret())return;this.error.set(null),this.paying.set(!0);let t=this.draft(),e=this.userService.getCurrentUserId();if(!e){this.error.set("Per procedere serve il login (utente non autenticato).");return}if(!t.artistId||!t.date||!t.time){this.error.set("Seleziona artista, data e ora prima di pagare.");return}if(!t.name||!t.contact||!t.description){this.error.set("Completa i dati (nome, contatto, descrizione) prima di pagare.");return}let n={artistId:t.artistId,date:t.date,time:t.time,duration:this.durationMin(),note:t.description},r=yield this.bookingService.addDraftFromChatSafe(n,{idClient:e,clientName:t.name,source:"fast-booking"});if(!r.ok){this.error.set(r.error),this.ui.error(r.error);return}let i=r.data;this.bookingId.set(i);let m=Math.round(this.depositEuro()*100),s=yield this.paymentApi.createPaymentIntentSafe({amount:m,currency:"eur",description:`Caparra consulenza Rebis Tattoo - booking ${i}`,bookingId:i});if(!s.ok){yield this.bookingService.safeSetStatusSafe(i,"pending",{updatedAt:new Date().toISOString(),notes:`${t.description??""}
[payment-init-failed] ${s.error}`.trim()}),this.error.set(s.error),this.ui.error(s.error);return}this.paymentClientSecret.set(s.data.clientSecret),this.paymentIntentId.set(s.data.paymentIntentId),this.ui.success("Pagamento inizializzato correttamente.")}catch(t){console.error(t);let e=String(t?.message??"Errore durante la creazione del pagamento. Riprova.");this.error.set(e),this.ui.error(e)}finally{this.paying.set(!1)}})}confirmPaymentSuccess(){return g(this,null,function*(){if(!this.confirmingPayment())try{this.confirmingPayment.set(!0);let t=this.bookingId();if(!t){this.error.set("Booking non trovato.");return}let e=this.depositEuro(),n=yield this.bookingService.getBookingById(t);if(!n){this.error.set("Booking non trovato."),this.ui.error("Booking non trovato.");return}if(n.status==="paid"){this.go("success");return}if(n.status==="cancelled"||n.status==="completed"||n.status==="no_show"){let i=`Stato booking non valido per conferma pagamento: ${n.status}`;this.error.set(i),this.ui.error(i);return}if(n.status==="draft"||n.status==="pending"){let i=yield this.bookingService.safeSetStatusSafe(t,"confirmed");if(!i.ok){this.error.set(i.error),this.ui.error(i.error);return}}let r=yield this.bookingService.safeSetStatusSafe(t,"paid",{paidAmount:e,price:e,updatedAt:new Date().toISOString()});if(!r.ok){if((yield this.bookingService.getBookingById(t))?.status==="paid"){this.go("success");return}this.error.set(r.error),this.ui.error(r.error);return}this.go("success"),this.ui.success("Pagamento registrato con successo.")}catch(t){console.error(t);let e="Pagamento registrato? Non riesco ad aggiornare lo stato booking.";this.error.set(e),this.ui.error(e)}finally{this.confirmingPayment.set(!1)}})}resetAll(){this.error.set(null),this.bookingId.set(null),this.paymentClientSecret.set(null),this.paymentIntentId.set(null),this.selectedDate.set(null),this.slots.set([]);let t=this.auth.userSig(),e=t?t.name??t.displayName??null:null,n=t?t.email??null:null,r=t?t.phone??t.phoneNumber??null:null,i=t?n??r??null:null;this.draft.set({artistId:null,artistName:null,date:null,time:null,name:e,contact:i,description:null});try{sessionStorage.removeItem(this.HOME_SEED_KEY)}catch{}try{localStorage.removeItem(this.HOME_SEED_KEY)}catch{}this.step.set("intro")}seedFromHome(t){let e=t.artist??null,n=t.email&&t.email.trim()?t.email.trim():t.phone&&t.phone.trim()?t.phone.trim():null,r=t.fullName&&t.fullName.trim()?t.fullName.trim():null,i=t.procedure?.trim(),m=t.comments?.trim(),s=[i?`Procedura: ${i}`:null,m||null].filter(Boolean).join(`

`)||null;this.draft.update(l=>p(c({},l),{artistId:e,artistName:l.artistName,date:null,time:null,name:l.name&&String(l.name).trim()?l.name:r,contact:l.contact&&String(l.contact).trim()?l.contact:n,description:l.description&&String(l.description).trim()?l.description:s})),this.selectedDate.set(null),this.slots.set([]),this.step.set(e?"when":"artist");try{sessionStorage.setItem(this.HOME_SEED_KEY,JSON.stringify(t))}catch{}}hydrateFromHomeSeed(){try{let t=sessionStorage.getItem(this.HOME_SEED_KEY)||localStorage.getItem(this.HOME_SEED_KEY);if(!t)return;let e=JSON.parse(t);this.seedFromHome(e),localStorage.removeItem(this.HOME_SEED_KEY)}catch{}}applyHomeSeed(t,e){let n=e?.overwrite===!0,r=t.artist??null,i=t.fullName&&t.fullName.trim()?t.fullName.trim():null,m=t.email&&t.email.trim()?t.email.trim():t.phone&&t.phone.trim()?t.phone.trim():null,s=t.procedure?.trim()||null,l=t.comments?.trim()||null,k=[s?`Procedura: ${s}`:null,l].filter(Boolean).join(`

`)||null;this.draft.update(u=>p(c({},u),{artistId:n?r:u.artistId??r,artistName:u.artistName??null,name:n?i:u.name&&String(u.name).trim()?u.name:i,contact:n?m:u.contact&&String(u.contact).trim()?u.contact:m,description:n?k:u.description&&String(u.description).trim()?u.description:k}))}static \u0275fac=function(e){return new(e||a)};static \u0275prov=S({token:a,factory:a.\u0275fac,providedIn:"root"})};export{v as a,x as b};
