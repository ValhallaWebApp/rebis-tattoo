import{b as O}from"./chunk-7ET3CLKX.js";import{p as k,r as H}from"./chunk-RUQCNMPL.js";import{b as N,zc as D}from"./chunk-E5ZACFZL.js";import{Mb as p,Ob as g,c as y,h as E,i as d,na as s}from"./chunk-ZWDWJLXC.js";import{l as I}from"./chunk-VPSPPOSA.js";import{X as b}from"./chunk-Y3XNR5LB.js";import{a as m,b as u,e as f}from"./chunk-ACKELEN3.js";var S=class h{constructor(t){this.http=t}baseUrl="http://localhost:3000/api/payments";createPaymentIntent(t){return this.http.post(`${this.baseUrl}/create`,t).pipe(b(e=>({clientSecret:e.clientSecret,paymentIntentId:e.paymentIntentId})))}static \u0275fac=function(e){return new(e||h)(E(N))};static \u0275prov=y({token:h,factory:h.\u0275fac,providedIn:"root"})};var w=class h{staffService=d(D);bookingService=d(H);userService=d(O);paymentApi=d(S);auth=d(k);HOME_SEED_KEY="FAST_BOOKING_HOME_SEED";steps=["intro","artist","when","details","summary","payment","success"];step=s("intro");depositEuro=s(50);durationMin=s(60);artists=s([]);loadingArtists=s(!1);selectedDate=s(null);slots=s([]);loadingSlots=s(!1);bookingId=s(null);paymentClientSecret=s(null);paymentIntentId=s(null);paying=s(!1);error=s(null);draft=s({artistId:null,artistName:null,date:null,time:null,name:null,contact:null,description:null});constructor(){g(()=>{let t=this.auth.userSig();if(!t)return;let e=t.name??t.displayName??null,n=t.email??null,r=t.phone??t.phoneNumber??null,a=n??r??null;this.draft.update(c=>{let i=m({},c);return(!i.name||String(i.name).trim()==="")&&(i.name=e),(!i.contact||String(i.contact).trim()==="")&&(i.contact=a),i})},{allowSignalWrites:!0}),g(()=>{let t=this.artists(),e=this.draft(),n=e.artistId;if(!n||!t?.length)return;let r=t.find(i=>i.id===n);if(!r)return;let a=r.name??null;(e.artistName??null)!==a&&this.draft.update(i=>u(m({},i),{artistName:a}))},{allowSignalWrites:!0}),g(()=>{this.step()==="artist"&&this.artists().length===0&&queueMicrotask(()=>this.fetchArtists())}),g(()=>{let t=this.step(),e=this.draft(),n=this.selectedDate();t==="when"&&e.artistId&&n&&queueMicrotask(()=>this.fetchSlots(e.artistId,n))}),queueMicrotask(()=>this.hydrateFromHomeSeed())}stepIndex=p(()=>this.steps.indexOf(this.step()));progress=p(()=>(this.stepIndex()+1)/this.steps.length*100);canBack=p(()=>this.stepIndex()>0&&this.step()!=="success");canNext=p(()=>{let t=this.step(),e=this.draft();return t==="artist"?!!e.artistId:t==="when"?!!e.date&&!!e.time:t==="details"?!!e.name&&!!e.contact&&!!e.description:t!=="payment"});isUserLogged=p(()=>!!this.auth.userSig());isNameLocked=p(()=>{let t=this.auth.userSig(),e=this.draft().name;return!!t&&!!e&&String(e).trim().length>0});isContactLocked=p(()=>{let t=this.auth.userSig(),e=this.draft().contact;return!!t&&!!e&&String(e).trim().length>0});back(){this.error.set(null),!(this.stepIndex()<=0)&&this.step.set(this.steps[this.stepIndex()-1])}next(){this.error.set(null),!(this.stepIndex()>=this.steps.length-1)&&this.step.set(this.steps[this.stepIndex()+1])}go(t){this.error.set(null),this.step.set(t)}setArtist(t){this.draft.update(e=>u(m({},e),{artistId:t.id??null,artistName:t.name??null})),this.selectedDate.set(null),this.slots.set([]),this.setWhen(null,null)}setDate(t){this.selectedDate.set(t),this.draft.update(e=>u(m({},e),{date:t,time:null}))}setWhen(t,e){this.draft.update(n=>u(m({},n),{date:t,time:e}))}setDetails(t){this.draft.update(e=>u(m({},e),{name:t.name,contact:t.contact,description:t.description}))}fetchArtists(){return f(this,null,function*(){try{this.loadingArtists.set(!0);let e=((yield I(this.staffService.getAllStaff()))??[]).filter(n=>(n.isActive??!0)===!0).filter(n=>n.role==="tatuatore").sort((n,r)=>(n.name||"").localeCompare(r.name||""));this.artists.set(e)}catch(t){console.error(t),this.error.set("Impossibile caricare gli artisti. Riprova.")}finally{this.loadingArtists.set(!1)}})}fetchSlots(t,e){return f(this,null,function*(){try{this.loadingSlots.set(!0),this.error.set(null);let n=this.durationMin(),r=yield this.bookingService.getFreeSlotsInDay(t,e,n);this.slots.set(r??[])}catch(n){console.error("[FAST_BOOKING][SLOTS] ERROR",n),this.slots.set([]),this.error.set("Impossibile caricare gli orari disponibili per questo giorno.")}finally{this.loadingSlots.set(!1)}})}startPayment(){return f(this,null,function*(){try{this.error.set(null),this.paying.set(!0);let t=this.draft(),e=this.userService.getCurrentUserId();if(!e){this.error.set("Per procedere serve il login (utente non autenticato).");return}if(!t.artistId||!t.date||!t.time){this.error.set("Seleziona artista, data e ora prima di pagare.");return}if(!t.name||!t.contact||!t.description){this.error.set("Completa i dati (nome, contatto, descrizione) prima di pagare.");return}let n={artistId:t.artistId,date:t.date,time:t.time,duration:this.durationMin(),note:t.description},r=yield this.bookingService.addDraftFromChat(n,{idClient:e,clientName:t.name});this.bookingId.set(r);let a=Math.round(this.depositEuro()*100),c=yield I(this.paymentApi.createPaymentIntent({amount:a,currency:"eur",description:`Caparra consulenza Rebis Tattoo - booking ${r}`}));this.paymentClientSecret.set(c.clientSecret),this.paymentIntentId.set(c.paymentIntentId)}catch(t){console.error(t),this.error.set("Errore durante la creazione del pagamento. Riprova.")}finally{this.paying.set(!1)}})}confirmPaymentSuccess(){return f(this,null,function*(){try{let t=this.bookingId();if(!t){this.error.set("Booking non trovato.");return}let e=this.depositEuro();yield this.bookingService.safeSetStatus(t,"paid",{paidAmount:e,price:e,updateAt:new Date().toISOString()}),this.go("success")}catch(t){console.error(t),this.error.set("Pagamento registrato? Non riesco ad aggiornare lo stato booking.")}})}resetAll(){this.error.set(null),this.bookingId.set(null),this.paymentClientSecret.set(null),this.paymentIntentId.set(null),this.selectedDate.set(null),this.slots.set([]);let t=this.auth.userSig(),e=t?t.name??t.displayName??null:null,n=t?t.email??null:null,r=t?t.phone??t.phoneNumber??null:null,a=t?n??r??null:null;this.draft.set({artistId:null,artistName:null,date:null,time:null,name:e,contact:a,description:null});try{sessionStorage.removeItem(this.HOME_SEED_KEY)}catch{}try{localStorage.removeItem(this.HOME_SEED_KEY)}catch{}this.step.set("intro")}seedFromHome(t){let e=t.artist??null,n=t.email&&t.email.trim()?t.email.trim():t.phone&&t.phone.trim()?t.phone.trim():null,r=t.fullName&&t.fullName.trim()?t.fullName.trim():null,a=t.procedure?.trim(),c=t.comments?.trim(),i=[a?`Procedura: ${a}`:null,c||null].filter(Boolean).join(`

`)||null;this.draft.update(o=>u(m({},o),{artistId:e,artistName:o.artistName,date:null,time:null,name:o.name&&String(o.name).trim()?o.name:r,contact:o.contact&&String(o.contact).trim()?o.contact:n,description:o.description&&String(o.description).trim()?o.description:i})),this.selectedDate.set(null),this.slots.set([]),this.step.set(e?"when":"artist");try{sessionStorage.setItem(this.HOME_SEED_KEY,JSON.stringify(t))}catch{}}hydrateFromHomeSeed(){try{let t=sessionStorage.getItem(this.HOME_SEED_KEY)||localStorage.getItem(this.HOME_SEED_KEY);if(!t)return;let e=JSON.parse(t);this.seedFromHome(e),localStorage.removeItem(this.HOME_SEED_KEY)}catch{}}applyHomeSeed(t,e){let n=e?.overwrite===!0,r=t.artist??null,a=t.fullName&&t.fullName.trim()?t.fullName.trim():null,c=t.email&&t.email.trim()?t.email.trim():t.phone&&t.phone.trim()?t.phone.trim():null,i=t.procedure?.trim()||null,o=t.comments?.trim()||null,v=[i?`Procedura: ${i}`:null,o].filter(Boolean).join(`

`)||null;this.draft.update(l=>u(m({},l),{artistId:n?r:l.artistId??r,artistName:l.artistName??null,name:n?a:l.name&&String(l.name).trim()?l.name:a,contact:n?c:l.contact&&String(l.contact).trim()?l.contact:c,description:n?v:l.description&&String(l.description).trim()?l.description:v}))}static \u0275fac=function(e){return new(e||h)};static \u0275prov=y({token:h,factory:h.\u0275fac,providedIn:"root"})};export{w as a};
