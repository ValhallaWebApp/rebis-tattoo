import{b as E,c as U,d as j}from"./chunk-ALIQDRXJ.js";import{a as H}from"./chunk-Q5BBUC7E.js";import{A as S,B as v,D as h,E as x,F as y,G as P,H as c,I as O,J as C,L as w,dc as Q,j as W,n as T,q as _,s as V,w as K,x as $}from"./chunk-VVGPL6SB.js";import{c as I,h as p}from"./chunk-I2SBXG73.js";import{N,k as m}from"./chunk-Y3XNR5LB.js";import{a as f,b as M,e as l}from"./chunk-ACKELEN3.js";var J=class b{constructor(e){this.db=e}path="reviews";addReview(e){let t=y(c(this.db,this.path));return C(t,M(f({},e),{id:t.key}))}deleteReview(e){return O(c(this.db,`${this.path}/${e}`))}updateReview(e,t){return w(c(this.db,`${this.path}/${e}`),t)}getAllReviews(){return new m(e=>{let t=c(this.db,this.path),s=h(t,r=>{let i=r.val(),a=i?Object.keys(i).map(n=>f({id:n},i[n])):[];e.next(a)},r=>e.error(r));return()=>s()})}getRecentReviews(e=5){return new m(t=>{let s=c(this.db,this.path),r=h(s,i=>{let a=i.val(),n=[];a&&(n=Object.entries(a).map(([o,d])=>f({id:o},d)).sort((o,d)=>new Date(d.date).getTime()-new Date(o.date).getTime()).slice(0,e)),t.next(n)},i=>t.error(i));return()=>r()})}getReviewById(e){return v(c(this.db,`${this.path}/${e}`)).then(t=>t.exists()?f({id:e},t.val()):null)}getReviewsByUser(e){return new m(t=>{let s=P(c(this.db,this.path),x("userId"),S(e)),r=h(s,i=>{let a=i.val(),n=a?Object.entries(a).map(([o,d])=>f({id:o},d)):[];t.next(n)},i=>t.error(i));return()=>r()})}getReviewsByBookingId(e){return new m(t=>{let s=P(c(this.db,this.path),x("bookingId"),S(e)),r=h(s,i=>{let a=i.val(),n=a?Object.entries(a).map(([o,d])=>f({id:o},d)):[];t.next(n)},i=>t.error(i));return()=>r()})}getReviewsByArtist(e){return new m(t=>{let s=c(this.db,this.path),r=h(s,i=>{let a=i.val(),n=a?Object.entries(a).map(([o,d])=>f({id:o},d)).filter(o=>o.artistId===e&&o.status==="approved"):[];t.next(n)},i=>t.error(i));return()=>r()})}checkIfAlreadyReviewed(e,t){return l(this,null,function*(){let s=yield v(c(this.db,this.path));return s.exists()?Object.values(s.val()).some(i=>i.bookingId===e&&i.userId===t):!1})}static \u0275fac=function(t){return new(t||b)(p($))};static \u0275prov=I({token:b,factory:b.\u0275fac,providedIn:"root"})};var X=class b{constructor(e){this.db=e}path="invoices";getInvoices(){return new m(e=>{let t=c(this.db,this.path),s=h(t,r=>{let i=r.val(),a=i?Object.entries(i).map(([n,o])=>f({id:n},o)):[];e.next(a)},r=>e.error(r));return()=>s()})}getInvoicesByClient(e){return new m(t=>{let s=P(c(this.db,this.path),x("clientId"),S(e)),r=h(s,i=>{let a=i.val(),n=a?Object.entries(a).map(([o,d])=>f({id:o},d)):[];t.next(n)},i=>t.error(i));return()=>r()})}getInvoiceById(e){return l(this,null,function*(){let t=yield v(c(this.db,`${this.path}/${e}`));return t.exists()?f({id:e},t.val()):null})}addInvoice(e){let t=y(c(this.db,this.path)),s=new Date().toISOString();return C(t,M(f({},e),{bookingId:t.key,createdAt:s,updatedAt:s}))}updateInvoice(e,t){return w(c(this.db,`${this.path}/${e}`),M(f({},t),{updatedAt:new Date().toISOString()}))}deleteInvoice(e){return O(c(this.db,`${this.path}/${e}`))}getTotalRevenue(){return new m(e=>{let t=c(this.db,this.path),s=h(t,r=>{let i=r.val(),a=0;i&&Object.values(i).forEach(n=>{n.status==="paid"&&typeof n.amount=="number"&&(a+=n.amount)}),e.next(a)},r=>e.error(r));return()=>s()})}static \u0275fac=function(t){return new(t||b)(p($))};static \u0275prov=I({token:b,factory:b.\u0275fac,providedIn:"root"})};var Y=class b{constructor(e,t,s,r,i){this.db=e;this.firestore=t;this.notifications=s;this.audit=r;this.auth=i}conversationsPath="conversations";messagesPath="conversationMessages";userConversationsPath="userConversations";roleOf(e,t){return t.participants?.[e]}isAdminLike(e){return e==="admin"||e==="staff"}canStaffAccessConversation(e,t){return!!this.roleOf(e,t)}streamConversationsForUser(e){return e?new m(t=>{let s=c(this.db,`${this.userConversationsPath}/${e}`),r=h(s,i=>l(this,null,function*(){if(!i.exists()){t.next([]);return}let a=i.val(),n=Object.keys(a),d=(yield Promise.all(n.map(u=>l(this,null,function*(){let g=yield v(c(this.db,`${this.conversationsPath}/${u}`));return g.exists()?this.toConversation(u,g.val()):null})))).filter(u=>!!u).sort((u,g)=>(g.lastMessageAt??g.updatedAt).localeCompare(u.lastMessageAt??u.updatedAt));t.next(d)}),i=>t.error(i));return()=>r()}):new m(t=>t.next([]))}streamAllConversations(){let e=this.auth.userSig(),t=e?.uid??"",s=e?.role??"guest";return this.isAdminLike(s)?new m(r=>{let i=c(this.db,this.conversationsPath),a=h(i,n=>{if(!n.exists()){r.next([]);return}let o=n.val(),d=Object.entries(o).map(([u,g])=>this.toConversation(u,g)).sort((u,g)=>(g.lastMessageAt??g.updatedAt).localeCompare(u.lastMessageAt??u.updatedAt));s==="staff"&&(d=d.filter(u=>this.canStaffAccessConversation(t,u))),r.next(d)},n=>r.error(n));return()=>a()}):new m(r=>{r.next([]),r.complete()})}streamMessages(e){return e?new m(t=>{let s=c(this.db,`${this.messagesPath}/${e}`),r=h(s,i=>{if(!i.exists()){t.next([]);return}let a=i.val(),n=Object.entries(a).map(([o,d])=>this.toMessage(o,e,d)).sort((o,d)=>o.createdAt.localeCompare(d.createdAt));t.next(n)},i=>t.error(i));return()=>r()}):new m(t=>t.next([]))}createConversationForClient(e,t="Conversazione con studio"){return l(this,null,function*(){let s=this.auth.userSig(),r=new Date().toISOString(),i=y(c(this.db,this.conversationsPath)),a=i.key,n=yield this.getAdminLikeUsers(),o={[e]:"client"};n.forEach(u=>{o[u.id]=u.role});let d={id:a,summary:t,status:"open",createdAt:r,updatedAt:r,createdBy:s?.uid??e,participants:o,unreadBy:{}};return yield C(i,d),yield this.touchParticipants(a,Object.keys(o),r),this.audit.log({action:"messaging.conversation.create",resource:"conversation",resourceId:a,status:"success",actorId:s?.uid??e,actorRole:s?.role,targetUserId:e,meta:{participants:Object.keys(o).length}}),a})}sendMessage(e){return l(this,null,function*(){let{conversationId:t,senderId:s,senderRole:r,text:i}=e,a=e.kind??"text",n=String(i??"").trim();if(!t||!s||!n)return;let o=new Date().toISOString(),d=c(this.db,`${this.conversationsPath}/${t}`),u=yield v(d);if(!u.exists())throw new Error("Conversazione non trovata");let g=this.toConversation(t,u.val()),R=!!this.roleOf(s,g),k=r==="admin",tt=r==="staff";if(!k&&!R)throw new Error("Utente non autorizzato a scrivere in questa conversazione");if(tt&&!R)throw new Error("Staff non assegnato a questa conversazione");let B=Object.keys(g.participants??{}),D=f({},g.unreadBy??{});B.forEach(A=>{A===s?D[A]=0:D[A]=Number(D[A]??0)+1});let F=y(c(this.db,`${this.messagesPath}/${t}`)),et={id:F.key,conversationId:t,senderId:s,senderRole:r,text:n,kind:a,createdAt:o};yield C(F,et),yield w(d,{updatedAt:o,status:g.status==="closed"?"open":g.status,lastMessageAt:o,lastMessageBy:s,lastMessageText:n.slice(0,180),unreadBy:D}),yield this.touchParticipants(t,B,o);let q=B.filter(A=>A!==s);yield Promise.allSettled(q.map(A=>{let G=g.participants?.[A],rt=G==="admin"||G==="staff"?"/admin/messaging":"/dashboard/chat";return this.notifications.createForUser(A,{type:"chat",title:"Nuovo messaggio",message:n.length>90?`${n.slice(0,87)}...`:n,link:rt,meta:{conversationId:t,senderId:s}})})),this.audit.log({action:"messaging.message.send",resource:"conversation",resourceId:t,status:"success",actorId:s,actorRole:r,meta:{kind:a,recipients:q.length}})})}setConversationStatus(e,t,s,r){return l(this,null,function*(){let i=yield v(c(this.db,`${this.conversationsPath}/${e}`));if(!i.exists())throw new Error("Conversazione non trovata");let a=this.toConversation(e,i.val()),n=this.auth.userSig(),o=r??n?.role??"guest";if(!this.isAdminLike(o))throw new Error("Solo admin o staff possono cambiare stato conversazione");if(o==="staff"&&!this.canStaffAccessConversation(s,a))throw new Error("Staff non assegnato a questa conversazione");let d=new Date().toISOString();yield w(c(this.db,`${this.conversationsPath}/${e}`),{status:t,updatedAt:d}),yield this.touchParticipants(e,Object.keys(a.participants??{}),d),this.audit.log({action:"messaging.conversation.status",resource:"conversation",resourceId:e,status:"success",actorId:s,actorRole:r,meta:{status:t}})})}markAsRead(e,t){return l(this,null,function*(){if(!e||!t)return;let s=yield v(c(this.db,`${this.conversationsPath}/${e}`));if(!s.exists())return;let r=this.toConversation(e,s.val()),i=this.auth.userSig(),a=i?.role??"guest",n=i?.uid??t;if(!(this.isAdminLike(a)||!!this.roleOf(n,r)))throw new Error("Non autorizzato");if(!this.isAdminLike(a)&&n!==t)throw new Error("Non autorizzato");let d=new Date().toISOString();yield w(c(this.db,`${this.conversationsPath}/${e}/unreadBy`),{[t]:0}),yield C(c(this.db,`${this.userConversationsPath}/${t}/${e}`),d)})}archiveConversationForUser(e,t){return l(this,null,function*(){if(!e||!t)return;let s=yield v(c(this.db,`${this.conversationsPath}/${e}`));if(!s.exists())return;let r=this.toConversation(e,s.val()),i=this.auth.userSig(),a=i?.role??"guest",n=i?.uid??t;if(!this.isAdminLike(a)&&n!==t)throw new Error("Non autorizzato");if(!this.isAdminLike(a)&&!this.roleOf(t,r))throw new Error("Non autorizzato");if(a==="staff"&&!this.canStaffAccessConversation(n,r))throw new Error("Staff non assegnato a questa conversazione");yield O(c(this.db,`${this.userConversationsPath}/${t}/${e}`)),this.audit.log({action:"messaging.conversation.archive",resource:"conversation",resourceId:e,status:"success",actorId:i?.uid??t,actorRole:i?.role})})}touchParticipants(e,t,s){return l(this,null,function*(){yield Promise.all(t.map(r=>C(c(this.db,`${this.userConversationsPath}/${r}/${e}`),s)))})}getAdminLikeUsers(){return l(this,null,function*(){let e=T(this.firestore,"users"),t=V(e,K("role","in",["admin","staff"]));return(yield _(t)).docs.map(r=>{let i=String(r.data().role??"admin");return{id:r.id,role:i==="staff"?"staff":"admin"}})})}toConversation(e,t){return{id:e,summary:String(t?.summary??"Conversazione"),status:t?.status==="closed"?"closed":"open",createdAt:String(t?.createdAt??new Date(0).toISOString()),updatedAt:String(t?.updatedAt??t?.createdAt??new Date(0).toISOString()),createdBy:String(t?.createdBy??""),participants:t?.participants??{},lastMessageText:t?.lastMessageText?String(t.lastMessageText):void 0,lastMessageAt:t?.lastMessageAt?String(t.lastMessageAt):void 0,lastMessageBy:t?.lastMessageBy?String(t.lastMessageBy):void 0,unreadBy:t?.unreadBy??{}}}toMessage(e,t,s){return{id:e,conversationId:t,senderId:String(s?.senderId??""),senderRole:s?.senderRole??"client",text:String(s?.text??""),kind:s?.kind??"text",createdAt:String(s?.createdAt??new Date(0).toISOString())}}static \u0275fac=function(t){return new(t||b)(p($),p(W),p(j),p(E),p(U))};static \u0275prov=I({token:b,factory:b.\u0275fac,providedIn:"root"})};var Z=class b{constructor(e,t,s,r,i,a){this.db=e;this.auth=t;this.ui=s;this.audit=r;this.notifications=i;this.lang=a}path="bonus";streamPromoCodes(){return new m(e=>{let t=c(this.db,`${this.path}/promoCodes`),s=h(t,r=>{if(!r.exists()){e.next([]);return}let i=r.val(),a=Object.entries(i).map(([n,o])=>this.toPromo(n,o)).sort((n,o)=>o.createdAt.localeCompare(n.createdAt));e.next(a)},r=>e.error(r));return()=>s()})}streamGiftCards(){return new m(e=>{let t=c(this.db,`${this.path}/giftCards`),s=h(t,r=>{if(!r.exists()){e.next([]);return}let i=r.val(),a=Object.entries(i).map(([n,o])=>this.toGiftCard(n,o)).sort((n,o)=>o.createdAt.localeCompare(n.createdAt));e.next(a)},r=>e.error(r));return()=>s()})}streamWallet(e){return e?new m(t=>{let s=c(this.db,`${this.path}/wallets/${e}`),r=h(s,i=>{if(!i.exists()){t.next({userId:e,balance:0,updatedAt:new Date(0).toISOString()});return}t.next(this.toWallet(e,i.val()))},i=>t.error(i));return()=>r()}):N({userId:"",balance:0,updatedAt:new Date(0).toISOString()})}streamWalletLedger(e,t=50){return e?new m(s=>{let r=c(this.db,`${this.path}/ledger/${e}`),i=h(r,a=>{if(!a.exists()){s.next([]);return}let n=a.val(),o=Object.entries(n).map(([d,u])=>this.toLedger(d,e,u)).sort((d,u)=>u.at.localeCompare(d.at)).slice(0,t);s.next(o)},a=>s.error(a));return()=>i()}):N([])}createPromoCode(e){return l(this,null,function*(){let t=yield this.requireManager(),s=new Date().toISOString(),r=Number(e.creditAmount||0);if(!Number.isFinite(r)||r<=0)throw new Error(this.t("bonus.service.errors.invalidPromoAmount"));let i=this.normalizeCode(e.code||this.randomCode("PROMO"));yield this.ensureCodeNotUsed("promoCodes",i);let a=y(c(this.db,`${this.path}/promoCodes`)),n=a.key??`${Date.now()}`,o={id:n,code:i,creditAmount:Math.round(r*100)/100,description:e.description?.trim()||void 0,active:!0,maxUses:e.maxUses&&e.maxUses>0?Math.floor(e.maxUses):null,usedCount:0,expiresAt:this.normalizeDate(e.expiresAt),createdAt:s,updatedAt:s,createdBy:t.uid};try{return yield C(a,this.stripUndef(o)),this.ui.success(this.t("bonus.service.feedback.promoCreated",{code:o.code})),this.audit.log({action:"bonus.promo.create",resource:"bonus_promo",resourceId:o.id,actorId:t.uid,actorRole:t.role,status:"success",meta:{code:o.code,creditAmount:o.creditAmount}}),o}catch(d){throw this.audit.log({action:"bonus.promo.create",resource:"bonus_promo",resourceId:n,actorId:t.uid,actorRole:t.role,status:"error",message:String(d?.message??d)}),this.ui.error(this.t("bonus.service.feedback.promoCreateError")),d}})}setPromoActive(e,t){return l(this,null,function*(){let s=yield this.requireManager();try{yield w(c(this.db,`${this.path}/promoCodes/${e}`),{active:t,updatedAt:new Date().toISOString()}),this.ui.info(t?this.t("bonus.service.feedback.promoEnabled"):this.t("bonus.service.feedback.promoDisabled")),this.audit.log({action:"bonus.promo.toggle",resource:"bonus_promo",resourceId:e,actorId:s.uid,actorRole:s.role,status:"success",meta:{active:t}})}catch(r){throw this.audit.log({action:"bonus.promo.toggle",resource:"bonus_promo",resourceId:e,actorId:s.uid,actorRole:s.role,status:"error",message:String(r?.message??r),meta:{active:t}}),this.ui.error(this.t("bonus.service.feedback.promoUpdateError")),r}})}createGiftCard(e){return l(this,null,function*(){let t=yield this.requireManager(),s=new Date().toISOString(),r=Number(e.amount||0);if(!Number.isFinite(r)||r<=0)throw new Error(this.t("bonus.service.errors.invalidGiftAmount"));let i=this.normalizeCode(e.code||this.randomCode("GIFT"));yield this.ensureCodeNotUsed("giftCards",i);let a=y(c(this.db,`${this.path}/giftCards`)),n=a.key??`${Date.now()}`,o={id:n,code:i,initialAmount:Math.round(r*100)/100,balance:Math.round(r*100)/100,note:e.note?.trim()||void 0,active:!0,redeemedBy:null,redeemedAt:null,usesCount:0,expiresAt:this.normalizeDate(e.expiresAt),createdAt:s,updatedAt:s,createdBy:t.uid};try{return yield C(a,this.stripUndef(o)),this.ui.success(this.t("bonus.service.feedback.giftCreated",{code:o.code})),this.audit.log({action:"bonus.gift.create",resource:"gift_card",resourceId:o.id,actorId:t.uid,actorRole:t.role,status:"success",meta:{code:o.code,amount:o.initialAmount}}),o}catch(d){throw this.audit.log({action:"bonus.gift.create",resource:"gift_card",resourceId:n,actorId:t.uid,actorRole:t.role,status:"error",message:String(d?.message??d)}),this.ui.error(this.t("bonus.service.feedback.giftCreateError")),d}})}setGiftCardActive(e,t){return l(this,null,function*(){let s=yield this.requireManager();try{yield w(c(this.db,`${this.path}/giftCards/${e}`),{active:t,updatedAt:new Date().toISOString()}),this.ui.info(t?this.t("bonus.service.feedback.giftEnabled"):this.t("bonus.service.feedback.giftDisabled")),this.audit.log({action:"bonus.gift.toggle",resource:"gift_card",resourceId:e,actorId:s.uid,actorRole:s.role,status:"success",meta:{active:t}})}catch(r){throw this.audit.log({action:"bonus.gift.toggle",resource:"gift_card",resourceId:e,actorId:s.uid,actorRole:s.role,status:"error",message:String(r?.message??r),meta:{active:t}}),this.ui.error(this.t("bonus.service.feedback.giftUpdateError")),r}})}applyPromoCodeForCurrentUser(e){return l(this,null,function*(){let t=yield this.requireLogged(),s=this.normalizeCode(e);if(!s)throw new Error(this.t("bonus.service.errors.enterPromoCode"));let r=yield this.findPromoByCode(s);if(!r)throw new Error(this.t("bonus.service.errors.promoNotFound"));this.assertPromoAvailable(r);let i=c(this.db,`${this.path}/redeems/${t.uid}/promo_${r.id}`);if((yield v(i)).exists())throw new Error(this.t("bonus.service.errors.promoAlreadyUsed"));let n=yield this.readWallet(t.uid),o=this.roundMoney(n.balance+r.creditAmount),d=new Date().toISOString(),g=y(c(this.db,`${this.path}/ledger/${t.uid}`)).key??`${Date.now()}`,R={[`promoCodes/${r.id}/usedCount`]:(r.usedCount||0)+1,[`promoCodes/${r.id}/updatedAt`]:d,[`redeems/${t.uid}/promo_${r.id}`]:{kind:"promo",code:r.code,amount:r.creditAmount,sourceId:r.id,at:d},[`wallets/${t.uid}`]:{userId:t.uid,balance:o,updatedAt:d},[`ledger/${t.uid}/${g}`]:{id:g,userId:t.uid,type:"promo",code:r.code,amount:r.creditAmount,sourceId:r.id,at:d,note:r.description??null}};try{return yield w(c(this.db,this.path),R),this.notifications.createForUser(t.uid,{type:"bonus",title:this.t("bonus.service.notifications.promoTitle"),message:this.t("bonus.service.notifications.promoMessage",{code:r.code,amount:r.creditAmount.toFixed(2)}),link:"/dashboard/buoni",priority:"normal",meta:{code:r.code}}),this.ui.success(this.t("bonus.service.feedback.promoApplied",{amount:r.creditAmount.toFixed(2)})),this.audit.log({action:"bonus.promo.redeem",resource:"bonus_promo",resourceId:r.id,actorId:t.uid,actorRole:t.role,status:"success",targetUserId:t.uid,meta:{code:r.code,amount:r.creditAmount,walletBalance:o}}),{code:r.code,amount:r.creditAmount,walletBalance:o}}catch(k){throw this.audit.log({action:"bonus.promo.redeem",resource:"bonus_promo",resourceId:r.id,actorId:t.uid,actorRole:t.role,status:"error",targetUserId:t.uid,message:String(k?.message??k),meta:{code:r.code}}),this.ui.error(this.t("bonus.service.feedback.promoApplyError")),k}})}redeemGiftCardForCurrentUser(e){return l(this,null,function*(){let t=yield this.requireLogged(),s=this.normalizeCode(e);if(!s)throw new Error(this.t("bonus.service.errors.enterGiftCode"));let r=yield this.findGiftCardByCode(s);if(!r)throw new Error(this.t("bonus.service.errors.giftNotFound"));this.assertGiftCardAvailable(r);let i=this.roundMoney(r.balance);if(i<=0)throw new Error(this.t("bonus.service.errors.giftAlreadyRedeemed"));let a=yield this.readWallet(t.uid),n=this.roundMoney(a.balance+i),o=new Date().toISOString(),u=y(c(this.db,`${this.path}/ledger/${t.uid}`)).key??`${Date.now()}`,g={[`giftCards/${r.id}/balance`]:0,[`giftCards/${r.id}/active`]:!1,[`giftCards/${r.id}/redeemedBy`]:t.uid,[`giftCards/${r.id}/redeemedAt`]:o,[`giftCards/${r.id}/usesCount`]:(r.usesCount||0)+1,[`giftCards/${r.id}/updatedAt`]:o,[`redeems/${t.uid}/gift_${r.id}`]:{kind:"gift_card",code:r.code,amount:i,sourceId:r.id,at:o},[`wallets/${t.uid}`]:{userId:t.uid,balance:n,updatedAt:o},[`ledger/${t.uid}/${u}`]:{id:u,userId:t.uid,type:"gift_card",code:r.code,amount:i,sourceId:r.id,at:o,note:r.note??null}};try{return yield w(c(this.db,this.path),g),this.notifications.createForUser(t.uid,{type:"bonus",title:this.t("bonus.service.notifications.giftTitle"),message:this.t("bonus.service.notifications.giftMessage",{code:r.code,amount:i.toFixed(2)}),link:"/dashboard/buoni",priority:"high",meta:{code:r.code}}),this.ui.success(this.t("bonus.service.feedback.giftRedeemed",{amount:i.toFixed(2)})),this.audit.log({action:"bonus.gift.redeem",resource:"gift_card",resourceId:r.id,actorId:t.uid,actorRole:t.role,status:"success",targetUserId:t.uid,meta:{code:r.code,amount:i,walletBalance:n}}),{code:r.code,amount:i,walletBalance:n}}catch(R){throw this.audit.log({action:"bonus.gift.redeem",resource:"gift_card",resourceId:r.id,actorId:t.uid,actorRole:t.role,status:"error",targetUserId:t.uid,message:String(R?.message??R),meta:{code:r.code}}),this.ui.error(this.t("bonus.service.feedback.giftRedeemError")),R}})}requireLogged(){return l(this,null,function*(){let e=yield this.auth.resolveCurrentUser();if(!e)throw new Error(this.t("bonus.service.errors.notAuthenticated"));return{uid:e.uid,role:e.role}})}requireManager(){return l(this,null,function*(){let e=yield this.auth.resolveCurrentUser();if(!e)throw new Error(this.t("bonus.service.errors.notAuthenticated"));if(e.role!=="admin"&&e.role!=="staff")throw new Error(this.t("bonus.service.errors.onlyManager"));return{uid:e.uid,role:e.role}})}ensureCodeNotUsed(e,t){return l(this,null,function*(){let s=P(c(this.db,`${this.path}/${e}`),x("code"),S(t));if((yield v(s)).exists())throw new Error(this.t("bonus.service.errors.codeAlreadyExists",{code:t}))})}findPromoByCode(e){return l(this,null,function*(){let t=P(c(this.db,`${this.path}/promoCodes`),x("code"),S(e)),s=yield v(t);if(!s.exists())return null;let[r,i]=Object.entries(s.val())[0];return this.toPromo(r,i)})}findGiftCardByCode(e){return l(this,null,function*(){let t=P(c(this.db,`${this.path}/giftCards`),x("code"),S(e)),s=yield v(t);if(!s.exists())return null;let[r,i]=Object.entries(s.val())[0];return this.toGiftCard(r,i)})}assertPromoAvailable(e){if(!e.active)throw new Error(this.t("bonus.service.errors.promoDisabled"));if(e.expiresAt&&e.expiresAt<new Date().toISOString())throw new Error(this.t("bonus.service.errors.promoExpired"));if(e.maxUses!==null&&e.usedCount>=e.maxUses)throw new Error(this.t("bonus.service.errors.promoExhausted"))}assertGiftCardAvailable(e){if(!e.active)throw new Error(this.t("bonus.service.errors.giftDisabled"));if(e.expiresAt&&e.expiresAt<new Date().toISOString())throw new Error(this.t("bonus.service.errors.giftExpired"))}readWallet(e){return l(this,null,function*(){let t=yield v(c(this.db,`${this.path}/wallets/${e}`));return t.exists()?this.toWallet(e,t.val()):{userId:e,balance:0,updatedAt:new Date(0).toISOString()}})}toPromo(e,t){return{id:e,code:this.normalizeCode(t.code??""),creditAmount:this.roundMoney(Number(t.creditAmount??0)),description:t.description?String(t.description):void 0,active:t.active!==!1,maxUses:t.maxUses===void 0||t.maxUses===null?null:Number(t.maxUses),usedCount:Number(t.usedCount??0),expiresAt:t.expiresAt?String(t.expiresAt):null,createdAt:String(t.createdAt??new Date(0).toISOString()),updatedAt:String(t.updatedAt??t.createdAt??new Date(0).toISOString()),createdBy:String(t.createdBy??"system")}}toGiftCard(e,t){let s=this.roundMoney(Number(t.initialAmount??t.balance??0)),r=this.roundMoney(Number(t.balance??s));return{id:e,code:this.normalizeCode(t.code??""),initialAmount:s,balance:r,note:t.note?String(t.note):void 0,active:t.active!==!1,redeemedBy:t.redeemedBy?String(t.redeemedBy):null,redeemedAt:t.redeemedAt?String(t.redeemedAt):null,usesCount:Number(t.usesCount??0),expiresAt:t.expiresAt?String(t.expiresAt):null,createdAt:String(t.createdAt??new Date(0).toISOString()),updatedAt:String(t.updatedAt??t.createdAt??new Date(0).toISOString()),createdBy:String(t.createdBy??"system")}}toWallet(e,t){return{userId:e,balance:this.roundMoney(Number(t.balance??0)),updatedAt:String(t.updatedAt??new Date(0).toISOString())}}toLedger(e,t,s){return{id:e,userId:t,type:s.type??"adjustment",code:String(s.code??""),amount:this.roundMoney(Number(s.amount??0)),sourceId:String(s.sourceId??""),at:String(s.at??new Date(0).toISOString()),note:s.note?String(s.note):void 0}}normalizeCode(e){return String(e||"").trim().toUpperCase().replace(/\s+/g,"")}normalizeDate(e){if(!e)return null;let t=new Date(e);return Number.isNaN(t.getTime())?null:t.toISOString()}randomCode(e){let t=Math.random().toString(36).slice(2,8).toUpperCase();return`${e}-${t}`}roundMoney(e){return Math.round((e+Number.EPSILON)*100)/100}stripUndef(e){let t={};for(let[s,r]of Object.entries(e))r!==void 0&&(t[s]=r);return t}t(e,t){let s=this.lang.t(e);return t?Object.entries(t).reduce((r,[i,a])=>r.replace(new RegExp(`\\{${i}\\}`,"g"),String(a)),s):s}static \u0275fac=function(t){return new(t||b)(p($),p(U),p(Q),p(E),p(j),p(H))};static \u0275prov=I({token:b,factory:b.\u0275fac,providedIn:"root"})};export{J as a,X as b,Y as c,Z as d};
