import{a as W,e as T,h as _,j as V,m as K,o as E,p as U,q as j}from"./chunk-RUQCNMPL.js";import{a as H}from"./chunk-UUPZRWMM.js";import{$ as P,S as $,V as S,W as v,Y as h,Z as x,_ as y,aa as c,ba as O,ca as C,ea as w,yc as Q}from"./chunk-E5ZACFZL.js";import{c as I,h as p}from"./chunk-ZWDWJLXC.js";import{N,k as m}from"./chunk-Y3XNR5LB.js";import{a as f,b as M,e as l}from"./chunk-ACKELEN3.js";var J=class b{constructor(t){this.db=t}path="reviews";addReview(t){let e=y(c(this.db,this.path));return C(e,M(f({},t),{id:e.key}))}deleteReview(t){return O(c(this.db,`${this.path}/${t}`))}updateReview(t,e){return w(c(this.db,`${this.path}/${t}`),e)}getAllReviews(){return new m(t=>{let e=c(this.db,this.path);h(e,s=>{let r=s.val(),i=r?Object.keys(r).map(n=>f({id:n},r[n])):[];t.next(i)})})}getRecentReviews(t=5){return new m(e=>{let s=c(this.db,this.path);h(s,r=>{let i=r.val(),n=[];i&&(n=Object.entries(i).map(([a,o])=>f({id:a},o)).sort((a,o)=>new Date(o.date).getTime()-new Date(a.date).getTime()).slice(0,t)),e.next(n)})})}getReviewById(t){return v(c(this.db,`${this.path}/${t}`)).then(e=>e.exists()?f({id:t},e.val()):null)}getReviewsByUser(t){return new m(e=>{let s=P(c(this.db,this.path),x("userId"),S(t));h(s,r=>{let i=r.val(),n=i?Object.entries(i).map(([a,o])=>f({id:a},o)):[];e.next(n)})})}getReviewsByBookingId(t){return new m(e=>{let s=P(c(this.db,this.path),x("bookingId"),S(t));h(s,r=>{let i=r.val(),n=i?Object.entries(i).map(([a,o])=>f({id:a},o)):[];e.next(n)})})}getReviewsByArtist(t){return new m(e=>{let s=c(this.db,this.path);h(s,r=>{let i=r.val(),n=i?Object.entries(i).map(([a,o])=>f({id:a},o)).filter(a=>a.artistId===t&&a.status==="approved"):[];e.next(n)})})}checkIfAlreadyReviewed(t,e){return l(this,null,function*(){let s=yield v(c(this.db,this.path));return s.exists()?Object.values(s.val()).some(i=>i.bookingId===t&&i.userId===e):!1})}static \u0275fac=function(e){return new(e||b)(p($))};static \u0275prov=I({token:b,factory:b.\u0275fac,providedIn:"root"})};var X=class b{constructor(t){this.db=t}path="invoices";getInvoices(){return new m(t=>{let e=c(this.db,this.path);h(e,s=>{let r=s.val(),i=r?Object.entries(r).map(([n,a])=>f({id:n},a)):[];t.next(i)})})}getInvoicesByClient(t){return new m(e=>{let s=P(c(this.db,this.path),x("clientId"),S(t));h(s,r=>{let i=r.val(),n=i?Object.entries(i).map(([a,o])=>f({id:a},o)):[];e.next(n)})})}getInvoiceById(t){return l(this,null,function*(){let e=yield v(c(this.db,`${this.path}/${t}`));return e.exists()?f({id:t},e.val()):null})}addInvoice(t){let e=y(c(this.db,this.path)),s=new Date().toISOString();return C(e,M(f({},t),{bookingId:e.key,createdAt:s,updatedAt:s}))}updateInvoice(t,e){return w(c(this.db,`${this.path}/${t}`),M(f({},e),{updatedAt:new Date().toISOString()}))}deleteInvoice(t){return O(c(this.db,`${this.path}/${t}`))}getTotalRevenue(){return new m(t=>{let e=c(this.db,this.path);h(e,s=>{let r=s.val(),i=0;r&&Object.values(r).forEach(n=>{n.status==="paid"&&typeof n.amount=="number"&&(i+=n.amount)}),t.next(i)})})}static \u0275fac=function(e){return new(e||b)(p($))};static \u0275prov=I({token:b,factory:b.\u0275fac,providedIn:"root"})};var Y=class b{constructor(t,e,s,r,i){this.db=t;this.firestore=e;this.notifications=s;this.audit=r;this.auth=i}conversationsPath="conversations";messagesPath="conversationMessages";userConversationsPath="userConversations";roleOf(t,e){return e.participants?.[t]}isAdminLike(t){return t==="admin"||t==="staff"}canStaffAccessConversation(t,e){return!!this.roleOf(t,e)}streamConversationsForUser(t){return t?new m(e=>{let s=c(this.db,`${this.userConversationsPath}/${t}`),r=h(s,i=>l(this,null,function*(){if(!i.exists()){e.next([]);return}let n=i.val(),a=Object.keys(n),d=(yield Promise.all(a.map(u=>l(this,null,function*(){let g=yield v(c(this.db,`${this.conversationsPath}/${u}`));return g.exists()?this.toConversation(u,g.val()):null})))).filter(u=>!!u).sort((u,g)=>(g.lastMessageAt??g.updatedAt).localeCompare(u.lastMessageAt??u.updatedAt));e.next(d)}),i=>e.error(i));return()=>r()}):new m(e=>e.next([]))}streamAllConversations(){let t=this.auth.userSig(),e=t?.uid??"",s=t?.role??"guest";return this.isAdminLike(s)?new m(r=>{let i=c(this.db,this.conversationsPath),n=h(i,a=>{if(!a.exists()){r.next([]);return}let o=a.val(),d=Object.entries(o).map(([u,g])=>this.toConversation(u,g)).sort((u,g)=>(g.lastMessageAt??g.updatedAt).localeCompare(u.lastMessageAt??u.updatedAt));s==="staff"&&(d=d.filter(u=>this.canStaffAccessConversation(e,u))),r.next(d)},a=>r.error(a));return()=>n()}):new m(r=>{r.next([]),r.complete()})}streamMessages(t){return t?new m(e=>{let s=c(this.db,`${this.messagesPath}/${t}`),r=h(s,i=>{if(!i.exists()){e.next([]);return}let n=i.val(),a=Object.entries(n).map(([o,d])=>this.toMessage(o,t,d)).sort((o,d)=>o.createdAt.localeCompare(d.createdAt));e.next(a)},i=>e.error(i));return()=>r()}):new m(e=>e.next([]))}createConversationForClient(t,e="Conversazione con studio"){return l(this,null,function*(){let s=this.auth.userSig(),r=new Date().toISOString(),i=y(c(this.db,this.conversationsPath)),n=i.key,a=yield this.getAdminLikeUsers(),o={[t]:"client"};a.forEach(u=>{o[u.id]=u.role});let d={id:n,summary:e,status:"open",createdAt:r,updatedAt:r,createdBy:s?.uid??t,participants:o,unreadBy:{}};return yield C(i,d),yield this.touchParticipants(n,Object.keys(o),r),this.audit.log({action:"messaging.conversation.create",resource:"conversation",resourceId:n,status:"success",actorId:s?.uid??t,actorRole:s?.role,targetUserId:t,meta:{participants:Object.keys(o).length}}),n})}sendMessage(t){return l(this,null,function*(){let{conversationId:e,senderId:s,senderRole:r,text:i}=t,n=t.kind??"text",a=String(i??"").trim();if(!e||!s||!a)return;let o=new Date().toISOString(),d=c(this.db,`${this.conversationsPath}/${e}`),u=yield v(d);if(!u.exists())throw new Error("Conversazione non trovata");let g=this.toConversation(e,u.val()),R=!!this.roleOf(s,g),k=r==="admin",ee=r==="staff";if(!k&&!R)throw new Error("Utente non autorizzato a scrivere in questa conversazione");if(ee&&!R)throw new Error("Staff non assegnato a questa conversazione");let B=Object.keys(g.participants??{}),D=f({},g.unreadBy??{});B.forEach(A=>{A===s?D[A]=0:D[A]=Number(D[A]??0)+1});let F=y(c(this.db,`${this.messagesPath}/${e}`)),te={id:F.key,conversationId:e,senderId:s,senderRole:r,text:a,kind:n,createdAt:o};yield C(F,te),yield w(d,{updatedAt:o,status:g.status==="closed"?"open":g.status,lastMessageAt:o,lastMessageBy:s,lastMessageText:a.slice(0,180),unreadBy:D}),yield this.touchParticipants(e,B,o);let q=B.filter(A=>A!==s);yield Promise.allSettled(q.map(A=>{let G=g.participants?.[A],re=G==="admin"||G==="staff"?"/admin/messaging":"/dashboard/chat";return this.notifications.createForUser(A,{type:"chat",title:"Nuovo messaggio",message:a.length>90?`${a.slice(0,87)}...`:a,link:re,meta:{conversationId:e,senderId:s}})})),this.audit.log({action:"messaging.message.send",resource:"conversation",resourceId:e,status:"success",actorId:s,actorRole:r,meta:{kind:n,recipients:q.length}})})}setConversationStatus(t,e,s,r){return l(this,null,function*(){let i=yield v(c(this.db,`${this.conversationsPath}/${t}`));if(!i.exists())throw new Error("Conversazione non trovata");let n=this.toConversation(t,i.val()),a=this.auth.userSig(),o=r??a?.role??"guest";if(!this.isAdminLike(o))throw new Error("Solo admin o staff possono cambiare stato conversazione");if(o==="staff"&&!this.canStaffAccessConversation(s,n))throw new Error("Staff non assegnato a questa conversazione");let d=new Date().toISOString();yield w(c(this.db,`${this.conversationsPath}/${t}`),{status:e,updatedAt:d}),yield this.touchParticipants(t,Object.keys(n.participants??{}),d),this.audit.log({action:"messaging.conversation.status",resource:"conversation",resourceId:t,status:"success",actorId:s,actorRole:r,meta:{status:e}})})}markAsRead(t,e){return l(this,null,function*(){if(!t||!e)return;let s=yield v(c(this.db,`${this.conversationsPath}/${t}`));if(!s.exists())return;let r=this.toConversation(t,s.val()),i=this.auth.userSig(),n=i?.role??"guest",a=i?.uid??e;if(!(this.isAdminLike(n)||!!this.roleOf(a,r)))throw new Error("Non autorizzato");if(!this.isAdminLike(n)&&a!==e)throw new Error("Non autorizzato");let d=new Date().toISOString();yield w(c(this.db,`${this.conversationsPath}/${t}/unreadBy`),{[e]:0}),yield C(c(this.db,`${this.userConversationsPath}/${e}/${t}`),d)})}archiveConversationForUser(t,e){return l(this,null,function*(){if(!t||!e)return;let s=yield v(c(this.db,`${this.conversationsPath}/${t}`));if(!s.exists())return;let r=this.toConversation(t,s.val()),i=this.auth.userSig(),n=i?.role??"guest",a=i?.uid??e;if(!this.isAdminLike(n)&&a!==e)throw new Error("Non autorizzato");if(!this.isAdminLike(n)&&!this.roleOf(e,r))throw new Error("Non autorizzato");if(n==="staff"&&!this.canStaffAccessConversation(a,r))throw new Error("Staff non assegnato a questa conversazione");yield O(c(this.db,`${this.userConversationsPath}/${e}/${t}`)),this.audit.log({action:"messaging.conversation.archive",resource:"conversation",resourceId:t,status:"success",actorId:i?.uid??e,actorRole:i?.role})})}touchParticipants(t,e,s){return l(this,null,function*(){yield Promise.all(e.map(r=>C(c(this.db,`${this.userConversationsPath}/${r}/${t}`),s)))})}getAdminLikeUsers(){return l(this,null,function*(){let t=T(this.firestore,"users"),e=V(t,K("role","in",["admin","staff"]));return(yield _(e)).docs.map(r=>{let i=String(r.data().role??"admin");return{id:r.id,role:i==="staff"?"staff":"admin"}})})}toConversation(t,e){return{id:t,summary:String(e?.summary??"Conversazione"),status:e?.status==="closed"?"closed":"open",createdAt:String(e?.createdAt??new Date(0).toISOString()),updatedAt:String(e?.updatedAt??e?.createdAt??new Date(0).toISOString()),createdBy:String(e?.createdBy??""),participants:e?.participants??{},lastMessageText:e?.lastMessageText?String(e.lastMessageText):void 0,lastMessageAt:e?.lastMessageAt?String(e.lastMessageAt):void 0,lastMessageBy:e?.lastMessageBy?String(e.lastMessageBy):void 0,unreadBy:e?.unreadBy??{}}}toMessage(t,e,s){return{id:t,conversationId:e,senderId:String(s?.senderId??""),senderRole:s?.senderRole??"client",text:String(s?.text??""),kind:s?.kind??"text",createdAt:String(s?.createdAt??new Date(0).toISOString())}}static \u0275fac=function(e){return new(e||b)(p($),p(W),p(j),p(E),p(U))};static \u0275prov=I({token:b,factory:b.\u0275fac,providedIn:"root"})};var Z=class b{constructor(t,e,s,r,i,n){this.db=t;this.auth=e;this.ui=s;this.audit=r;this.notifications=i;this.lang=n}path="bonus";streamPromoCodes(){return new m(t=>{let e=c(this.db,`${this.path}/promoCodes`),s=h(e,r=>{if(!r.exists()){t.next([]);return}let i=r.val(),n=Object.entries(i).map(([a,o])=>this.toPromo(a,o)).sort((a,o)=>o.createdAt.localeCompare(a.createdAt));t.next(n)},r=>t.error(r));return()=>s()})}streamGiftCards(){return new m(t=>{let e=c(this.db,`${this.path}/giftCards`),s=h(e,r=>{if(!r.exists()){t.next([]);return}let i=r.val(),n=Object.entries(i).map(([a,o])=>this.toGiftCard(a,o)).sort((a,o)=>o.createdAt.localeCompare(a.createdAt));t.next(n)},r=>t.error(r));return()=>s()})}streamWallet(t){return t?new m(e=>{let s=c(this.db,`${this.path}/wallets/${t}`),r=h(s,i=>{if(!i.exists()){e.next({userId:t,balance:0,updatedAt:new Date(0).toISOString()});return}e.next(this.toWallet(t,i.val()))},i=>e.error(i));return()=>r()}):N({userId:"",balance:0,updatedAt:new Date(0).toISOString()})}streamWalletLedger(t,e=50){return t?new m(s=>{let r=c(this.db,`${this.path}/ledger/${t}`),i=h(r,n=>{if(!n.exists()){s.next([]);return}let a=n.val(),o=Object.entries(a).map(([d,u])=>this.toLedger(d,t,u)).sort((d,u)=>u.at.localeCompare(d.at)).slice(0,e);s.next(o)},n=>s.error(n));return()=>i()}):N([])}createPromoCode(t){return l(this,null,function*(){let e=yield this.requireManager(),s=new Date().toISOString(),r=Number(t.creditAmount||0);if(!Number.isFinite(r)||r<=0)throw new Error(this.t("bonus.service.errors.invalidPromoAmount"));let i=this.normalizeCode(t.code||this.randomCode("PROMO"));yield this.ensureCodeNotUsed("promoCodes",i);let n=y(c(this.db,`${this.path}/promoCodes`)),a=n.key??`${Date.now()}`,o={id:a,code:i,creditAmount:Math.round(r*100)/100,description:t.description?.trim()||void 0,active:!0,maxUses:t.maxUses&&t.maxUses>0?Math.floor(t.maxUses):null,usedCount:0,expiresAt:this.normalizeDate(t.expiresAt),createdAt:s,updatedAt:s,createdBy:e.uid};try{return yield C(n,this.stripUndef(o)),this.ui.success(this.t("bonus.service.feedback.promoCreated",{code:o.code})),this.audit.log({action:"bonus.promo.create",resource:"bonus_promo",resourceId:o.id,actorId:e.uid,actorRole:e.role,status:"success",meta:{code:o.code,creditAmount:o.creditAmount}}),o}catch(d){throw this.audit.log({action:"bonus.promo.create",resource:"bonus_promo",resourceId:a,actorId:e.uid,actorRole:e.role,status:"error",message:String(d?.message??d)}),this.ui.error(this.t("bonus.service.feedback.promoCreateError")),d}})}setPromoActive(t,e){return l(this,null,function*(){let s=yield this.requireManager();try{yield w(c(this.db,`${this.path}/promoCodes/${t}`),{active:e,updatedAt:new Date().toISOString()}),this.ui.info(e?this.t("bonus.service.feedback.promoEnabled"):this.t("bonus.service.feedback.promoDisabled")),this.audit.log({action:"bonus.promo.toggle",resource:"bonus_promo",resourceId:t,actorId:s.uid,actorRole:s.role,status:"success",meta:{active:e}})}catch(r){throw this.audit.log({action:"bonus.promo.toggle",resource:"bonus_promo",resourceId:t,actorId:s.uid,actorRole:s.role,status:"error",message:String(r?.message??r),meta:{active:e}}),this.ui.error(this.t("bonus.service.feedback.promoUpdateError")),r}})}createGiftCard(t){return l(this,null,function*(){let e=yield this.requireManager(),s=new Date().toISOString(),r=Number(t.amount||0);if(!Number.isFinite(r)||r<=0)throw new Error(this.t("bonus.service.errors.invalidGiftAmount"));let i=this.normalizeCode(t.code||this.randomCode("GIFT"));yield this.ensureCodeNotUsed("giftCards",i);let n=y(c(this.db,`${this.path}/giftCards`)),a=n.key??`${Date.now()}`,o={id:a,code:i,initialAmount:Math.round(r*100)/100,balance:Math.round(r*100)/100,note:t.note?.trim()||void 0,active:!0,redeemedBy:null,redeemedAt:null,usesCount:0,expiresAt:this.normalizeDate(t.expiresAt),createdAt:s,updatedAt:s,createdBy:e.uid};try{return yield C(n,this.stripUndef(o)),this.ui.success(this.t("bonus.service.feedback.giftCreated",{code:o.code})),this.audit.log({action:"bonus.gift.create",resource:"gift_card",resourceId:o.id,actorId:e.uid,actorRole:e.role,status:"success",meta:{code:o.code,amount:o.initialAmount}}),o}catch(d){throw this.audit.log({action:"bonus.gift.create",resource:"gift_card",resourceId:a,actorId:e.uid,actorRole:e.role,status:"error",message:String(d?.message??d)}),this.ui.error(this.t("bonus.service.feedback.giftCreateError")),d}})}setGiftCardActive(t,e){return l(this,null,function*(){let s=yield this.requireManager();try{yield w(c(this.db,`${this.path}/giftCards/${t}`),{active:e,updatedAt:new Date().toISOString()}),this.ui.info(e?this.t("bonus.service.feedback.giftEnabled"):this.t("bonus.service.feedback.giftDisabled")),this.audit.log({action:"bonus.gift.toggle",resource:"gift_card",resourceId:t,actorId:s.uid,actorRole:s.role,status:"success",meta:{active:e}})}catch(r){throw this.audit.log({action:"bonus.gift.toggle",resource:"gift_card",resourceId:t,actorId:s.uid,actorRole:s.role,status:"error",message:String(r?.message??r),meta:{active:e}}),this.ui.error(this.t("bonus.service.feedback.giftUpdateError")),r}})}applyPromoCodeForCurrentUser(t){return l(this,null,function*(){let e=yield this.requireLogged(),s=this.normalizeCode(t);if(!s)throw new Error(this.t("bonus.service.errors.enterPromoCode"));let r=yield this.findPromoByCode(s);if(!r)throw new Error(this.t("bonus.service.errors.promoNotFound"));this.assertPromoAvailable(r);let i=c(this.db,`${this.path}/redeems/${e.uid}/promo_${r.id}`);if((yield v(i)).exists())throw new Error(this.t("bonus.service.errors.promoAlreadyUsed"));let a=yield this.readWallet(e.uid),o=this.roundMoney(a.balance+r.creditAmount),d=new Date().toISOString(),g=y(c(this.db,`${this.path}/ledger/${e.uid}`)).key??`${Date.now()}`,R={[`promoCodes/${r.id}/usedCount`]:(r.usedCount||0)+1,[`promoCodes/${r.id}/updatedAt`]:d,[`redeems/${e.uid}/promo_${r.id}`]:{kind:"promo",code:r.code,amount:r.creditAmount,sourceId:r.id,at:d},[`wallets/${e.uid}`]:{userId:e.uid,balance:o,updatedAt:d},[`ledger/${e.uid}/${g}`]:{id:g,userId:e.uid,type:"promo",code:r.code,amount:r.creditAmount,sourceId:r.id,at:d,note:r.description??null}};try{return yield w(c(this.db,this.path),R),this.notifications.createForUser(e.uid,{type:"bonus",title:this.t("bonus.service.notifications.promoTitle"),message:this.t("bonus.service.notifications.promoMessage",{code:r.code,amount:r.creditAmount.toFixed(2)}),link:"/dashboard/buoni",priority:"normal",meta:{code:r.code}}),this.ui.success(this.t("bonus.service.feedback.promoApplied",{amount:r.creditAmount.toFixed(2)})),this.audit.log({action:"bonus.promo.redeem",resource:"bonus_promo",resourceId:r.id,actorId:e.uid,actorRole:e.role,status:"success",targetUserId:e.uid,meta:{code:r.code,amount:r.creditAmount,walletBalance:o}}),{code:r.code,amount:r.creditAmount,walletBalance:o}}catch(k){throw this.audit.log({action:"bonus.promo.redeem",resource:"bonus_promo",resourceId:r.id,actorId:e.uid,actorRole:e.role,status:"error",targetUserId:e.uid,message:String(k?.message??k),meta:{code:r.code}}),this.ui.error(this.t("bonus.service.feedback.promoApplyError")),k}})}redeemGiftCardForCurrentUser(t){return l(this,null,function*(){let e=yield this.requireLogged(),s=this.normalizeCode(t);if(!s)throw new Error(this.t("bonus.service.errors.enterGiftCode"));let r=yield this.findGiftCardByCode(s);if(!r)throw new Error(this.t("bonus.service.errors.giftNotFound"));this.assertGiftCardAvailable(r);let i=this.roundMoney(r.balance);if(i<=0)throw new Error(this.t("bonus.service.errors.giftAlreadyRedeemed"));let n=yield this.readWallet(e.uid),a=this.roundMoney(n.balance+i),o=new Date().toISOString(),u=y(c(this.db,`${this.path}/ledger/${e.uid}`)).key??`${Date.now()}`,g={[`giftCards/${r.id}/balance`]:0,[`giftCards/${r.id}/active`]:!1,[`giftCards/${r.id}/redeemedBy`]:e.uid,[`giftCards/${r.id}/redeemedAt`]:o,[`giftCards/${r.id}/usesCount`]:(r.usesCount||0)+1,[`giftCards/${r.id}/updatedAt`]:o,[`redeems/${e.uid}/gift_${r.id}`]:{kind:"gift_card",code:r.code,amount:i,sourceId:r.id,at:o},[`wallets/${e.uid}`]:{userId:e.uid,balance:a,updatedAt:o},[`ledger/${e.uid}/${u}`]:{id:u,userId:e.uid,type:"gift_card",code:r.code,amount:i,sourceId:r.id,at:o,note:r.note??null}};try{return yield w(c(this.db,this.path),g),this.notifications.createForUser(e.uid,{type:"bonus",title:this.t("bonus.service.notifications.giftTitle"),message:this.t("bonus.service.notifications.giftMessage",{code:r.code,amount:i.toFixed(2)}),link:"/dashboard/buoni",priority:"high",meta:{code:r.code}}),this.ui.success(this.t("bonus.service.feedback.giftRedeemed",{amount:i.toFixed(2)})),this.audit.log({action:"bonus.gift.redeem",resource:"gift_card",resourceId:r.id,actorId:e.uid,actorRole:e.role,status:"success",targetUserId:e.uid,meta:{code:r.code,amount:i,walletBalance:a}}),{code:r.code,amount:i,walletBalance:a}}catch(R){throw this.audit.log({action:"bonus.gift.redeem",resource:"gift_card",resourceId:r.id,actorId:e.uid,actorRole:e.role,status:"error",targetUserId:e.uid,message:String(R?.message??R),meta:{code:r.code}}),this.ui.error(this.t("bonus.service.feedback.giftRedeemError")),R}})}requireLogged(){return l(this,null,function*(){let t=yield this.auth.resolveCurrentUser();if(!t)throw new Error(this.t("bonus.service.errors.notAuthenticated"));return{uid:t.uid,role:t.role}})}requireManager(){return l(this,null,function*(){let t=yield this.auth.resolveCurrentUser();if(!t)throw new Error(this.t("bonus.service.errors.notAuthenticated"));if(t.role!=="admin"&&t.role!=="staff")throw new Error(this.t("bonus.service.errors.onlyManager"));return{uid:t.uid,role:t.role}})}ensureCodeNotUsed(t,e){return l(this,null,function*(){let s=P(c(this.db,`${this.path}/${t}`),x("code"),S(e));if((yield v(s)).exists())throw new Error(this.t("bonus.service.errors.codeAlreadyExists",{code:e}))})}findPromoByCode(t){return l(this,null,function*(){let e=P(c(this.db,`${this.path}/promoCodes`),x("code"),S(t)),s=yield v(e);if(!s.exists())return null;let[r,i]=Object.entries(s.val())[0];return this.toPromo(r,i)})}findGiftCardByCode(t){return l(this,null,function*(){let e=P(c(this.db,`${this.path}/giftCards`),x("code"),S(t)),s=yield v(e);if(!s.exists())return null;let[r,i]=Object.entries(s.val())[0];return this.toGiftCard(r,i)})}assertPromoAvailable(t){if(!t.active)throw new Error(this.t("bonus.service.errors.promoDisabled"));if(t.expiresAt&&t.expiresAt<new Date().toISOString())throw new Error(this.t("bonus.service.errors.promoExpired"));if(t.maxUses!==null&&t.usedCount>=t.maxUses)throw new Error(this.t("bonus.service.errors.promoExhausted"))}assertGiftCardAvailable(t){if(!t.active)throw new Error(this.t("bonus.service.errors.giftDisabled"));if(t.expiresAt&&t.expiresAt<new Date().toISOString())throw new Error(this.t("bonus.service.errors.giftExpired"))}readWallet(t){return l(this,null,function*(){let e=yield v(c(this.db,`${this.path}/wallets/${t}`));return e.exists()?this.toWallet(t,e.val()):{userId:t,balance:0,updatedAt:new Date(0).toISOString()}})}toPromo(t,e){return{id:t,code:this.normalizeCode(e.code??""),creditAmount:this.roundMoney(Number(e.creditAmount??0)),description:e.description?String(e.description):void 0,active:e.active!==!1,maxUses:e.maxUses===void 0||e.maxUses===null?null:Number(e.maxUses),usedCount:Number(e.usedCount??0),expiresAt:e.expiresAt?String(e.expiresAt):null,createdAt:String(e.createdAt??new Date(0).toISOString()),updatedAt:String(e.updatedAt??e.createdAt??new Date(0).toISOString()),createdBy:String(e.createdBy??"system")}}toGiftCard(t,e){let s=this.roundMoney(Number(e.initialAmount??e.balance??0)),r=this.roundMoney(Number(e.balance??s));return{id:t,code:this.normalizeCode(e.code??""),initialAmount:s,balance:r,note:e.note?String(e.note):void 0,active:e.active!==!1,redeemedBy:e.redeemedBy?String(e.redeemedBy):null,redeemedAt:e.redeemedAt?String(e.redeemedAt):null,usesCount:Number(e.usesCount??0),expiresAt:e.expiresAt?String(e.expiresAt):null,createdAt:String(e.createdAt??new Date(0).toISOString()),updatedAt:String(e.updatedAt??e.createdAt??new Date(0).toISOString()),createdBy:String(e.createdBy??"system")}}toWallet(t,e){return{userId:t,balance:this.roundMoney(Number(e.balance??0)),updatedAt:String(e.updatedAt??new Date(0).toISOString())}}toLedger(t,e,s){return{id:t,userId:e,type:s.type??"adjustment",code:String(s.code??""),amount:this.roundMoney(Number(s.amount??0)),sourceId:String(s.sourceId??""),at:String(s.at??new Date(0).toISOString()),note:s.note?String(s.note):void 0}}normalizeCode(t){return String(t||"").trim().toUpperCase().replace(/\s+/g,"")}normalizeDate(t){if(!t)return null;let e=new Date(t);return Number.isNaN(e.getTime())?null:e.toISOString()}randomCode(t){let e=Math.random().toString(36).slice(2,8).toUpperCase();return`${t}-${e}`}roundMoney(t){return Math.round((t+Number.EPSILON)*100)/100}stripUndef(t){let e={};for(let[s,r]of Object.entries(t))r!==void 0&&(e[s]=r);return e}t(t,e){let s=this.lang.t(t);return e?Object.entries(e).reduce((r,[i,n])=>r.replace(new RegExp(`\\{${i}\\}`,"g"),String(n)),s):s}static \u0275fac=function(e){return new(e||b)(p($),p(U),p(Q),p(E),p(j),p(H))};static \u0275prov=I({token:b,factory:b.\u0275fac,providedIn:"root"})};export{J as a,X as b,Y as c,Z as d};
