<section class="drawer">
  <!-- HEADER -->
  <header class="drawer__header">
    <div class="title">
      <mat-icon>event</mat-icon>
      <span>{{ mode === 'edit' ? 'Modifica evento' : 'Nuovo evento' }}</span>
    </div>

    <button mat-icon-button type="button" (click)="close.emit()">
      <mat-icon>close</mat-icon>
    </button>
  </header>

  <!-- FORM -->
  <form class="drawer__form" [formGroup]="form" (ngSubmit)="onSubmit()">
    <!-- TYPE -->
    <mat-form-field appearance="outline">
      <mat-label>Tipo</mat-label>
      <mat-select formControlName="type">
        <mat-option value="booking">Booking (consulenza)</mat-option>
        <mat-option value="session">Session (seduta)</mat-option>
      </mat-select>

      <mat-hint *ngIf="isBooking()">
        Booking = appuntamento di consulenza (cliente obbligatorio).
      </mat-hint>
      <mat-hint *ngIf="isSession()">
        Session = seduta (di norma collegata a un progetto).
      </mat-hint>
    </mat-form-field>

    <!-- ARTIST -->
    <mat-form-field appearance="outline">
      <mat-label>Artista *</mat-label>
      <mat-select formControlName="artistId">
        <mat-option
          *ngIf="shouldShowSelectedArtistFallback()"
          [value]="form.controls.artistId.value">
          {{ form.controls.artistId.value }}
        </mat-option>
        <mat-option *ngFor="let a of artists" [value]="a.id" [disabled]="a.isActive === false || a.calendarEnabled === false">
          {{ a.name }}
        </mat-option>
      </mat-select>
      <mat-error *ngIf="form.controls.artistId.touched && form.controls.artistId.hasError('required')">
        Seleziona un artista
      </mat-error>
    </mat-form-field>

    <!-- DATE + TIME -->
    <div class="row2">
      <mat-form-field appearance="outline">
        <mat-label>Data *</mat-label>
        <input matInput [matDatepicker]="picker" formControlName="day" />
        <mat-datepicker-toggle matSuffix [for]="picker"></mat-datepicker-toggle>
        <mat-datepicker #picker></mat-datepicker>
        <mat-error *ngIf="form.controls.day.touched && form.controls.day.hasError('required')">
          Data obbligatoria
        </mat-error>
      </mat-form-field>

    <mat-form-field appearance="outline">
      <mat-label>Ora *</mat-label>
      <mat-select formControlName="time">
        <mat-option *ngFor="let t of availableTimeOptions" [value]="t">{{ t }}</mat-option>
      </mat-select>
      <mat-error *ngIf="form.controls.time.touched && form.controls.time.hasError('required')">
        Ora obbligatoria
      </mat-error>
    </mat-form-field>
    </div>

    <!-- DURATION -->
    <mat-form-field appearance="outline">
      <mat-label>Durata (min) *</mat-label>
      <mat-select formControlName="durationMinutes">
        <mat-option *ngFor="let d of durationOptions" [value]="d">{{ d }}</mat-option>
      </mat-select>
      <mat-error *ngIf="form.controls.durationMinutes.touched && form.controls.durationMinutes.hasError('min')">
        Minimo 15 minuti
      </mat-error>
    </mat-form-field>

    <!-- STATUS -->
    <mat-form-field appearance="outline">
      <mat-label>Status</mat-label>

      <!-- booking statuses -->
      <mat-select formControlName="status" *ngIf="isBooking()">
        <mat-option *ngFor="let s of bookingStatusOptions" [value]="s.value">{{ s.label }}</mat-option>
      </mat-select>

      <!-- session statuses -->
      <mat-select formControlName="status" *ngIf="isSession()">
        <mat-option *ngFor="let s of sessionStatusOptions" [value]="s.value">{{ s.label }}</mat-option>
      </mat-select>
    </mat-form-field>

    <mat-hint *ngIf="mode==='edit' && isBookingAssignmentLocked()" class="session-lock-hint">
      Campi bloccati: modifica consentita solo sulle note e sullo stato.
    </mat-hint>

    <!-- CLIENT (autocomplete) -->
    <mat-form-field appearance="outline">
      <mat-label>Cliente {{ isBooking() ? '*' : '' }}</mat-label>

      <input
        matInput
        type="text"
        formControlName="clientQuery"
        [matAutocomplete]="clientAuto"
        placeholder="Scrivi nome / email / telefono"
        (blur)="onClientBlur()"
      />

      <button
        mat-icon-button
        matSuffix
        type="button"
        *ngIf="form.controls.clientId.value"
        (click)="clearClient()"
        aria-label="Pulisci cliente">
        <mat-icon>close</mat-icon>
      </button>

      <mat-autocomplete
        #clientAuto="matAutocomplete"
        [displayWith]="displayClient"
        (optionSelected)="onClientSelected($event.option.value)">

        <mat-option *ngFor="let c of (filteredClients$ | async)" [value]="c">
          <div class="opt">
            <strong>{{ c.fullName }}</strong>
            <small>{{ c.email || c.phone || c.id }}</small>
          </div>
        </mat-option>

      </mat-autocomplete>

      <mat-hint *ngIf="isBooking()">
        Obbligatorio per booking.
      </mat-hint>

      <mat-error *ngIf="form.controls.clientQuery.touched && form.controls.clientQuery.hasError('required')">
        Seleziona un cliente
      </mat-error>
    </mat-form-field>

    <!-- PROJECT (autocomplete) -->
    <mat-form-field appearance="outline">
      <mat-label>{{ isSession() ? 'Progetto *' : 'Progetto (opzionale)' }}</mat-label>

        <input
          matInput
          type="text"
          formControlName="projectQuery"
          [matAutocomplete]="projectAuto"
          placeholder="Scrivi titolo progetto"
          (blur)="onProjectBlur()"
        />

      <button
        mat-icon-button
        matSuffix
        type="button"
        *ngIf="form.controls.projectId.value"
        (click)="clearProject()"
        [disabled]="isAssignmentLocked() || isBookingAssignmentLocked()"
        aria-label="Pulisci progetto">
        <mat-icon>close</mat-icon>
      </button>

      <mat-autocomplete
        #projectAuto="matAutocomplete"
        [displayWith]="displayProject"
        (optionSelected)="onProjectSelected($event.option.value)">

        <mat-option *ngFor="let p of (filteredProjects$ | async)" [value]="p">
          <div class="opt">
            <strong>{{ p.title }}</strong>
            <small>{{ (p.sessionIds?.length || 0) }} sessioni</small>
          </div>
        </mat-option>

        <mat-divider></mat-divider>
        <mat-option (click)="createProjectFromDrawer()" [disabled]="isAssignmentLocked() || isBookingAssignmentLocked()">
          <mat-icon>add_circle</mat-icon>
          <span>Crea nuovo progetto</span>
        </mat-option>

      </mat-autocomplete>

      <mat-hint *ngIf="isSession()">
        Selezionando un progetto, il numero sessione viene calcolato automaticamente.
      </mat-hint>
      <mat-hint *ngIf="isBooking()">
        Per creare un nuovo progetto servono prima Cliente e Artista.
      </mat-hint>

      <mat-error *ngIf="isSession() && form.controls.projectQuery.touched && form.controls.projectQuery.hasError('required')">
        Seleziona un progetto
      </mat-error>
    </mat-form-field>

    <!-- BOOKING (autocomplete - session only) -->
    <mat-form-field appearance="outline" *ngIf="isSession()">
      <mat-label>Booking di riferimento (opzionale)</mat-label>

        <input
          matInput
          type="text"
          formControlName="bookingQuery"
          [matAutocomplete]="bookingAuto"
          placeholder="Cerca booking"
          (blur)="onBookingBlur()"
        />

      <button
        mat-icon-button
        matSuffix
        type="button"
        *ngIf="form.controls.bookingId.value"
        (click)="clearBooking()"
        [disabled]="isAssignmentLocked() || isBookingAssignmentLocked()"
        aria-label="Pulisci booking">
        <mat-icon>close</mat-icon>
      </button>

      <mat-autocomplete
        #bookingAuto="matAutocomplete"
        [displayWith]="displayBooking"
        (optionSelected)="onBookingSelected($event.option.value)">

        <mat-option *ngFor="let b of (filteredBookings$ | async)" [value]="b">
          <div class="opt">
            <strong>{{ displayBooking(b) }}</strong>
            <small>{{ b.projectId ? 'Con progetto' : 'Senza progetto' }}</small>
          </div>
        </mat-option>

      </mat-autocomplete>

      <mat-hint>
        Se selezioni un booking, compiliamo automaticamente artista, cliente e progetto.
      </mat-hint>
    </mat-form-field>

    <!-- ZONE -->
    <mat-form-field appearance="outline">
      <mat-label>Zona</mat-label>
      <input matInput formControlName="zone" placeholder="Es. avambraccio dx" />
    </mat-form-field>

    <!-- SESSION EXTRA -->
    <ng-container *ngIf="isSession()">
      <mat-hint *ngIf="mode==='edit' && isScheduleLocked()" class="session-lock-hint">
        Data/ora bloccate perché la sessione è completata.
      </mat-hint>
      <div class="row2">
        <mat-form-field appearance="outline">
          <mat-label>N° Sessione</mat-label>
          <input matInput type="number" formControlName="sessionNumber" />
          <mat-hint>Auto: in base al progetto selezionato</mat-hint>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Dolore (1-10)</mat-label>
          <input matInput type="number" min="1" max="10" formControlName="painLevel" />
        </mat-form-field>
      </div>

      <mat-form-field appearance="outline">
        <mat-label>Pagato (sessione)</mat-label>
        <input matInput type="number" min="0" formControlName="paidAmount" />
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>Note Admin</mat-label>
        <textarea matInput rows="2" formControlName="notesByAdmin"></textarea>
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>Note guarigione</mat-label>
        <textarea matInput rows="2" formControlName="healingNotes"></textarea>
      </mat-form-field>
    </ng-container>

    <!-- NOTES -->
    <mat-form-field appearance="outline">
      <mat-label>Note</mat-label>
      <textarea matInput rows="3" formControlName="notes"></textarea>
    </mat-form-field>

    <!-- FOOTER -->
    <footer class="drawer__footer">
      <button mat-stroked-button type="button" (click)="close.emit()">Annulla</button>
      <button mat-raised-button color="primary" type="submit">Salva</button>
    </footer>
  </form>
</section>
