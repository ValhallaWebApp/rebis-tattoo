<section class="billing-management">
  <!-- HEADER -->
  <div class="section-title">
    <div class="title-left">
      <mat-icon>request_quote</mat-icon>
      <span>Gestione Fatture</span>
    </div>
  </div>

  <!-- FILTRI STATO -->
  <div class="filters-row">
    <mat-button-toggle-group
      [(ngModel)]="selectedStatus"
      (ngModelChange)="onStatusChange()"
      aria-label="Scegli stato fatture"
    >
      <mat-button-toggle value="all">Tutte</mat-button-toggle>
      <mat-button-toggle value="pending">In sospeso</mat-button-toggle>
      <mat-button-toggle value="paid">Completate</mat-button-toggle>
      <mat-button-toggle value="cancelled">Annullate</mat-button-toggle>
    </mat-button-toggle-group>
  </div>

  <!-- LISTA FATTURE -->
  <div class="payments-grid">
    <mat-card
      class="payment-card"
      *ngFor="let payment of filteredPayments"
      [class.paid]="payment.status === 'paid'"
      [class.pending]="payment.status === 'pending'"
      [class.cancelled]="payment.status === 'cancelled'"
    >
      <!-- HEADER CARD -->
      <div class="payment-header">
        <div class="client-block">
          <h3>{{ payment.clientName }}</h3>
          <p class="date">
            {{ payment.date | date: 'mediumDate' }}
          </p>
        </div>

        <div class="amount-block">
          <span class="amount-label">Importo</span>
          <span class="amount">â‚¬{{ payment.amount }}</span>
        </div>
      </div>

      <!-- BODY -->
      <div class="payment-body">
        <div class="meta-row">
          <mat-chip
            class="status-chip"
            [color]="getStatusColor(payment.status)"
            selected
          >
            {{ payment.status | titlecase }}
          </mat-chip>

          <span class="booking-ref" *ngIf="payment.bookingId">
            <mat-icon>event</mat-icon>
            #{{ payment.bookingId }}
          </span>
        </div>

        <p class="notes">
          <span>Note:&nbsp;</span>
          {{ payment.notes || 'Nessuna nota' }}
        </p>
      </div>

      <!-- AZIONI -->
      <div class="payment-actions">
        <button
          mat-icon-button
          matTooltip="Vai alla prenotazione"
          (click)="goToBooking(payment.bookingId)"
        >
          <mat-icon>event</mat-icon>
        </button>

        <button
          mat-icon-button
          color="accent"
          matTooltip="Segna come pagata"
          *ngIf="payment.status !== 'paid'"
          (click)="markAsPaid(payment)"
        >
          <mat-icon>check_circle</mat-icon>
        </button>

        <button
          mat-icon-button
          color="warn"
          matTooltip="Elimina fattura"
          (click)="deleteInvoice(payment.id!)"
        >
          <mat-icon>delete</mat-icon>
        </button>
      </div>
    </mat-card>

    <p class="empty" *ngIf="filteredPayments.length === 0">
      Nessuna fattura trovata per lo stato selezionato.
    </p>
  </div>
</section>
