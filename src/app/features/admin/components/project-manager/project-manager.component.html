<section class="pm">
  <header class="pm__header">
    <div class="pm__title">
      <mat-icon>workspaces</mat-icon>
      <div>
        <h2>Project Manager</h2>
        <p>Gestisci progetti, booking collegate, sessioni, pagamenti e fatture</p>
      </div>
    </div>

    <div class="pm__tools" [formGroup]="form">
      <mat-form-field appearance="outline" class="search">
        <mat-label>Cerca</mat-label>
        <input matInput formControlName="q" placeholder="Titolo, id, cliente, email, zona..." />
        <button
          mat-icon-button
          matSuffix
          type="button"
          *ngIf="form.controls.q.value"
          (click)="form.controls.q.setValue('')">
          <mat-icon>close</mat-icon>
        </button>
      </mat-form-field>

      <mat-slide-toggle formControlName="onlyNotClosed">
        Solo non conclusi
      </mat-slide-toggle>
    </div>
  </header>

  <nav class="pm__tabs" *ngIf="(vm$ | async) as vm">
    <button
      *ngFor="let t of tabs"
      type="button"
      class="tab"
      [class.active]="form.controls.tab.value === t.key"
      (click)="setTab(t.key)">
      <mat-icon>{{ t.icon }}</mat-icon>
      <span>{{ t.label }}</span>
      <span class="pill">{{ vm.counts[t.key] }}</span>
    </button>
  </nav>

  <main class="pm__list" *ngIf="(vm$ | async) as vm">
    <div class="empty" *ngIf="!vm.list.length">
      <mat-icon>search_off</mat-icon>
      <div>
        <h3>Nessun progetto</h3>
        <p>Prova a cambiare filtro o ricerca.</p>
      </div>
    </div>

    <article class="card" *ngFor="let row of vm.list; trackBy: trackByProjectId">
      <!-- HEAD -->
      <div class="card__head">
        <div class="h-left">
          <div class="title">
            <h3>{{ row.project.title }}</h3>
            <span class="status" [attr.data-status]="row.project.status">
              {{ statusLabel(row.project.status) }}
            </span>
          </div>

          <div class="meta">
            <span><mat-icon>fingerprint</mat-icon> {{ row.project.id || '—' }}</span>
            <span><mat-icon>brush</mat-icon> {{ row.project.artistId || '—' }}</span>
          </div>

          <div class="meta">
            <span><mat-icon>person</mat-icon> {{ row.clientLabel }}</span>
            <span class="muted" *ngIf="row.client?.email">· {{ row.client?.email }}</span>
            <span class="muted" *ngIf="row.client?.phone">· {{ row.client?.phone }}</span>
          </div>

          <div class="meta">
            <span><mat-icon>place</mat-icon> {{ zoneLabel(row.project) }}</span>
            <span><mat-icon>update</mat-icon> {{ row.project.updatedAt || '—' }}</span>
          </div>
        </div>

        <div class="h-right">
          <div class="kpis">
            <div class="kpi">
              <span>Booking</span>
              <strong>{{ row.hasBooking ? 'OK' : 'NO' }}</strong>
            </div>
            <div class="kpi">
              <span>Sessioni</span>
              <strong>{{ row.sessionsCount }}</strong>
            </div>
            <div class="kpi">
              <span>Pagato</span>
              <strong>{{ money(row.paidTotal) }}</strong>
            </div>
            <div class="kpi" *ngIf="row.expectedTotal != null">
              <span>Residuo</span>
              <strong [class.warn]="(row.remaining ?? 0) > 0">{{ money(row.remaining) }}</strong>
            </div>
          </div>

          <div class="actions">
            <a mat-stroked-button [routerLink]="openProject(row.project)">
              <mat-icon>open_in_new</mat-icon>
              Scheda
            </a>

            <button mat-stroked-button type="button" (click)="messageClient(row)" [disabled]="!row.client?.phone && !row.client?.email">
              <mat-icon>chat</mat-icon>
              Messaggia
            </button>

            <button
              mat-stroked-button
              type="button"
              [disabled]="row.isClosed || row.hasBooking"
              (click)="createBookingForProject(row.project)">
              <mat-icon>event</mat-icon>
              Crea Booking
            </button>

            <button
              mat-raised-button
              color="primary"
              type="button"
              [disabled]="!row.canAddSession"
              (click)="addSessionToProject(row.project)">
              <mat-icon>add</mat-icon>
              Aggiungi Session
            </button>
          </div>

          <div class="hint" *ngIf="row.isClosed">
            <mat-icon>lock</mat-icon>
            Progetto chiuso
          </div>
        </div>
      </div>

      <!-- BODY -->
      <div class="card__body">
        <!-- BOOKING -->
        <section class="box">
          <header class="box__head">
            <div class="box__title">
              <mat-icon>event</mat-icon>
              <span>Booking</span>
            </div>

            <button
              mat-button
              type="button"
              *ngIf="row.booking"
              (click)="editBooking(row.booking!)">
              <mat-icon>edit</mat-icon>
              Modifica
            </button>
          </header>

          <div class="box__content" *ngIf="row.booking; else noBooking">
            <div class="line">
              <span class="k">Quando</span>
              <span class="v">{{ bookingWhenLabel(row.booking) }}</span>
            </div>

            <div class="line">
              <span class="k">Status</span>
              <span class="v">{{ row.booking?.status || '—' }}</span>
            </div>

            <div class="line" *ngIf="row.booking?.projectId">
              <span class="k">ProjectId</span>
              <span class="v">{{ row.booking?.projectId }}</span>
            </div>

            <div class="moneygrid">
              <div class="m" *ngIf="row.booking?.depositRequired != null">
                <span>Acconto richiesto</span>
                <strong>{{ money(row.booking?.depositRequired) }}</strong>
              </div>

              <div class="m" *ngIf="row.booking?.paidAmount != null">
                <span>Pagato (booking)</span>
                <strong>{{ money(row.booking?.paidAmount) }}</strong>
              </div>

              <div class="m" *ngIf="row.booking?.price != null">
                <span>Prezzo (booking)</span>
                <strong>{{ money(row.booking?.price) }}</strong>
              </div>
            </div>
          </div>

          <ng-template #noBooking>
            <div class="empty-mini">
              <mat-icon>event_busy</mat-icon>
              <div>
                <strong>Nessuna booking collegata</strong>
                <div class="muted">Puoi crearla quando vuoi.</div>
              </div>
            </div>
          </ng-template>
        </section>

        <!-- SESSIONS -->
        <section class="box">
          <header class="box__head">
            <div class="box__title">
              <mat-icon>calendar_month</mat-icon>
              <span>Sessioni</span>
            </div>

            <button mat-button type="button" (click)="downloadFullInvoice(row)" [disabled]="!row.sessions.length && !row.booking">
              <mat-icon>download</mat-icon>
              Fattura completa
            </button>
          </header>

          <div class="box__content" *ngIf="row.sessions.length; else noSessions">
            <div class="sessions">
              <div class="srow" *ngFor="let s of row.sessions">
                <div class="sleft">
                  <div class="when">
                    <mat-icon>schedule</mat-icon>
                    <span>{{ s._start }}</span>
                    <span class="arrow" *ngIf="s._end">→</span>
                    <span *ngIf="s._end">{{ s._end }}</span>
                  </div>

                  <div class="mini">
                    <span class="tag">{{ s.status }}</span>
                    <span class="dot">·</span>
                    <span *ngIf="s._durationMin">{{ s._durationMin }} min</span>
                    <span *ngIf="s.zone"> · {{ s.zone }}</span>
                  </div>
                </div>

                <div class="sright">
                  <div class="m">
                    <span>Prezzo</span>
                    <strong>{{ money(s.price) }}</strong>
                  </div>
                  <div class="m" *ngIf="s.paidAmount != null">
                    <span>Pagato</span>
                    <strong>{{ money(s.paidAmount) }}</strong>
                  </div>

                  <button mat-icon-button type="button" (click)="downloadSessionInvoice(row, s)" aria-label="fattura sessione">
                    <mat-icon>receipt_long</mat-icon>
                  </button>

                  <button mat-icon-button type="button" (click)="editSession(s)" aria-label="modifica sessione">
                    <mat-icon>edit</mat-icon>
                  </button>
                </div>
              </div>
            </div>
          </div>

          <ng-template #noSessions>
            <div class="empty-mini">
              <mat-icon>playlist_add</mat-icon>
              <div>
                <strong>Nessuna sessione</strong>
                <div class="muted">Aggiungine una dal pulsante in alto.</div>
              </div>
            </div>
          </ng-template>
        </section>

        <!-- PAYMENTS + INVOICES -->
        <section class="box">
          <header class="box__head">
            <div class="box__title">
              <mat-icon>payments</mat-icon>
              <span>Pagamenti & Fatture</span>
            </div>
          </header>

          <div class="box__content">
            <div class="moneygrid">
              <div class="m">
                <span>Pagato (Stripe/Payments)</span>
                <strong>{{ money(row.paidTotal) }}</strong>
              </div>
              <div class="m" *ngIf="row.expectedTotal != null">
                <span>Totale stimato</span>
                <strong>{{ money(row.expectedTotal) }}</strong>
              </div>
              <div class="m" *ngIf="row.remaining != null">
                <span>Residuo</span>
                <strong [class.warn]="row.remaining > 0">{{ money(row.remaining) }}</strong>
              </div>
              <div class="m" *ngIf="row.invoices.length">
                <span>Totale fatture (RTDB)</span>
                <strong>{{ money(row.invoiceTotal) }}</strong>
              </div>
            </div>

            <div class="list-mini" *ngIf="row.payments.length; else noPayments">
              <div class="prow" *ngFor="let p of row.payments">
                <div class="p-left">
                  <div class="p-top">
                    <strong>{{ money(p.amount) }}</strong>
                    <span class="tag" [class.ok]="(p.status||'').toLowerCase()==='succeeded'">
                      {{ p.status || '—' }}
                    </span>
                  </div>
                  <div class="muted">
                    {{ p.createdAt || '' }}
                    <span *ngIf="p.bookingId"> · booking: {{ p.bookingId }}</span>
                  </div>
                </div>
              </div>
            </div>

            <ng-template #noPayments>
              <div class="empty-mini">
                <mat-icon>receipt_long</mat-icon>
                <div>
                  <strong>Nessun pagamento</strong>
                  <div class="muted">Compariranno qui dal nodo payments.</div>
                </div>
              </div>
            </ng-template>

            <div class="list-mini" *ngIf="row.invoices.length">
              <div class="prow inv" *ngFor="let inv of row.invoices">
                <div class="p-left">
                  <div class="p-top">
                    <strong>{{ money(inv.amount) }}</strong>
                    <span class="tag" [class.ok]="inv.status==='paid'">{{ inv.status }}</span>
                  </div>
                  <div class="muted">
                    {{ inv.date }}
                    <span *ngIf="inv.bookingId"> · booking: {{ inv.bookingId }}</span>
                  </div>
                </div>
              </div>
            </div>

          </div>
        </section>
      </div>
    </article>
  </main>
</section>
