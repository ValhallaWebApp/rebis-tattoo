<section class="user-management">
  <h2 class="section-title">
    <mat-icon>groups</mat-icon> Gestione Utenti
  </h2>

  <!-- ðŸ” Filtri -->
  <form [formGroup]="filterForm" class="filters">
    <mat-form-field>
      <mat-label>Nome</mat-label>
      <input matInput formControlName="name" placeholder="Mario Rossi" />
    </mat-form-field>

    <mat-form-field>
      <mat-label>Email</mat-label>
      <input matInput formControlName="email" placeholder="mario@email.com" />
    </mat-form-field>

    <mat-form-field>
      <mat-label>Ruolo</mat-label>
      <mat-select formControlName="role">
        <mat-option value="">Tutti</mat-option>
        <mat-option *ngFor="let r of roles" [value]="r">{{ r }}</mat-option>
      </mat-select>
    </mat-form-field>
  </form>

  <!-- ðŸ‘¥ Lista utenti -->
  <div class="user-cards">
    <mat-card *ngFor="let u of filteredUsers" class="user-card">
      <div class="user-info">
        <img [src]="getAvatarUrl(u)" (error)="onAvatarError($event)" alt="avatar" />
        <div>
          <h3>{{ u.name }}</h3>
          <p>{{ u.email }}</p>
          <div class="role-editor">
            <span class="role">{{ displayRole(u) }}</span>
            <span class="role active-flag" [class.off]="u.isActive === false">
              {{ u.isActive === false ? 'inactive' : 'active' }}
            </span>
            <mat-form-field *ngIf="canChangeRole(u)" appearance="outline" class="role-select">
              <mat-label>Grado</mat-label>
              <mat-select
                [value]="displayRole(u)"
                [disabled]="isRoleUpdating(u.id) || isStatusUpdating(u.id) || isRolePermissionUpdating(u.id)"
                (selectionChange)="changeUserRole(u, $event.value)"
              >
                <mat-option *ngFor="let option of roleOptionsFor(u)" [value]="option">
                  {{ option }}
                </mat-option>
              </mat-select>
            </mat-form-field>
            <mat-slide-toggle
              *ngIf="canGrantRolePermissionToggle(u)"
              class="role-permission-toggle"
              [checked]="hasRoleManagementPermission(u)"
              [disabled]="isRolePermissionUpdating(u.id) || isStatusUpdating(u.id) || isRoleUpdating(u.id)"
              (change)="toggleRolePermission(u, $event.checked)"
            >
              Gestione ruoli
            </mat-slide-toggle>
          </div>
        </div>
      </div>
      <div class="user-actions">
        <button
          mat-icon-button
          [matTooltip]="u.isActive === false ? 'Attiva account' : 'Disattiva account'"
          [disabled]="isSelf(u) || isStatusUpdating(u.id)"
          (click)="toggleUserActive(u)"
        >
          <mat-icon>{{ u.isActive === false ? 'toggle_off' : 'toggle_on' }}</mat-icon>
        </button>
        <button
          mat-icon-button
          color="warn"
          matTooltip="Nascondi utente"
          [disabled]="isSelf(u) || isStatusUpdating(u.id)"
          (click)="hideUser(u)"
        >
          <mat-icon>visibility_off</mat-icon>
        </button>
        <button mat-icon-button color="primary" matTooltip="Visualizza appuntamenti" (click)="viewAppointments(u)">
          <mat-icon>event</mat-icon>
        </button>
        <button mat-icon-button matTooltip="Contatta utente" (click)="contactUser(u)">
          <mat-icon>chat</mat-icon>
        </button>
        <button mat-icon-button matTooltip="Modifica profilo" (click)="editUser(u)">
          <mat-icon>edit</mat-icon>
        </button>
      </div>
    </mat-card>
  </div>
</section>
