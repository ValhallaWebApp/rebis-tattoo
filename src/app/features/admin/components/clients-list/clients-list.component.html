<section class="user-management">
  <h2 class="section-title">
    <mat-icon>groups</mat-icon> Gestione Clienti
  </h2>

  <!-- ðŸ” Filtri -->
  <form [formGroup]="filterForm" class="filters">
    <mat-form-field>
      <mat-label>Nome</mat-label>
      <input matInput formControlName="name" placeholder="Mario Rossi" />
    </mat-form-field>

    <mat-form-field>
      <mat-label>Email</mat-label>
      <input matInput formControlName="email" placeholder="mario@email.com" />
    </mat-form-field>

      <mat-form-field>
        <mat-label>Ruolo</mat-label>
        <mat-select formControlName="role">
          <mat-option value="">Tutti</mat-option>
          <mat-option *ngFor="let r of roles" [value]="r">{{ r }}</mat-option>
      </mat-select>
    </mat-form-field>
  </form>

  <!-- ðŸ‘¥ Lista utenti -->
  <div class="pager-row" *ngIf="filteredUsers.length > 0">
    <mat-form-field appearance="outline" class="page-size-field">
      <mat-label>Per pagina</mat-label>
      <mat-select [value]="pageSize" (selectionChange)="onPageSizeChange($event.value)">
        <mat-option *ngFor="let s of pageSizeOptions" [value]="s">{{ s }}</mat-option>
      </mat-select>
    </mat-form-field>

    <div class="pager-actions">
      <button mat-stroked-button type="button" (click)="previousPage()" [disabled]="currentPage <= 1">
        Prev
      </button>
      <span class="page-indicator">{{ currentPage }} / {{ totalPages }}</span>
      <button mat-stroked-button type="button" (click)="nextPage()" [disabled]="currentPage >= totalPages">
        Next
      </button>
    </div>
  </div>

  <div class="user-cards">
    <mat-card *ngFor="let u of pagedUsers" class="user-card">
      <div class="user-info">
        <img [src]="getAvatarUrl(u)" (error)="onAvatarError($event)" alt="avatar" />
        <div>
          <h3>{{ u.name }}</h3>
          <p>{{ u.email }}</p>
          <div class="role-editor">
            <span class="role">{{ displayRole(u) }}</span>
            <span class="role active-flag" [class.off]="u.isActive === false">
              {{ u.isActive === false ? 'inactive' : 'active' }}
            </span>
          </div>
        </div>
      </div>
      <div class="user-actions">
        <button
          mat-icon-button
          [matTooltip]="u.isActive === false ? 'Attiva account' : 'Disattiva account'"
          [disabled]="isSelf(u) || isStatusUpdating(u.id)"
          (click)="toggleUserActive(u)"
          [color]="u.isActive === false ? 'primary' : 'warn'"
        >
          <mat-icon>{{ u.isActive === false ? 'person' : 'person_off' }}</mat-icon>
        </button>
        <button mat-icon-button matTooltip="Modifica profilo" *ngIf="userService.isCurrentUserAdmin()" (click)="editUser(u)">
          <mat-icon>edit</mat-icon>
        </button>
      </div>
    </mat-card>
  </div>

  <p class="empty-state" *ngIf="filteredUsers.length === 0">
    Nessun cliente trovato con i filtri correnti.
  </p>
</section>
