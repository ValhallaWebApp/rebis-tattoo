<section class="audit-page">
  <mat-card class="toolbar">
    <mat-card-title>Audit Logs</mat-card-title>

    <form [formGroup]="filterForm" class="filters">
      <mat-form-field appearance="outline">
        <mat-label>Azione</mat-label>
        <input matInput formControlName="action" placeholder="booking.update" />
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>Actor ID</mat-label>
        <input matInput formControlName="actorId" placeholder="uid..." />
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>Stato</mat-label>
        <mat-select formControlName="status">
          <mat-option value="">Tutti</mat-option>
          <mat-option value="success">success</mat-option>
          <mat-option value="error">error</mat-option>
        </mat-select>
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>Da</mat-label>
        <input matInput type="date" formControlName="from" />
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>A</mat-label>
        <input matInput type="date" formControlName="to" />
      </mat-form-field>
    </form>

    <div class="actions">
      <button mat-stroked-button (click)="resetFilters()">Reset filtri</button>
      <button mat-flat-button color="primary" (click)="exportCsv()">Esporta CSV</button>
    </div>
  </mat-card>

  <mat-card class="table-card">
    <div class="table-header">
      <strong>Risultati: {{ filteredLogs.length }}</strong>
    </div>

    <div class="table-wrap" *ngIf="!loading; else loadingTpl">
      <table mat-table [dataSource]="filteredLogs">
        <ng-container matColumnDef="at">
          <th mat-header-cell *matHeaderCellDef>Quando</th>
          <td mat-cell *matCellDef="let row">{{ row.at | date:'short' }}</td>
        </ng-container>

        <ng-container matColumnDef="action">
          <th mat-header-cell *matHeaderCellDef>Azione</th>
          <td mat-cell *matCellDef="let row">{{ row.action }}</td>
        </ng-container>

        <ng-container matColumnDef="status">
          <th mat-header-cell *matHeaderCellDef>Stato</th>
          <td mat-cell *matCellDef="let row">
            <span class="status" [class.err]="row.status === 'error'">{{ row.status }}</span>
          </td>
        </ng-container>

        <ng-container matColumnDef="actor">
          <th mat-header-cell *matHeaderCellDef>Actor</th>
          <td mat-cell *matCellDef="let row">
            <div>{{ row.actorId || '-' }}</div>
            <small>{{ row.actorRole || '' }}</small>
          </td>
        </ng-container>

        <ng-container matColumnDef="resource">
          <th mat-header-cell *matHeaderCellDef>Risorsa</th>
          <td mat-cell *matCellDef="let row">
            <div>{{ row.resource }}</div>
            <small>{{ row.resourceId || '' }}</small>
          </td>
        </ng-container>

        <ng-container matColumnDef="target">
          <th mat-header-cell *matHeaderCellDef>Target</th>
          <td mat-cell *matCellDef="let row">{{ row.targetUserId || '-' }}</td>
        </ng-container>

        <ng-container matColumnDef="message">
          <th mat-header-cell *matHeaderCellDef>Messaggio</th>
          <td mat-cell *matCellDef="let row">{{ row.message || '-' }}</td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>
      </table>
    </div>
  </mat-card>
</section>

<ng-template #loadingTpl>
  <div class="loading">
    <mat-progress-spinner mode="indeterminate" diameter="34"></mat-progress-spinner>
  </div>
</ng-template>
