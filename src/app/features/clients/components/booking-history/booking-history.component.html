<section class="booking-history">
  <h2 class="section-title">
    <mat-icon>event</mat-icon> Le tue Prenotazioni
  </h2>

  <!-- üìÖ Prossima prenotazione -->
  <div *ngIf="nextBooking" class="highlight-card">
    <img [src]="artistPhotoMap[nextBooking.idArtist]" alt="Avatar" class="artist-photo" />
    <div class="details">
      <h3>{{ nextBooking.title }}</h3>
      <p><mat-icon inline>calendar_today</mat-icon> {{ nextBooking.start | date:'fullDate' }} ‚Äì {{ nextBooking.start | date:'shortTime' }}</p>
      <p><mat-icon inline>person</mat-icon> {{ artistMap[nextBooking.idArtist] || 'Artista sconosciuto' }}</p>
    </div>
    <div class="actions">
      <button mat-icon-button matTooltip="Modifica">
        <mat-icon>edit</mat-icon>
      </button>
        <button mat-icon-button matTooltip="Elimina">
        <mat-icon>delete</mat-icon>
      </button>
      <button mat-icon-button matTooltip="Fattura" (click)="downloadInvoice(nextBooking)">
        <mat-icon>receipt</mat-icon>
      </button>
      <button mat-icon-button matTooltip="Chat WhatsApp" (click)="openWhatsApp(nextBooking)">
        <mat-icon>chat</mat-icon>
      </button>
    </div>
  </div>

  <!-- üìã Tab -->
  <div class="tab-toggle">
    <button mat-button [class.active]="selectedView === 'late'" (click)="selectedView = 'late'">Ritardi</button>
    <button mat-button [class.active]="selectedView === 'completed'" (click)="selectedView = 'completed'">Completate</button>
    <button mat-button [class.active]="selectedView === 'cancelled'" (click)="selectedView = 'cancelled'">Annullate</button>
  </div>
<!-- üîç Filtri -->
<div class="filters">
  <!-- <mat-form-field appearance="fill">
    <mat-label>Artista</mat-label>
    <mat-select [(ngModel)]="filters.artist">
      <mat-option value="">Tutti</mat-option>
      <mat-option *ngFor="let a of artistOptions" [value]="a.id">{{ a.name }}</mat-option>
    </mat-select>
  </mat-form-field> -->

  <mat-form-field appearance="fill">
    <mat-label>Fascia oraria</mat-label>
    <mat-select [(ngModel)]="filters.timeSlot">
      <mat-option value="">Tutte</mat-option>
      <mat-option value="morning">Mattina</mat-option>
      <mat-option value="afternoon">Pomeriggio</mat-option>
      <mat-option value="evening">Sera</mat-option>
    </mat-select>
  </mat-form-field>

  <mat-form-field appearance="fill">
    <mat-label>Periodo</mat-label>
    <mat-select [(ngModel)]="filters.period">
      <mat-option value="">Tutti</mat-option>
      <mat-option value="30">Ultimi 30 giorni</mat-option>
      <mat-option value="90">Ultimi 3 mesi</mat-option>
    </mat-select>
  </mat-form-field>

  <mat-form-field class="search-field" >
    <mat-label>üîç Cerca</mat-label>
    <input matInput [(ngModel)]="filters.keyword" placeholder="Titolo o descrizione" />
  </mat-form-field>
</div>

  <!-- üìú Lista prenotazioni -->
  <div class="booking-list" [@slideFade]>
    <ng-container [ngSwitch]="selectedView">

      <!-- Ritardi -->
      <ng-container *ngSwitchCase="'late'">
        <p class="empty" *ngIf="pastUncompleted.length === 0">Nessun ritardo</p>
        <mat-card *ngFor="let b of filteredLateBookings" class="booking-card late">
          <div class="info">
            <strong>{{ b.title }}</strong>
            <p>{{ b.start | date:'short' }} ‚Äì {{ artistMap[b.idArtist] }}</p>
          </div>
          <mat-chip color="warn" selected>In ritardo</mat-chip>
        </mat-card>
      </ng-container>

      <!-- Completate -->
      <ng-container *ngSwitchCase="'completed'">
        <p class="empty" *ngIf="completedBookings.length === 0">Nessuna completata</p>
        <mat-card *ngFor="let b of filteredCompletedBookings" class="booking-card completed">
          <div class="info">
            <strong>{{ b.title }}</strong>
            <p>{{ b.start | date:'short' }} ‚Äì {{ artistMap[b.idArtist] }}</p>
          </div>
          <div class="actions">
            <button mat-icon-button matTooltip="Fattura" (click)="downloadInvoice(b)">
              <mat-icon>receipt_long</mat-icon>
            </button>
            <button *ngIf="!reviewMap[b.id]" mat-icon-button color="accent" matTooltip="Lascia recensione" (click)="openReviewDialog(b)">
              <mat-icon>rate_review</mat-icon>
            </button>
            <button *ngIf="reviewMap[b.id]" mat-icon-button color="primary" matTooltip="Vedi recensione" (click)="viewReview(reviewMap[b.id])">
              <mat-icon>visibility</mat-icon>
            </button>
          </div>
        </mat-card>
      </ng-container>

      <!-- Annullate -->
      <ng-container *ngSwitchCase="'cancelled'">
        <p class="empty" *ngIf="cancelledBookings.length === 0">Nessuna annullata</p>
        <mat-card *ngFor="let b of filteredCancelledBookings" class="booking-card cancelled">
          <div class="info">
            <strong>{{ b.title }}</strong>
            <p>{{ b.start | date:'short' }} ‚Äì {{ artistMap[b.idArtist] }}</p>
          </div>
        </mat-card>
      </ng-container>

    </ng-container>
  </div>
</section>
