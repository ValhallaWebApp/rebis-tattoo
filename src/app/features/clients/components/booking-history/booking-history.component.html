<section class="booking-history">
  <header class="page-head">
    <h2 class="section-title">
      <mat-icon>event</mat-icon>
      Le tue Prenotazioni
    </h2>

    <div class="page-actions">
      <button mat-stroked-button class="soft-btn" (click)="selectedView = 'active'">
        <mat-icon>schedule</mat-icon> Attive
      </button>
      <button mat-stroked-button class="soft-btn" (click)="selectedView = 'history'">
        <mat-icon>history</mat-icon> Storico
      </button>
      <button mat-stroked-button class="soft-btn" (click)="selectedView = 'cancelled'">
        <mat-icon>event_busy</mat-icon> Annullate
      </button>
    </div>
  </header>

  <div class="layout">
    <!-- MAIN -->
    <main class="main">
      <!-- HERO: prossimo -->
      <section class="hero" *ngIf="nextBooking">
        <div class="hero-label">
          <mat-icon>star</mat-icon> Prossimo appuntamento
        </div>

        <mat-card class="booking-card featured active">
          <div class="card-left">
            <img class="artist-photo" [src]="artistPhotoMap[nextBooking.artistId]" alt="Avatar artista" />
          </div>

          <div class="card-body">
            <div class="card-top">
              <div class="title-wrap">
                <h3 class="title" title="{{ getBookingLabel(nextBooking) }}">
                  {{ getBookingLabel(nextBooking) }}
                </h3>

                <div class="sub">
                  <span class="row">
                    <mat-icon inline>calendar_today</mat-icon>
                    {{ nextBooking.start | date:'fullDate' }} - {{ nextBooking.start | date:'shortTime' }}
                  </span>
                  <span class="row">
                    <mat-icon inline>person</mat-icon>
                    {{ artistMap[nextBooking.artistId] || 'Artista' }}
                  </span>
                </div>
              </div>

              <span class="status-pill" [ngClass]="getStatusClass(nextBooking.status)">
                {{ getStatusLabel(nextBooking.status) }}
              </span>
            </div>

            <div class="meta">
              <span class="meta-item" *ngIf="getDurationMinutes(nextBooking) as mins">
                <mat-icon inline>timelapse</mat-icon> {{ mins }} min
              </span>

              <span class="meta-item" *ngIf="getDeposit(nextBooking) as dep">
                <mat-icon inline>payments</mat-icon> Caparra EUR {{ dep }}
              </span>

              <span class="meta-item" *ngIf="nextBooking.type">
                <mat-icon inline>sell</mat-icon> {{ nextBooking.type }}
              </span>
            </div>

            <div class="card-actions">
              <button mat-flat-button class="primary" [matMenuTriggerFor]="supportMenuHero">
                <mat-icon>support_agent</mat-icon> Assistenza
              </button>

              <button mat-icon-button class="more" [matMenuTriggerFor]="moreMenuHero" matTooltip="Azioni">
                <mat-icon>more_vert</mat-icon>
              </button>

              <mat-menu #supportMenuHero="matMenu">
                <button mat-menu-item (click)="openWhatsApp(nextBooking)">
                  <mat-icon>chat</mat-icon><span>WhatsApp</span>
                </button>
                <button mat-menu-item (click)="openTicket(nextBooking)">
                  <mat-icon>confirmation_number</mat-icon><span>Apri ticket</span>
                </button>
                <button mat-menu-item (click)="openAftercare()">
                  <mat-icon>healing</mat-icon><span>Guida post-trattamento</span>
                </button>
              </mat-menu>

              <mat-menu #moreMenuHero="matMenu">
                <button mat-menu-item (click)="openDetails(nextBooking)">
                  <mat-icon>info</mat-icon><span>Dettagli</span>
                </button>
                <button mat-menu-item (click)="downloadInvoice(nextBooking)">
                  <mat-icon>receipt_long</mat-icon><span>Scarica fattura</span>
                </button>
                <button mat-menu-item (click)="addToCalendar(nextBooking)">
                  <mat-icon>event_available</mat-icon><span>Aggiungi a calendario</span>
                </button>
                <button mat-menu-item (click)="requestReschedule(nextBooking)">
                  <mat-icon>edit_calendar</mat-icon><span>Richiedi cambio orario</span>
                </button>
                <button mat-menu-item class="danger" (click)="cancelRequest(nextBooking)">
                  <mat-icon>event_busy</mat-icon><span>Richiedi annullamento</span>
                </button>
              </mat-menu>
            </div>
          </div>
        </mat-card>
      </section>

      <!-- tabs -->
      <nav class="tabs">
        <button class="tab" [class.active]="selectedView === 'active'" (click)="selectedView = 'active'">
          Attive <span class="count">{{ activeBookings.length }}</span>
        </button>

        <button class="tab" [class.active]="selectedView === 'history'" (click)="selectedView = 'history'">
          Storico <span class="count">{{ historyBookings.length }}</span>
        </button>

        <button class="tab" [class.active]="selectedView === 'cancelled'" (click)="selectedView = 'cancelled'">
          Annullate <span class="count">{{ cancelledBookings.length }}</span>
        </button>
      </nav>

      <!-- list -->
      <section class="list" [@slideFade]>
        <ng-container [ngSwitch]="selectedView">

          <!-- ACTIVE -->
          <ng-container *ngSwitchCase="'active'">
            <p class="empty" *ngIf="activeBookings.length === 0">Nessuna prenotazione attiva.</p>

            <mat-card *ngFor="let b of activeBookings" class="booking-card active">
              <div class="card-left">
                <img class="artist-photo" [src]="artistPhotoMap[b.artistId]" alt="Avatar artista" />
              </div>

              <div class="card-body">
                <div class="card-top">
                  <div class="title-wrap">
                    <h3 class="title" title="{{ getBookingLabel(b) }}">{{ getBookingLabel(b) }}</h3>
                    <div class="sub">
                      <span class="row">
                        <mat-icon inline>schedule</mat-icon> {{ b.start | date:'short' }}
                      </span>
                      <span class="row">
                        <mat-icon inline>person</mat-icon> {{ artistMap[b.artistId] || 'Artista' }}
                      </span>
                    </div>
                  </div>

                  <span class="status-pill" [ngClass]="getStatusClass(b.status)">
                    {{ getStatusLabel(b.status) }}
                  </span>
                </div>

                <div class="meta">
                  <span class="meta-item" *ngIf="getDurationMinutes(b) as mins">
                    <mat-icon inline>timelapse</mat-icon> {{ mins }} min
                  </span>
                  <span class="meta-item" *ngIf="getDeposit(b) as dep">
                    <mat-icon inline>payments</mat-icon> Caparra EUR {{ dep }}
                  </span>
                </div>

                <div class="card-actions">
                  <button mat-stroked-button class="assist" [matMenuTriggerFor]="supportMenu">
                    <mat-icon>support_agent</mat-icon> Assistenza
                  </button>

                  <button mat-icon-button class="more" [matMenuTriggerFor]="moreMenu" matTooltip="Azioni">
                    <mat-icon>more_vert</mat-icon>
                  </button>

                  <mat-menu #supportMenu="matMenu">
                    <button mat-menu-item (click)="openWhatsApp(b)">
                      <mat-icon>chat</mat-icon><span>WhatsApp</span>
                    </button>
                    <button mat-menu-item (click)="openTicket(b)">
                      <mat-icon>confirmation_number</mat-icon><span>Apri ticket</span>
                    </button>
                    <button mat-menu-item (click)="openAftercare()">
                      <mat-icon>healing</mat-icon><span>Guida post-trattamento</span>
                    </button>
                  </mat-menu>

                  <mat-menu #moreMenu="matMenu">
                    <button mat-menu-item (click)="openDetails(b)">
                      <mat-icon>info</mat-icon><span>Dettagli</span>
                    </button>
                    <button mat-menu-item (click)="downloadInvoice(b)">
                      <mat-icon>receipt_long</mat-icon><span>Scarica fattura</span>
                    </button>
                    <button mat-menu-item (click)="addToCalendar(b)">
                      <mat-icon>event_available</mat-icon><span>Aggiungi a calendario</span>
                    </button>
                    <button mat-menu-item (click)="requestReschedule(b)">
                      <mat-icon>edit_calendar</mat-icon><span>Richiedi cambio orario</span>
                    </button>
                    <button mat-menu-item class="danger" (click)="cancelRequest(b)">
                      <mat-icon>event_busy</mat-icon><span>Richiedi annullamento</span>
                    </button>
                  </mat-menu>
                </div>
              </div>
            </mat-card>
          </ng-container>

          <!-- HISTORY -->
          <ng-container *ngSwitchCase="'history'">
            <p class="empty" *ngIf="historyBookings.length === 0">Nessuna prenotazione nello storico.</p>

            <mat-card *ngFor="let b of historyBookings" class="booking-card completed">
              <div class="card-left">
                <img class="artist-photo" [src]="artistPhotoMap[b.artistId]" alt="Avatar artista" />
              </div>

              <div class="card-body">
                <div class="card-top">
                  <div class="title-wrap">
                    <h3 class="title" title="{{ getBookingLabel(b) }}">{{ getBookingLabel(b) }}</h3>
                    <div class="sub">
                      <span class="row">
                        <mat-icon inline>history</mat-icon> {{ b.start | date:'short' }}
                      </span>
                      <span class="row">
                        <mat-icon inline>person</mat-icon> {{ artistMap[b.artistId] || 'Artista' }}
                      </span>
                    </div>
                  </div>

                  <span class="status-pill" [ngClass]="getStatusClass(b.status)">
                    {{ getStatusLabel(b.status) }}
                  </span>
                </div>

                <div class="card-actions">
                  <button mat-stroked-button class="ghost" (click)="openDetails(b)">
                    <mat-icon>info</mat-icon> Dettagli
                  </button>

                  <button mat-stroked-button class="ghost" (click)="downloadInvoice(b)">
                    <mat-icon>receipt_long</mat-icon> Fattura
                  </button>

                  <button mat-stroked-button class="ghost" (click)="rebook(b)">
                    <mat-icon>autorenew</mat-icon> Riprenota
                  </button>

                  <!-- opzionale: recensione -->
                  <button *ngIf="!reviewMap[b.id]" mat-stroked-button class="ghost" (click)="openReviewDialog(b)">
                    <mat-icon>rate_review</mat-icon> Recensione
                  </button>

                  <button *ngIf="reviewMap[b.id]" mat-stroked-button class="ghost" (click)="viewReview(reviewMap[b.id])">
                    <mat-icon>visibility</mat-icon> Vedi
                  </button>
                </div>
              </div>
            </mat-card>
          </ng-container>

          <!-- CANCELLED -->
          <ng-container *ngSwitchCase="'cancelled'">
            <p class="empty" *ngIf="cancelledBookings.length === 0">Nessuna prenotazione annullata.</p>

            <mat-card *ngFor="let b of cancelledBookings" class="booking-card cancelled">
              <div class="card-left">
                <img class="artist-photo" [src]="artistPhotoMap[b.artistId]" alt="Avatar artista" />
              </div>

              <div class="card-body">
                <div class="card-top">
                  <div class="title-wrap">
                    <h3 class="title" title="{{ getBookingLabel(b) }}">{{ getBookingLabel(b) }}</h3>
                    <div class="sub">
                      <span class="row">
                        <mat-icon inline>event_busy</mat-icon> {{ b.start | date:'short' }}
                      </span>
                      <span class="row">
                        <mat-icon inline>person</mat-icon> {{ artistMap[b.artistId] || 'Artista' }}
                      </span>
                    </div>
                  </div>

                  <span class="status-pill cancelled">Annullata</span>
                </div>

                <div class="card-actions">
                  <button mat-stroked-button class="assist" [matMenuTriggerFor]="supportMenuC">
                    <mat-icon>support_agent</mat-icon> Assistenza
                  </button>

                  <button mat-stroked-button class="ghost" (click)="rebook(b)">
                    <mat-icon>autorenew</mat-icon> Riprenota
                  </button>

                  <mat-menu #supportMenuC="matMenu">
                    <button mat-menu-item (click)="openWhatsApp(b)">
                      <mat-icon>chat</mat-icon><span>WhatsApp</span>
                    </button>
                    <button mat-menu-item (click)="openTicket(b)">
                      <mat-icon>confirmation_number</mat-icon><span>Apri ticket</span>
                    </button>
                  </mat-menu>
                </div>
              </div>
            </mat-card>
          </ng-container>

        </ng-container>
      </section>
    </main>

    <!-- SIDEBAR desktop -->
    <aside class="side">
      <mat-card class="side-card">
        <div class="side-title">
          <mat-icon>help</mat-icon> Hai bisogno di aiuto?
        </div>

        <p class="side-text">
          Per dubbi su appuntamento, preparazione o post-trattamento, scrivici in chat.
        </p>

        <div class="side-actions">
          <button mat-flat-button class="primary wide" (click)="openAftercare()">
            <mat-icon>healing</mat-icon> Guida post-trattamento
          </button>

          <button mat-stroked-button class="ghost wide" (click)="goToSupport()">
            <mat-icon>support_agent</mat-icon> Apri assistenza
          </button>
        </div>
      </mat-card>

      <mat-card class="side-card" *ngIf="nextBooking">
        <div class="side-title">
          <mat-icon>notifications</mat-icon> Promemoria
        </div>
        <ul class="side-list">
          <li>Arriva 10 minuti prima.</li>
          <li>Scrivici se vuoi chiarire dettagli sul disegno.</li>
          <li>Consulta la guida post-trattamento se Ã¨ una seduta.</li>
        </ul>
      </mat-card>
    </aside>
  </div>
</section>
