<section class="reviews">
  <h2 class="section-title">
    <mat-icon>reviews</mat-icon> Le Tue Recensioni
  </h2>

  <!-- ðŸ”„ Filtra per stato -->
  <mat-form-field appearance="fill">
    <mat-label>Stato</mat-label>
    <mat-select [formControl]="filterStatusCtrl">
      <mat-option value="all">Tutti</mat-option>
      <mat-option value="pending">In attesa</mat-option>
      <mat-option value="approved">Approvati</mat-option>
      <mat-option value="rejected">Rifiutati</mat-option>
    </mat-select>
  </mat-form-field>

  <!-- ðŸ“œ Lista recensioni -->
  <div class="reviews-list" *ngIf="filteredReviews().length > 0; else noReviews">
    <mat-card *ngFor="let r of filteredReviews()" class="review-card">
      <div class="header">
        <img [src]="getArtistPhotoById(r.artistId)" alt="Artista" class="avatar" />
        <div>
          <strong>{{ getArtistNameById(r.artistId) }}</strong>
          <p>{{ r.date | date: 'mediumDate' }}</p>
        </div>
        <span class="badge" [ngClass]="r.status">{{ r.status }}</span>
      </div>

      <div class="rating">
        <mat-icon *ngFor="let star of [1,2,3,4,5]">
          {{ star <= r.rating ? 'star' : 'star_border' }}
        </mat-icon>
      </div>

      <p class="comment">{{ r.comment }}</p>

      <div class="actions">
        <button mat-icon-button (click)="viewReview(r)" matTooltip="Visualizza">
          <mat-icon>visibility</mat-icon>
        </button>
        <button *ngIf="canEditReview(r)" mat-icon-button (click)="editReview(r)" matTooltip="Modifica">
          <mat-icon>edit</mat-icon>
        </button>
        <button mat-icon-button color="warn" (click)="deleteReview(r.id)" matTooltip="Elimina">
          <mat-icon>delete</mat-icon>
        </button>
      </div>
    </mat-card>
  </div>

  <ng-template #noReviews>
    <p class="empty">Non hai ancora lasciato recensioni.</p>
  </ng-template>
</section>

<mat-drawer-container>
  <mat-drawer #reviewDrawer mode="over" position="end">
    <form [formGroup]="reviewForm" (ngSubmit)="submitReview()">
      <h3>{{ selectedReview ? 'Modifica Recensione' : 'Nuova Recensione' }}</h3>

      <mat-form-field appearance="fill">
        <mat-label>Artista</mat-label>
        <input matInput [formControl]="artistCtrl" [matAutocomplete]="auto" />
        <mat-autocomplete #auto="matAutocomplete" (optionSelected)="selectArtist($event.option.value)">
          <mat-option *ngFor="let artist of filteredArtists | async" [value]="artist">
            {{ artist.name }}
          </mat-option>
        </mat-autocomplete>
      </mat-form-field>

      <mat-form-field appearance="fill">
        <mat-label>Commento</mat-label>
        <textarea matInput formControlName="comment" rows="4"></textarea>
      </mat-form-field>

      <mat-form-field appearance="fill">
        <mat-label>Valutazione</mat-label>
        <mat-select formControlName="rating">
          <mat-option *ngFor="let r of [1,2,3,4,5]" [value]="r">{{ r }} stelle</mat-option>
        </mat-select>
      </mat-form-field>

      <button mat-flat-button color="primary" type="submit" [disabled]="reviewForm.invalid">Salva</button>
      <button mat-button type="button" (click)="reviewDrawer.close()">Annulla</button>
    </form>
  </mat-drawer>
</mat-drawer-container>
